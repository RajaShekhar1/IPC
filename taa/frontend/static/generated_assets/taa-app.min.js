var AddToCensusViewModel=function AddToCensusViewModel(case_id){var self=this;self.case_id=ko.observable(case_id);self.matched_employees=ko.observableArray([]);self.matched_employees.error=ko.observable("");self.selected_employee=ko.observable(null);self.matched_employee=ko.computed(function(){if(self.matched_employees().length==0){return null;}
return self.matched_employees()[0];});self.loading_message=ko.observable("Loading...");self.ssn=ko.observable(null);self.ssn.error=ko.observable("");self.PANEL_FORM="find_employee";self.PANEL_LOADING="loading";self.PANEL_NOMATCH="no_matches";self.PANEL_ONEMATCH="one_match";self.PANEL_MANYMATCHES="matches";self.current_panel=ko.observable(self.PANEL_FORM);self.show_modal=function(){self.current_panel(self.PANEL_FORM);self.ssn("");self.ssn.error("");self.selected_employee(null);};self.is_match_form_showing=ko.computed(function(){return(self.current_panel()==self.PANEL_NOMATCH||self.current_panel()==self.PANEL_MANYMATCHES||self.current_panel()==self.PANEL_ONEMATCH);});self.add_form_showing=ko.computed(function(){return self.current_panel()==self.PANEL_FORM;});self.is_loading=ko.computed(function(){return self.current_panel()==self.PANEL_LOADING;});self.no_matches_found=ko.computed(function(){return self.current_panel()==self.PANEL_NOMATCH;});self.multiple_matches_found=ko.computed(function(){return self.current_panel()==self.PANEL_MANYMATCHES;});self.one_match_found=ko.computed(function(){return self.current_panel()==self.PANEL_ONEMATCH;});self.one_or_more_matches_found=ko.computed(function(){return self.multiple_matches_found()||self.one_match_found();});self.find_matches=function(){self.ssn.error("");if(!self.is_valid_ssn()){self.ssn.error("A valid SSN is required");return;}
self.loading_message("Checking census for matches...");self.current_panel(self.PANEL_LOADING);$.get("/cases/"+self.case_id()+"/census_records",{filter_ssn:self.ssn()}).success(function(resp){if(resp.data.length>0){self.matched_employees(_.map(resp.data,function(e){return new EmployeeMatchViewModel(e)}));if(resp.data.length==1){self.current_panel(self.PANEL_ONEMATCH);}else{self.current_panel(self.PANEL_MANYMATCHES);}}else{self.matched_employees([]);self.current_panel(self.PANEL_NOMATCH);}}).error(function(resp){console.error(resp);});};self.is_valid_ssn=ko.computed(function(){var ssn_regex=/^\d\d\d-\d\d-\d\d\d\d$/;return ssn_regex.test(self.ssn());});self.add_to_census=function(){self.enroll_without_record();};self.enroll_from_match=function(){if(self.matched_employees().length==1){self.enroll_from_record(self.matched_employees()[0].id);}else{var id=self.selected_employee();if(id===null){self.matched_employees.error("Please select the census record to enroll.");return;}
self.enroll_from_record(id);}};self.enroll_from_record=function(id){self._submit_enrollment({record_id:id});};self.enroll_without_record=function(){self._submit_enrollment({});};self._submit_enrollment=function(options){var data={case_id:self.case_id(),enrollment_city:window.case_settings.get_enrollment_city_override(),enrollment_state:window.case_settings.get_enrollment_state_override()};if(options.record_id){data.record_id=options.record_id;}else{data.ssn=self.ssn();}
self.loading_message("Loading Enrollment Application...");self.current_panel(self.PANEL_LOADING);submit_to_url(urls.get_in_person_enrollment_url(),data);}};var CaseEnrollmentPeriod=function CaseEnrollmentPeriod(period){var self=this;var defaults={period_type:"annual_period",case_id:null,start_date:"",end_date:""};var settings=$.extend({},defaults,period);self.period_type=settings.period_type;self.is_annual=ko.computed(function(){return self.period_type=="annual_period"});self.is_open=ko.computed(function(){return!self.is_annual()});self.case_id=settings.case_id;self.error=ko.observable("");function strip_year(d){var month_day_search=/\d{4}-(\d{2}-\d{2})/;var matches=d.match(month_day_search);if(matches&&matches.length>1){return matches[1];}
return"";}
if(self.is_open()){self.start_date=ko.observable(normalize_date(settings.start_date));self.end_date=ko.observable(normalize_date(settings.end_date));}else{self.start_date=ko.observable(strip_year(settings.start_date));self.end_date=ko.observable(strip_year(settings.end_date));}
self.is_valid_month_day=function(val){return self.get_month_day(val).isValid();};self.get_month_day=function(val){return parse_month_date_input(val);};self.is_valid_date=function(val){return is_valid_date(val);};self.is_valid=ko.computed(function(){if(self.is_open()){if(self.end_date()){return(self.is_valid_date(self.start_date())&&self.is_valid_date(self.end_date())&&parse_date(self.end_date())>=parse_date(self.start_date()));}else{return self.is_valid_date(self.start_date());}}else{return(self.is_valid_month_day(self.start_date())&&self.is_valid_month_day(self.end_date()));}});self.serialize=function(){return{period_type:self.period_type,case_id:self.case_id,start_date:self.start_date(),end_date:self.end_date()}};};var CaseEnrollmentsViewModel=function(case_data){var self=this;self.add_to_census_modal=new AddToCensusViewModel(case_data.id);ko.applyBindings(self.add_to_census_modal,$("#add-to-census-modal")[0]);$("#add-to-census-btn").on('click',function(){$("#add-to-census-modal").modal("show");self.add_to_census_modal.show_modal();});$("#enrollment").on('click',"button.enroll-employee",function(){var record_id=$(this).attr('data-id');submit_to_url(urls.get_in_person_enrollment_url(),{record_id:record_id,enrollment_city:window.case_settings.get_enrollment_city_override(),enrollment_state:window.case_settings.get_enrollment_state_override()});});};var CaseReportsViewModel=function(params){var self=this;self.is_loading=ko.observable(true);self.error_message=ko.observable("");self.company_name=ko.observable({});self.group_number=ko.observable({});self.any_enrollments=ko.observable(false);self.summary_data=ko.observable({});self.product_data=ko.observable([]);self.enrollment_dates=ko.observable({});self.enrollment_methods=ko.observableArray([]);self.case_agents=ko.observableArray([]);self.load_reports=function(){self.is_loading(true);var url=urls.get_case_api_enrollment_report_url(params.settings_viewmodel.case_id);$.get(url).success(function(resp){self.company_name(resp.data.company_name);self.group_number(resp.data.group_number);self.enrollment_dates(resp.data.enrollment_period);self.enrollment_methods(resp.data.enrollment_methods);self.summary_data(resp.data.summary);self.any_enrollments(self.summary_data().processed_enrollments>0);var pdata=[];$.each(resp.data.product_report,function(){var data=this;pdata.push({name:data.product_name,num_taken:data.enrolled_count,percent_taken:(data.enrolled_count/resp.data.summary.total_census*100).toFixed(2),annualized_premium:data.total_annualized_premium});});self.product_data(pdata);var case_agents=[];if(resp.data.case_owner){case_agents.push(resp.data.case_owner.first+" "+resp.data.case_owner.last);}
_.each(resp.data.case_agents,function(agent){case_agents.push(agent.first+" "+agent.last);});self.case_agents(case_agents);self.is_loading(false);}).error(function(e){console.error(e);self.error_message("There was a problem loading the enrollment report data.");self.is_loading(false);});};self.enter_print_preview=function(){$(".header ul").hide();$(".container.page").hide();$("#print-wrap").html($("#reports .report-wrap").clone()).prepend("<div><a class='btn btn-default hidden-print' href='#reports'>"+"<span class='glyphicon glyphicon-chevron-left'></span> Back to report</a></div>").show();};self.exit_print_preview=function(){$(".header ul").show();$(".container.page").show();$("#print-wrap").hide();};self.load_enrollments=function(){case_management.refresh_enrollments_table(params.settings_viewmodel.case_id,urls.get_case_api_enrollment_records_url(params.settings_viewmodel.case_id),"#enrollment-records-table","#enrollment-table-loading",{},function(table){});};self.format_enrollment_methods=ko.computed(function(){var display_map={in_person:'In Person',self_enroll_email:'Self-Enroll by Email'};return _.map(self.enrollment_methods(),function(m){return display_map[m]}).join(",");});self.format_enrollment_dates=ko.computed(function(){var start=self.enrollment_dates().start;var end=self.enrollment_dates().end;if(is_valid_date(end)){return normalize_date(start)+" - "+normalize_date(end);}else{return"Open enrollment starting "+normalize_date(start);}});self.is_census_report=ko.computed(function(){return self.summary_data().is_census_report;});self.only_one_product=ko.computed(function(){return self.summary_data().only_one_product;});self.product_name=ko.computed(function(){return(self.only_one_product())?self.summary_data().product_names[0]:"";});self.format_total_percent_processed=ko.computed(function(){var percent=self.summary_data().processed_enrollments/self.summary_data().total_census*100;return percent.toFixed(2)+"%";});self.format_total_num_census=ko.pureComputed(function(){return self.summary_data().total_census;});self.format_total_num_processed=ko.computed(function(){return self.summary_data().processed_enrollments;});self.format_total_percent_taken=ko.computed(function(){var percent=self.summary_data().taken_enrollments/self.summary_data().total_census*100;return percent.toFixed(2)+"%";});self.format_total_num_taken=ko.computed(function(){return self.summary_data().taken_enrollments;});self.format_total_num_declined=ko.computed(function(){return self.summary_data().declined_enrollments;});self.format_total_percent_declined=ko.computed(function(){var percent=self.summary_data().declined_enrollments/self.summary_data().total_census*100;return percent.toFixed(2)+"%";});self.format_total_annualized_premium=ko.computed(function(){return'$'+self.summary_data().total_annualized_premium;});self.format_case_agents=ko.computed(function(){return self.case_agents().join(", ");});params.settings_viewmodel.report_viewmodel(self);};function CaseRiderConfiguration(case_settings,product,rider,initial_product_settings){var self=this;self.case_settings=case_settings;self.product=product;self.rider=rider;self.name=rider.name;self.code=rider.code;self.is_rider_initially_selected=function(initial_product_settings){if(!initial_product_settings||!initial_product_settings.riders){return false;}
return _.any(initial_product_settings.riders,function(r){return(self.product.id===r.product_id&&self.rider.code===r.rider_code&&r.is_selected)});};self.is_selected=ko.observable(self.is_rider_initially_selected(initial_product_settings));self.can_enable_rider=ko.pureComputed(function(){var is_enabled=true;_.each(case_settings.enabled_case_riders_for_product(self.product),function(r){if(_.includes(rider.disallowed_rider_combinations,r.code)){is_enabled=false;return false;}});return is_enabled;});}
CaseRiderConfiguration.prototype.serialize=function(){return{product_id:this.product.id,rider_code:this.rider.code,is_selected:this.is_selected()}};function add_case_error(errors,field_name,message){if(field_name in errors){errors[field_name].push(message);}else{errors[field_name]=[message];}}
function get_form_data(form){var data=$(form).serializeArray();var data_object={};$.each(data,function(){var key=this.name;var val=this.value;if(key in data_object&&data_object.length===undefined){data_object[key]=[data_object[key]];data_object[key].push(val);}else if(key in data_object){data_object[key].push(val);}else{data_object[key]=val;}});return data_object;}
function show_loading_panel(modal){$(".form-panel",modal).hide("slide");$(".loading-panel",modal).show("slide");$(".processing-buttons",modal).show("fade");$(".form-buttons",modal).hide("fade");}
function show_error_panel(modal){$(".loading-panel",modal).hide("slide");$(".error-panel",modal).show("slide");$(".error-buttons",modal).show("fade");$(".processing-buttons",modal).hide("fade");}
function show_success_panel(modal){$(".loading-panel",modal).hide("slide");$(".success-panel",modal).show("slide");$(".success-buttons",modal).show("fade");$(".processing-buttons",modal).hide("fade");}
function show_form_panel(modal){$(".modal-panel",modal).hide("slide");$(".buttons-panel",modal).hide("slide");$(".form-panel",modal).show("slide");$(".form-buttons",modal).show("slide");}
function reset_upload_modal(){$(".modal-panel").hide();$(".buttons-panel").hide();$(".form-panel").show();$(".form-buttons").show();}
function handle_upload_success(resp,modal){census_errors_panel.error_records(resp.data.errors);census_errors_panel.num_data_records(resp.data.records.length);show_success_panel($(modal));window.case_settings.census_data(resp.data.records);case_management.refresh_census_table(window.case_id,urls.get_case_api_census_records_url(window.case_id),"#census-records-table","#census-table-loading");}
function handle_upload_error(xhr,modal){if(xhr.status>=400&&xhr.status<500){show_error_panel($(modal));var data=$.parseJSON(xhr.responseText).data;census_errors_panel.error_records(data.errors);$('.upload-error-table td.error').tooltip({placement:"auto left"});}else{alert("Sorry, there was a problem communicating with the server.");reset_upload_modal($(modal));}}
function observe_settings_events(settings){$("#upload-btn").on("click",reset_upload_modal);$(".back-btn").on("click",function(){show_form_panel($(this).parents(".modal"));});$('#reset-page-text').click(function(){$('#page_text').html(settings.default_page_text).focus();});$('#self_enrollment_type').change(function(){if($('#self_enrollment_type option:selected').val()=='case-generic'){$('.self-enroll-email').hide();$('.self-enroll-email-off').show();}else{$('.self-enroll-email').show();$('.self-enroll-email-off').hide();}}).change();$('#edit-self-enrollment-form').on('submit',function(){window.case_settings.save_settings();return false;});}
function observe_census_record_form_submit(){$("#census-record-form").on("submit",function(){var form=this;var file_select=$(this).find("input[type=file]").get(0);var files=file_select.files;var form_data=new FormData();if(files.length!==1){alert("Please select a file");return false;}
form_data.append('csv-file',files[0],files[0].name);form_data.append('upload_type',$("input[name=upload_type]:checked").val());send_file_data("POST",urls.get_case_api_census_records_url(window.case_id),form_data,function(data){handle_upload_success(data,form);},function(err){handle_upload_error(err,form);},false);show_loading_panel($(this));return false;});}
function handle_enrollment_upload_success(data,modal){window.enrollment_api_panel.num_records(data.data.num_processed);show_success_panel($(modal));}
function handle_enrollment_upload_error(err,modal){if(err.status>=400&&err.status<500){var data=$.parseJSON(err.responseText).data;window.enrollment_api_panel.error_records(data.errors);show_error_panel($(modal));}else{alert("Sorry, there was a problem communicating with the server.");reset_upload_modal($(modal));}}
function observe_enrollment_upload_form_submit(){$("#enrollment-csv-form").on("submit",function(){var form=this;var file_select=$(this).find("input[type=file]").get(0);var files=file_select.files;var form_data=new FormData();if(files.length!==1){alert("Please select a file");return false;}
form_data.append('api-upload-file',files[0],files[0].name);file_extension=files[0].name.split(".").slice(-1)[0];if(window.case_settings){form_data.append('case_token',window.case_settings.case_token);}
form_data.append('auth_token',window.enrollment_api_panel.user_token);form_data.append('email_errors',false);form_data.append('upload_source','api');form_data.append('format',file_extension);send_file_data("POST",urls.get_submit_enrollment_records_url(),form_data,function success(data){handle_enrollment_upload_success(data,form);},function error(err){handle_enrollment_upload_error(err,form);},false);show_loading_panel($(this));return false;});}
function init_settings_fields(){$('#csv-file-input').ace_file_input({no_file:'No File ...',btn_choose:'Choose File',btn_change:'Change File',droppable:false,onchange:null,thumbnail:false,whitelist:'csv'});$('#csv-file-input-enrollment').ace_file_input({no_file:'No File ...',btn_choose:'Choose File',btn_change:'Change File',droppable:false,onchange:null,thumbnail:false,whitelist:'csv'});$(".input-mask-date").mask("99/99/9999");$(".input-mask-month-day").mask("99/99");$('[data-rel=tooltip]').tooltip();$('#partner-agents').bootstrapDualListbox({infoTextFiltered:'<span class="label label-purple label-lg">Filtered</span>',showFilterInputs:true,moveOnSelect:false,nonSelectedListLabel:'Available Agents:',selectedListLabel:'Case Visible to Agents:'});}
function init_enrollment_import_fields(){$('#csv-file-input-enrollment').ace_file_input({no_file:'No File ...',btn_choose:'Choose File',btn_change:'Change File',droppable:false,onchange:null,thumbnail:false,whitelist:'csv'});}
function apply_default_values(){$.each(['#email_sender_name','#email_sender_email','#email_message','#page_title','#page_text'],function(index,value){if($(value).prop('tagName')=='DIV'){if($(value).html()==''){$(value).html($(value).attr('default'));$(value).trigger('change');}}else{if($(value).val()==''){$(value).val($(value).attr('default'));$(value).trigger('change');}}});}
function handle_url_hashs(){if(window.location.hash=='#success'){window.location.href=window.location.href.replace(/#.*$/,'#');$('#save-success').show();}
if(window.location.hash==""){window.location.hash="setup";}}
var CaseViewModel=function CaseViewModel(case_data,product_choices,can_edit_case,settings,product_rate_levels){var self=this;_.defaults(case_data,{omit_actively_at_work:false});self.case_id=case_data.id;self.case_token=case_data.case_token;self.product_rate_levels=product_rate_levels||{};self.can_edit_case=can_edit_case;self.report_data=ko.observable(null);self.report_viewmodel=ko.observable(null);self.is_data_dirty=ko.observable();self.report_viewmodel.subscribe(function(val){if(val&&window.location.hash=="#reports"){val.load_reports();val.load_enrollments();}});self.company_name=ko.observable(case_data.company_name||"").extend({rateLimit:1000});self.group_number=ko.observable(case_data.group_number||"");self.product_choices=ko.observableArray(product_choices);var initially_selected_products=_.chain(self.product_choices()).filter(function(p){return _.includes(_.map(case_data.products,"id"),p.id);}).value();initially_selected_products=_.sortBy(initially_selected_products,function(product){return product.ordinal;});self.products=ko.observableArray(initially_selected_products);self.sort_selected_products=ko.observableArray([]);self.products.subscribe(function(){self.is_data_dirty(true);self.update_product_ordinals();});self.has_fpp_products=ko.pureComputed(function(){return _.any(self.products(),function(product){return _.startsWith(product.base_product_type,"FPP");});});self.omit_actively_at_work=ko.observable(case_data.omit_actively_at_work);self.omit_actively_at_work.subscribe(function(){self.is_data_dirty(true);});self.has_product_sort_selections=ko.pureComputed(function(){return!!self.sort_selected_products()&&self.sort_selected_products().length>0;});self.unselected_products=ko.pureComputed(function(){return _.sortBy(_.difference(self.product_choices(),self.products()),function(product){return product.ordinal;});});self.selected_product=ko.observable(null);self.has_selected_product=ko.pureComputed(function(){return!!self.selected_product();});self.add_selected_product=function(){var product=self.selected_product();if(!product){return;}
self.products.push(product);};self.remove_selected_products=function(){var products_to_remove=self.sort_selected_products();var products=self.products();if(!products_to_remove||products_to_remove.length===0){return;}
_.forEach(products_to_remove,function(product){var index=products.indexOf(product);if(index!==-1){products.splice(index,1);}});self.products(products);self.update_product_ordinals();};self.emailSettings={sender_name:ko.observable(case_data.self_enrollment_setup.email_sender_name),sender_email:ko.observable(case_data.self_enrollment_setup.email_sender_email),subject:ko.observable(case_data.self_enrollment_setup.email_subject||settings.default_email_subject),greeting_type:ko.observable(case_data.self_enrollment_setup.email_greeting_type),greeting_salutation:ko.observable(case_data.self_enrollment_setup.email_greeting_salutation),message:ko.observable(case_data.self_enrollment_setup.email_message||settings.default_email_message)};self.resetEmail=function(){self.emailSettings.message(settings.default_email_message);self.emailSettings.subject(settings.default_email_subject);};self.landing={page_title:ko.observable(case_data.self_enrollment_setup.page_title||$("#page_title").html()),page_text:ko.observable(case_data.self_enrollment_setup.page_text||$("#page_text").html())};self.update_product_ordinals=function(){for(var idx=0;idx<self.products().length;idx++){var product=self.products()[idx];product.ordinal=idx;}};self.move_products_up=function(){var productsToSort=self.sort_selected_products();if(!productsToSort||productsToSort.length===0||productsToSort.length===self.products().length){return;}
var selectedProducts=self.products();var startPosition=selectedProducts.indexOf(_.first(productsToSort));if(startPosition===0){return;}
_.forEach(productsToSort,function(product){var position=selectedProducts.indexOf(product);if(position===0||position===-1){return;}
selectedProducts.splice(position,1);selectedProducts.splice(position-1,0,product);self.products(selectedProducts);});self.update_product_ordinals();};self.move_products_down=function(){var productsToSort=self.sort_selected_products();if(!productsToSort||productsToSort.length===0||productsToSort.length===self.products().length){return;}
var selectedProducts=self.products();var endPosition=selectedProducts.indexOf(_.last(productsToSort));if(endPosition===selectedProducts.length-1){return;}
_.chain(productsToSort).reverse().forEach(function(product){var position=selectedProducts.indexOf(product);if(position===-1){return;}
selectedProducts.splice(position,1);selectedProducts.splice(position+1,0,product);self.products(selectedProducts);}).value();self.update_product_ordinals();};self.get_rate_levels_for_product_code=function(product_code){if(_.has(self.product_rate_levels,product_code)){return self.product_rate_levels[product_code];}else{return[];}}
self.enrollment_period_type=ko.observable(case_data.enrollment_period_type);self.enrollment_periods=ko.observableArray($.map(case_data.enrollment_periods,function(p){return new CaseEnrollmentPeriod(p);}));self.situs_city=ko.observable(case_data.situs_city);self.state_choices=settings.all_states;self.situs_state=ko.observable(get_state_from_statecode(case_data.situs_state));function get_state_from_statecode(statecode){return _.find(self.state_choices,function(c){return c.statecode==statecode;});}
self.enrollment_city_override=ko.observable(get_storage_or_default('enrollment_city_override.'+self.case_id,self.situs_city()));self.enrollment_state_override=ko.observable(get_default_state_override());self.get_enrollment_city_override=ko.pureComputed(function(){if(!self.enrollment_city_override()){return"";}
return self.enrollment_city_override();});self.get_enrollment_state_override=ko.pureComputed(function(){if(!self.enrollment_state_override()){return"";}
return self.enrollment_state_override().statecode;});set_storage_from_observable('enrollment_city_override.'+self.case_id,self.enrollment_city_override);set_storage_from_observable('enrollment_state_override.'+self.case_id,self.get_enrollment_state_override);function get_default_state_override(){var case_default_statecode=(self.situs_state())?self.situs_state().statecode:"";var statecode=get_storage_or_default('enrollment_state_override.'+self.case_id,case_default_statecode);if(!statecode||!get_state_from_statecode(statecode)){return get_state_from_statecode(case_default_statecode);}else{return get_state_from_statecode(statecode);}}
function get_storage_or_default(key,default_val){if(window.sessionStorage.getItem(key)){return window.sessionStorage.getItem(key);}
return default_val;}
function set_storage_from_observable(key,observable){observable.subscribe(function(new_val){window.sessionStorage.setItem(key,new_val);});}
self.situs_city.subscribe(function(new_val){self.enrollment_city_override(new_val);});self.situs_state.subscribe(function(new_val){self.enrollment_state_override(new_val);});self.selected_statecode=ko.pureComputed(function(){return(self.situs_state())?self.situs_state().statecode:null;});self.is_active=ko.observable(case_data.active);self.owner_agent_id=ko.observable(case_data.agent_id||"");var should_restrict_downloads=false;if(case_data.can_partners_download_enrollments===false){should_restrict_downloads=true;}
self.restrict_download_enrollments_to_owner=ko.observable(should_restrict_downloads);self.can_partners_download_enrollments=ko.pureComputed(function(){return!self.restrict_download_enrollments_to_owner();});self.can_download_enrollments=ko.pureComputed(function(){return self.has_census_data();});self.partner_agents=ko.observable((case_data.partner_agents)?_.map(_.pluck(case_data.partner_agents,"id"),function(id){return id+"";}):[]);self.state_product_limiter=new ProductStatesLimiterViewModel(settings.product_state_mapping,self.situs_state,self.state_choices,self.products,self.product_choices);self.on_products_select_rendered=function(option,item){if(!item){return;}
var is_valid=ko.pureComputed(function(){return self.state_product_limiter.is_valid_product_for_state(item,self.situs_state());});ko.applyBindingAccessorsToNode(option,{enable:is_valid},item);};self.is_editing_products=ko.observable(false);if(case_data.products.length===0){self.is_editing_products(true);}
self.start_editing_products=function(){self.is_editing_products(true);};self.stop_editing_products=function(){self.is_editing_products(false);};self.state_product_override_limiter=new StatesLimiterViewModel(settings.product_state_mapping,self.enrollment_state_override,self.state_choices,self.products);self.on_state_selected=function(){self.selected_product(null);};self.state_product_limiter.selected_state.subscribe(self.on_state_selected);self.state_product_override_limiter.selected_state.subscribe(self.on_state_selected);self.is_open_enrollment=ko.pureComputed(function(){return self.enrollment_period_type()==="open";});self.is_annual_enrollment=ko.pureComputed(function(){return self.enrollment_period_type()==="annual";});self.get_open_enrollment_period=ko.pureComputed(function(){return _.find(self.enrollment_periods(),function(p){return p.is_open();});});self.today_between=ko.pureComputed(function(){if(!self.get_open_enrollment_period()){return false;}
var start=self.get_open_enrollment_period().start_date();var end=self.get_open_enrollment_period().end_date();return today_between(start,end);});self.annual_enrollment_periods=ko.pureComputed(function(){return _.filter(self.enrollment_periods(),function(p){return p.period_type==="annual_period";});});self.annual_today_between=ko.pureComputed(function(){if(self.annual_enrollment_periods().length>=4&&self.annual_enrollment_periods()[0].start_date()!==""){return self.annual_enrollment_periods().reduce(function(a,period){var start_date=moment(period.start_date(),"MM/DD");var end_date=moment(period.end_date(),"MM/DD");return today_between(start_date,end_date)||a;},false);}
return true;});self.payment_mode_choices=settings.payment_modes;self.payment_mode=ko.observable(_.find(self.payment_mode_choices,function(c){return c.mode==case_data.payment_mode;}));self.selected_payment_mode=ko.pureComputed(function(){return(self.payment_mode())?parseInt(self.payment_mode().mode):null;});self.include_bank_draft_form=ko.observable(case_data.include_bank_draft_form);self.can_include_bank_draft_form=ko.pureComputed(function(){return self.selected_payment_mode()===12;});self.can_include_bank_draft_form.subscribe(function(can_include){if(!can_include){self.include_bank_draft_form(false);}});self.should_use_call_center_workflow=ko.observable(case_data.should_use_call_center_workflow);if(!Array.isArray(case_data.occupation_class_settings)){case_data.occupation_class_settings=[];}
if(!_.any(case_data.occupation_class_settings,function(occupation){return occupation.label.toLowerCase()===DEFAULT_OCCUPATION_LABEL.toLowerCase();})){case_data.occupation_class_settings.unshift({label:DEFAULT_OCCUPATION_LABEL,level:1});}
self.occupation_classes=ko.observableArray(sort_occupations(_.map(case_data.occupation_class_settings,function(occupation){return new OccupationVM(occupation.label,occupation.level,occupation.has_applicants);})));self.new_occupation_class=ko.observable('');self.addOccupationClass=function(){self.occupation_classes.push(new OccupationVM(self.new_occupation_class()));self.occupation_classes(sort_occupations(self.occupation_classes()));self.new_occupation_class('');self.is_data_dirty(true);};self.pending_delete_occupation_class=ko.observable(null);self.confirm_remove_occupation_class=function(){var occupation_class=self.pending_delete_occupation_class();if(occupation_class){self.occupation_classes.remove(occupation_class);self.is_data_dirty(true);}};self.removeOccupationClass=function(occupation_class){if(occupation_class.has_applicants){self.pending_delete_occupation_class(occupation_class);$('#occupation-deletion-warning').modal('show');}else{self.occupation_classes.remove(occupation_class);self.is_data_dirty(true);}};self.is_new_occupation_class_valid=ko.pureComputed(function(){var index=_.findIndex(self.occupation_classes(),function(item){return item.label.toLowerCase()===self.new_occupation_class().toLowerCase();});return(self.new_occupation_class()!==''&&index===-1);});self.hi_occupation_classes=[];self.eligible_product_codes=['ACC','HI'];self.is_product_occupation_class_eligible=function(product){return self.eligible_product_codes.indexOf(product.base_product_type)!=-1;};self.is_case_occupation_class_eligible=function(){return _.any(_.map(case_settings.products(),function(p){return self.is_product_occupation_class_eligible(p);}));};self.occ_mapping_cache={};self.update_occ_vm=function(product_id,label,value){var is_update=false;if(product_id in self.occ_mapping_cache){if(!(label in self.occ_mapping_cache[product_id])){is_update=true;}}else{self.occ_mapping_cache[product_id]={};self.occ_mapping_cache[product_id][label]={};is_update=true;}
if(is_update){self.occ_mapping_cache[product_id][label]={product_id:product_id,label:label,value:ko.observable(value)};self.occ_mapping_cache[product_id][label].value.subscribe(function(){self.is_data_dirty(true);});}};function is_product_active(product){for(var i in self.products()){if(i=='first'){continue;}
if(self.products()[i].id==product.id){return true;}}
return false;}
function is_occupation_class_active(label){for(var i in self.occupation_classes()){if(i=='first'){continue;}
if(self.occupation_classes()[i].label==label){return true;}}
return false;}
self.deserialize_occ_mapping=function(){self.occ_mapping_cache={};if(!case_data.product_settings){return;}
var data=case_data.product_settings.classification_mappings;if(!data){return;}
for(var i=0;i<case_data.products.length;i++){for(var j=0;j<self.occupation_classes().length;j++){var product=case_data.products[i];var occ_label=self.occupation_classes()[j].label;var value=null;if(data[product.id]!=undefined&&data[product.id][occ_label]!=undefined){value=data[product.id][occ_label];}
self.update_occ_vm(product.id,occ_label,value);}}};self.deserialize_occ_mapping();self.serialize_occ_mapping=function(){var data={};for(var product_id in self.occ_mapping_cache){if(!is_product_active({id:product_id})){continue;}
if(!(product_id in data)){data[product_id]={};}
for(var label in self.occ_mapping_cache[product_id]){if(!is_occupation_class_active(label)){continue;}
if(!(label in data)){data[product_id][label]=self.occ_mapping_cache[product_id][label].value();}}}
return data;};self.occupation_classes_for_product=function(product){var occupation_mappings=[];if(!(product.id in self.occ_mapping_cache)){for(var i in self.occupation_classes()){if(i=='first'){continue;}
self.update_occ_vm(product.id,self.occupation_classes()[i].label,null);}}
for(var i in self.occupation_classes()){if(i=='first'){continue;}
if(!(self.occupation_classes()[i].label in self.occ_mapping_cache[product.id])){self.update_occ_vm(product.id,self.occupation_classes()[i].label,null);}}
for(var label in self.occ_mapping_cache[product.id]){if(is_product_active(product)&&is_occupation_class_active(label)){occupation_mappings.push(self.occ_mapping_cache[product.id][label]);}}
return sort_occupations(occupation_mappings);};self._case_rider_configurations_by_product={};self.case_riders=ko.pureComputed(function(){var _case_rider_configs=[];_.each(self.products(),function(product){if(!_.has(self._case_rider_configurations_by_product,product.id)){self._case_rider_configurations_by_product[product.id]=_.map(product.riders,function(r){return new CaseRiderConfiguration(self,product,r,case_data.product_settings);});}
_case_rider_configs=_case_rider_configs.concat(self._case_rider_configurations_by_product[product.id]);});return _case_rider_configs;});self.case_riders_for_product=function(product){return _.filter(self.case_riders(),function(rider){return rider.product===product;});};self.enabled_case_riders=ko.pureComputed(function(){return _.filter(self.case_riders(),function(rider){return rider.is_selected()===true;});});self.enabled_case_riders_for_product=function(product){return _.filter(self.enabled_case_riders(),function(cr){return cr.product===product;});};if(!Array.prototype.first){Array.prototype.first=function(){if(this.length>0){return this[0];}else{return undefined;}};}
self.owner_agent=ko.pureComputed(function(){return _.find(settings.active_agents,function(elem){return elem.id===parseInt(self.owner_agent_id(),10);});});self.partner_agent_list=ko.pureComputed(function(){return settings.active_agents.filter(function(elem){return self.partner_agents().indexOf(String(elem.id))!==-1;});});self.case_agents=ko.pureComputed(function(){var owner=self.owner_agent();if(owner&&_.pluck(self.partner_agent_list(),"id").indexOf(owner.id)===-1){var all_agents=self.partner_agent_list().concat(owner);all_agents.sort(function(a,b){if(a.last==b.last){return a.first.localeCompare(b.first);}
return a.last.localeCompare(b.last);});return all_agents;}else{return self.partner_agent_list();}});self.has_agent_splits=ko.observable(case_data.is_stp);self.selected_agent_splits=ko.observableArray(get_initial_splits());self.selected_agent=ko.observable();self.selected_agents=ko.observableArray(get_initial_split_agents());self.unused_agents=ko.pureComputed(function(){var selected_ids=self.selected_agents();return self.case_agents().filter(function(i){return!~selected_ids.indexOf(i.id);});});self.show_product_subcount_modal=function(element_id){$('#'+element_id).modal('show');};self.add_agent_split=function(){var selected_agent=self.selected_agent();if(selected_agent){self.selected_agents.push(selected_agent.id);}};self.get_agent_name_from_id=function(agent_id){if(agent_id===null){return"Writing Agent";}
var cur_agent=settings.active_agents.filter(function(elem){return elem.id===agent_id;}).first();if(!cur_agent){return"";}
return cur_agent.first+" "+cur_agent.last;};self.get_agent_splits_for_product=function(product_id){return _.filter(self.selected_agent_splits(),function(split){return!!split.agent_id&&split.product_id===product_id;});};self.are_agent_splits_complete=function(product_id){if(!self.has_agent_splits()){return true;}
var splits=self.selected_agent_splits().filter(function(split){return!!split.agent_id&&split.product_id===product_id;});return _.reduce(splits,function(sum,n){return sum&&!!n.commission_subcount_code();},true);};self.product_split_percentage_computeds={};self.get_product_split_percentage_complete_computed=function(product_id){if(!product_id){return null;}
var computed;if(_.has(self.product_split_percentage_computeds,product_id)){computed=self.product_split_percentage_computeds[product_id];}else{computed=ko.pureComputed(function(){var total=_.chain(self.selected_agent_splits()).filter(function(split){return split.product_id===product_id;}).sum(function(split){return split.split_percentage();}).value();return total===100;});self.product_split_percentage_computeds[product_id]=computed;}
return computed;};self.is_split_percentage_complete=function(product_id){if(!self.has_agent_splits()){return true;}
var total=_.chain(self.selected_agent_splits()).filter(function(split){return split.product_id===product_id;}).sum(function(split){return split.split_percentage;}).value();return total===100;};self.get_agent_splits_completion_status=function(product_id){if(!self.has_agent_splits()){return"Complete";}
var splits=self.selected_agent_splits().filter(function(split){return!!split.agent_id&&split.product_id===product_id;});var success=_.reduce(splits,function(sum,n){return sum&&!!n.commission_subcount_code();},true);if(success){return"Complete";}else{return"Incomplete";}};self.agent_has_percentage=function(agent){return _.some(self.selected_agent_splits(),{agent_id:agent.id});};self.agents_with_percentage=ko.pureComputed(function(){return _.filter(self.case_agents(),function(agent){return self.agent_has_percentage(agent);});});function AgentSplit(agent_id,product_id,commission_subcount_code,split_percentage,is_added){this.agent_id=agent_id;this.product_id=product_id;this.commission_subcount_code=ko.observable(commission_subcount_code);this.split_percentage=ko.observable(split_percentage);this.is_added=ko.observable(!!is_added);this.valid=ko.pureComputed(function(){if(this.agent_id===null){return true;}
return self.case_agents().filter(function(elem){return elem.id===this.agent_id;}.bind(this)).length>0;},this);this.product_name=(function(){var cur_product=self.products().filter(function(elem){return elem.id===product_id;}).first();return cur_product.name;})();this.toJson=function(){return{agent_id:this.agent_id,product_id:this.product_id,split_percentage:this.split_percentage()||null,commission_subcount_code:this.commission_subcount_code()};};this.commission_subcount_code.subscribe(function(){self.is_data_dirty(true);});this.split_percentage.subscribe(function(){self.is_data_dirty(true);});}
self.get_or_create_split=function(agent_id,product_id){var existing_split=_.find(self.selected_agent_splits.peek(),function(elem){return elem.product_id===product_id&&elem.agent_id===agent_id;});if(existing_split){return existing_split;}else{var split=new AgentSplit(agent_id,product_id);self.selected_agent_splits.push(split);return split;}};self.has_products=ko.pureComputed(function(){return!!self.products()&&self.products().length>0;});function get_initial_splits(){return case_data.agent_splits.filter(function(elem){return _.find(self.products(),function(product){return product.id===elem.product_id;})!==undefined;}).map(function(elem){return new AgentSplit(elem.agent_id,elem.product_id,elem.commission_subcount_code,elem.split_percentage);});}
function get_initial_split_agents(){var agentIds=_.chain(case_data.agent_splits).filter(function(split){return!!split.split_percentage&&_.find(self.case_agents(),{id:split.agent_id});}).map(function(split){return split.agent_id;}).uniq().value();if(agentIds.indexOf(null)===-1){agentIds.splice(0,0,null);}
return agentIds;}
self.is_self_enrollment=ko.observable(case_data.is_self_enrollment);self.is_self_enrollment.subscribe(function(){if(!self.is_self_enrollment()){bootbox.confirm('<h3>Any self-enrollment links you have sent out <u class="text-danger">will no longer work</u> if you turn off self-enrollment.</h3><p>Click <em>OK</em> to turn it off, or <em>Cancel</em> to leave it on.</p>',function(result){self.is_self_enrollment(!result);});}});self.self_enrollment_type=ko.observable(case_data.self_enrollment_type);self.enrolling_agent_id=ko.observable(case_data.self_enrollment_setup.enrolling_agent_id);if(!self.get_open_enrollment_period()){self.enrollment_periods.push(new CaseEnrollmentPeriod({case_id:case_data.id,period_type:"open_with_start"}));}
if(self.annual_enrollment_periods().length<4){var num_missing=4-self.annual_enrollment_periods().length;_.each(_.range(num_missing),function(){var p=new CaseEnrollmentPeriod({case_id:case_data.id,period_type:"annual_period"});self.enrollment_periods.push(p);});}
function get_annual_periods_after_period(period){var periods=self.annual_enrollment_periods();return _.filter(periods,function(p){return periods.indexOf(p)>periods.indexOf(period);});}
function compute_next_quarter_start(m){return m.add(3,"months");}
function compute_period_end(start,months){return start.add(months,"months").subtract(1,"day");}
function compute_quarterly_dates(period,val){if(val&&period.is_valid_month_day(val)&&period.end_date()===""){var computed_date=compute_period_end(period.get_month_day(val),2);period.end_date(computed_date.format("MM/DD"));var remaining_periods=get_annual_periods_after_period(period);var previous_period=period;$.each(remaining_periods,function(){var rp=this;if(!rp.is_valid()){var previous_start=previous_period.get_month_day(previous_period.start_date());var computed_start=compute_next_quarter_start(previous_start);rp.start_date(computed_start.format("MM/DD"));var computed_finish=compute_period_end(computed_start,1);rp.end_date(computed_finish.format("MM/DD"));}else{return false;}
previous_period=rp;});}}
var first_period=self.annual_enrollment_periods()[0];first_period.start_date.extend({notify:'always'});first_period.start_date.subscribe(function(val){compute_quarterly_dates(first_period,val);});_.each(self.annual_enrollment_periods(),function(period){_.each([period.start_date,period.end_date],function(date_observable){date_observable.subscribe(function(val){if(val===""){return;}
var val_date=parse_month_date_input(val);if(!val_date.isValid()){date_observable("");bootbox.dialog({title:"Invalid Date",message:"The value '"+val+"' is not a valid start or end date. Provide a month and date formatted as 'MM/DD'.",buttons:{main:{label:"OK"}}});}});});});self.census_data=ko.observable(true);self.has_census_data=ko.pureComputed(function(){return self.census_data();});self.flash_messages=new FlashMessages();if(self.can_edit_case){var fields=[self.company_name,self.group_number,self.products,self.enrollment_period_type,self.enrollment_periods,self.situs_city,self.situs_state,self.payment_mode,self.is_active,self.owner_agent_id,self.can_partners_download_enrollments,self.is_self_enrollment,self.selected_agent_splits,self.has_agent_splits];_.each(self.enrollment_periods(),function(p){fields.push(p.start_date);fields.push(p.end_date);});$.each(fields,function(){var field=this;field.subscribe(function(){self.is_data_dirty(true);});});$("#edit-self-enrollment-form").on("change","input, select, [contenteditable]",function(){if(self.is_self_enrollment()){self.is_data_dirty(true);}});}
self.email_batches=ko.observableArray([]);$.getJSON(urls.get_case_api_census_email_batches(case_data.id),function(data){self.email_batches(data.data);});self.batch_preview=function(batch){window.open(urls.get_case_api_census_email_batch_preview_url(case_data.id,batch.id),"batchView","menubar=no,location=no,resizable=no,width=650,height=600,scrollbars=yes,status=yes");};self.load_logs=function(batch){$("#log"+batch.id).html("Loading Logs...");$.get(urls.get_case_api_census_email_batch_logs_url(case_data.id,batch.id),function(data){$("#log"+batch.id).html(data);$("#log"+batch.id+" .dt-responsive").dataTable();$("#log"+batch.id+" .dt-responsive .status").each(function(){$(this).html(format_enrollment_status_html($(this).text()));});});};self.can_activate_case=ko.pureComputed(function(){var is_valid=(self.enrollment_period_type()!==null&&self.enrollment_periods().length>0&&self.products().length>0&&$.trim(self.company_name())!==""&&$.trim(self.situs_city())!==""&&self.selected_statecode()!==null&&self.selected_payment_mode()!==null&&self.owner_agent_id()>0);return is_valid;});self.is_active.subscribe(function(value){if(value&&!self.can_activate_case()){bootbox.alert("Cannot activate case for enrollment until settings are complete.");self.is_active(false);}
self.toggle_enrollment_buttons();});self.toggle_enrollment_buttons=function(){if(self.is_active()){$("button.enroll-employee").prop('disabled',false);}else{$("button.enroll-employee").prop('disabled',true);}};self.toggle_enrollment_buttons();self.switch_label=ko.pureComputed(function(){if(self.is_active()){return"Case is Active";}else{return"Case is Not Active";}});self.get_form_error=ko.pureComputed(function(){if(self.company_name.is_unique!==undefined&&self.company_name.is_unique()===false){return"The name '"+self.company_name()+"' is already used.";}
return"";});self.check_unique_name=function(current_value,callback){$.get(urls.get_cases_api_url(case_data.id),{by_name:current_value},function(result){var is_unique=(result.data.length===0||current_value===case_data.company_name);callback(is_unique);},"json");};self.validate_splits=function(callback){if(!self.has_agent_splits()){return true;}
if(!_.all(self.products(),self.has_proper_split_percentage_sum)){var invalid_product=_.find(self.products(),_.negate(self.has_proper_split_percentage_sum));var bad_sum=self.sum_split_percentages_for_product(invalid_product);bootbox.alert("Agent splits for "+invalid_product.name+" must total 100%; the current total percentage is "+bad_sum+"%",function(){$('.bootbox.modal').modal('hide');if(callback){callback();}});return false;}
return true;};self.has_proper_split_percentage_sum=function(product){var product_split_sum=self.sum_split_percentages_for_product(product);return product_split_sum===100;};self.sum_split_percentages_for_product=function(product){var splits=self.selected_agent_splits();var splits_for_product_with_percentage=splits.filter(function(elem){return elem.product_id===product.id&&parseInt(elem.split_percentage())>0;});return splits_for_product_with_percentage.reduce(function(acc,split){return acc+parseInt(split.split_percentage(),0);},0);};self.validate=function(){hide_all_errors();_.invoke(self.annual_enrollment_periods(),"error","");var errors={};var unique_name_error=self.get_form_error();if(unique_name_error!==""){add_case_error(errors,"company_name",unique_name_error);}
if($.trim(self.company_name())===""){add_case_error(errors,"company_name","Company name is required.");}
if(self.is_open_enrollment()&&!self.get_open_enrollment_period().is_valid()){var start=self.get_open_enrollment_period().start_date();var end=self.get_open_enrollment_period().end_date();if(end!==''){if(!is_valid_date(end)){add_case_error(errors,"open_enrollment_end_date","Enter valid End Date");}else if(start===''){add_case_error(errors,"open_enrollment_start_date","Enter valid Start Date or both dates blank");}}
if(start!==''&&!is_valid_date(start)){add_case_error(errors,"open_enrollment_start_date","Enter valid Start Date");}
if(start!==''&&end!==''&&parse_date(start)>parse_date(end)){add_case_error(errors,"open_enrollment_start_date","Start Date comes after End Date");}}
if(self.is_annual_enrollment()&&self.any_annual_period_missing_a_component()){var missing_observables=_.filter(self.annual_enrollment_periods(),self.missing_annual_period_predicate);_.invoke(missing_observables,"error","Must fill in start and end date");return false;}
if(Object.keys(errors).length>0){show_all_errors(errors);return false;}else{return true;}};self.missing_annual_period_predicate=function(period){var start_date_present=period.start_date()!=="";var end_date_present=period.end_date()!=="";return(start_date_present?!end_date_present:end_date_present);};self.any_annual_period_missing_a_component=function(){return _.any(self.annual_enrollment_periods(),self.missing_annual_period_predicate);};self.serialize_case=function(){var partner_agents=_.map(self.partner_agents(),function(id_str){return parseInt(id_str);});return{company_name:self.company_name(),group_number:self.group_number(),active:self.is_active(),products:self.products(),partner_agents:partner_agents,enrollment_period_type:self.enrollment_period_type(),situs_city:self.situs_city(),situs_state:self.selected_statecode()?self.selected_statecode():"",payment_mode:self.selected_payment_mode()?self.selected_payment_mode():null,agent_id:self.owner_agent_id(),can_partners_download_enrollments:self.can_partners_download_enrollments(),is_self_enrollment:self.is_self_enrollment(),include_bank_draft_form:self.include_bank_draft_form(),should_use_call_center_workflow:self.should_use_call_center_workflow(),product_settings:self.serialize_product_settings(),is_stp:Boolean(self.has_agent_splits()),occupation_class_settings:_.map(self.occupation_classes(),function(occupation_class){return occupation_class.serialize_object();}),omit_actively_at_work:self.omit_actively_at_work()};};self.serialize_product_settings=function(){return{riders:self.serialize_riders(),classification_mappings:self.serialize_occ_mapping()};};self.serialize_riders=function(){return _.invoke(self.case_riders(),"serialize");};self.serialize_enrollment_periods=function(){if(self.is_annual_enrollment()){return _.invoke(_.filter(self.annual_enrollment_periods(),function(p){return p.is_valid();}),"serialize");}else{var period=self.get_open_enrollment_period();return[period.serialize()];}};function removeHarmfulEmailTags(message){var allowedTags=["br","span","strong","b","i","em","emphasis","img","a"]
var base=$("<div>"+message+"</div>")[0].childNodes;var mapped=Array.prototype.map.call(base,function(elem,a){if(elem.tagName){var tagName=elem.tagName.toLowerCase();if(allowedTags.indexOf(tagName)===-1){elem=$(elem).contents().unwrap()[0]}}
return elem;});var htmlstr=Array.prototype.reduce.call(base,function(html,node){return html+(node.outerHTML||node.nodeValue);},"");return htmlstr;}
self.serialize_self_enroll=function(){self.emailSettings.message(removeHarmfulEmailTags(self.emailSettings.message()));var settings=$.extend({},self.emailSettings,self.landing);for(var key in settings){if(settings.hasOwnProperty(key)){settings[key]=settings[key]();}}
return{self_enrollment_type:self.self_enrollment_type(),enrolling_agent_id:self.enrolling_agent_id(),email_sender_email:settings.sender_email,email_sender_name:settings.sender_name,email_subject:settings.subject,email_greeting_type:settings.greeting_type,email_greeting_salutation:settings.greeting_salutation,email_message:settings.message,page_title:settings.page_title,page_text:settings.page_text};};self.serialize_agent_splits=function(){var serialized_records=self.selected_agent_splits();serialized_records=_.filter(serialized_records,function(split){return _.some(self.case_agents(),{'id':split.agent_id})||split.agent_id===null;});return serialized_records.reduce(function(start,elem){if(elem.split_percentage()||elem.commission_subcount_code()){start.push(elem.toJson());}
return start;},[]);};self.loading_modal=ko.observable(null);self.save_settings=function(cb){self.flash_messages.clear();if(!self.can_save_case()){return;}
function show_save_dialog(){self.loading_modal({message:"Saving case..."});if(self.is_active()&&!self.can_activate_case()){self.is_active(false);self.flash_messages.flash_error("The case has been deactivated due to missing settings.");}
var case_request=send_json_data("PUT",urls.get_case_api_url(case_data.id),self.serialize_case());var periods_request=send_json_data("PUT",urls.get_case_api_enrollment_periods_url(case_data.id),self.serialize_enrollment_periods());var self_enroll_request;if(self.is_self_enrollment()){self_enroll_request=send_json_data("PUT",urls.get_case_api_self_enrollment_url(case_data.id),self.serialize_self_enroll());}
var agent_splits_request;if(self.has_agent_splits()){agent_splits_request=send_json_data("PUT",urls.get_case_api_agent_splits_url(case_data.id),self.serialize_agent_splits());}
$('#save-success').hide();$('#save-fail').hide();var on_success=function(case_xhr,periods_xhr,self_enroll_xhr){self.is_data_dirty(false);self.flash_messages.flash_success("Data Saved");$("#save-success").text("Data Saved");self.loading_modal(null);};var on_failure=function(failed_xhr){var errors=failed_xhr.responseJSON.errors||[];show_all_errors(errors);self.loading_modal(null);self.flash_messages.flash_error("Save failed. Please correct any errors below.");};var done;if(!self.is_self_enrollment()){done=$.when(case_request,periods_request);}else{done=$.when(case_request,periods_request,self_enroll_request);}
if(cb&&typeof(cb)==="function"){cb(done);self.loading_modal(null);return;}
done.then(on_success,on_failure);return false;}
if(!self.validate_splits(show_save_dialog)){return;}
return show_save_dialog();};self.can_save_case=function(){if(!self.can_edit_case){self.flash_messages.flash_error("Only the case owner agent or home office can make changes to the case.");return false;}
if(!self.validate()){self.flash_messages.flash_error("Please correct any errors below before saving.");return false;}
if(self.is_active()&&!self.can_activate_case()){self.is_active(false);self.flash_messages.flash_error("The case has been deactivated due to missing settings.");}
return true;};self.delete_case=function(){bootbox.confirm("Are you sure you want to the case '"+self.company_name()+"'? This is permanent and cannot be undone!",function(result){if(!result){return;}
self.remote_delete();});};self.remote_delete=function(){var request=send_json_data("DELETE",urls.get_case_api_url(case_data.id));$.when(request).then(function(){bootbox.alert("Case deleted successfully");self.is_data_dirty(false);window.location.href=urls.get_manage_cases_url(case_data.id);},function(){bootbox.alert("There was a problem removing this case.");});};self.is_permanent_delete_modal_showing=ko.observable(false);self.delete_confirmation_text=ko.observable("");self.is_delete_text_valid=ko.pureComputed(function(){return self.delete_confirmation_text()=="DELETE";});self.delete_case_with_enrollments=function(){self.delete_confirmation_text("");self.is_permanent_delete_modal_showing(false);self.is_permanent_delete_modal_showing(true);};if(self.can_edit_case){$(window).bind("beforeunload",function(){return self.has_unsaved_data()?"You have made changes without saving. Do you you wish to leave this page and lose all changes?":undefined;});}
self.show_upload_enrollment_form=function(){var el=$("#enrollment-csv-modal");reset_upload_modal(el);el.modal("show");};self.has_unsaved_data=ko.pureComputed(function(){return self.is_data_dirty();});self.exit_print_mode=function(){if(self.report_viewmodel()){self.report_viewmodel().exit_print_preview();}};self.has_general_product_configuration_options=ko.pureComputed(function(){return self.has_fpp_products()||self.is_case_occupation_class_eligible();});var setup_tab=$('#case-nav-tabs a[href="#setup"]');var enrollment_tab=$('#case-nav-tabs a[href="#enrollment"]');var history_tab=$('#case-nav-tabs a[href="#history"]');var reports_tab=$('#case-nav-tabs a[href="#reports"]');var api_tab=$('#case-nav-tabs a[href="#api"]');self.sammy_app=Sammy(function(){this.get("#setup",function(){self.exit_print_mode();setup_tab.tab('show');if(!self.can_edit_case){$("#setup").find("input, select, button").prop("disabled",true);}});this.before({except:{path:'#setup'}},function(){if(self.has_unsaved_data()){bootbox.dialog({title:"Unsaved Changes",message:"You have made changes without saving. Please save your changes or discard before leaving this page.",buttons:{main:{label:"Save",className:'btn-primary',callback:function(){self.save_settings();}},danger:{label:"Discard Changes",className:'btn-danger',callback:function(){self.is_data_dirty(false);window.location.reload();}},cancel:{label:"Cancel",className:'btn-default',callback:function(){}}}});this.redirect("#setup");return false;}});this.get("#enrollment",function(){self.exit_print_mode();enrollment_tab.tab('show');setTimeout(load_initial_census_data,0);function load_initial_census_data(){case_management.refresh_census_table(case_data.id,urls.get_case_api_census_records_url(case_data.id),"#census-records-table","#census-table-loading",handle_census_data_loaded_first_time,handle_no_census_data_loaded,handle_census_data_loaded);}
function handle_census_data_loaded_first_time(table,data){case_management.init_status_filter(table);case_management.init_alphabet_search(table);}
function handle_census_data_loaded(table,data){self.census_data(data);self.toggle_enrollment_buttons();}
function handle_no_census_data_loaded(){self.census_data(false);self.toggle_enrollment_buttons();}});this.get("#history",function(){self.exit_print_mode();history_tab.tab('show');setTimeout(function(){$.getJSON(urls.get_case_api_census_email_batches(case_data.id),function(data){self.email_batches(data.data);});},0);});this.get("#reports",function(){self.exit_print_mode();reports_tab.tab('show');if(self.report_viewmodel()){self.report_viewmodel().load_reports();self.report_viewmodel().load_enrollments();}});this.get("#api",function(){self.exit_print_mode();api_tab.tab('show');});this.get("#print",function(){if(self.report_viewmodel()){self.report_viewmodel().enter_print_preview();window.print();}else{window.location="#reports";}});}).run();};var EmployeeMatchViewModel=function(data){var self=this;self.id=data.id;self.first=data.employee_first||"(No First Name)";self.last=data.employee_last||"(No Last Name)";self.ssn=data.employee_ssn;self.birthdate=data.employee_birthdate;self.formatted_birthdate=function(){return moment(self.birthdate,"YYYY-MM-DD").format("MM/DD/YYYY");};self.is_selected=ko.observable(false);};var EnrollmentAPIPanel=function EnrollmentAPIPanel(user_token){var self=this;self.user_token=user_token;self.error_records=ko.observableArray();self.num_records=ko.observable();self.display_error=function(error_record){var msg="";if(error_record.record_num){msg+="Error in record "+error_record.record_num+": ";}
msg+=error_record.fields+': '+error_record.message;return msg;}};var SendEmailsModalViewModel=function SendEmailsModalViewModel(case_settings_vm,settings){var self=this;self.case_settings_vm=case_settings_vm;self.numbers={not_sent:ko.pureComputed(function(){return 0;return self.case_settings_vm.census_data().reduce(function addNotSent(acc,app){return!app.sent_email?acc+1:acc;},0);}),not_enrolled:ko.pureComputed(function(){return 0;return self.case_settings_vm.census_data().reduce(function addNotApplied(acc,app){return app.enrollment_status===null?acc+1:acc;},0);}),declined:ko.pureComputed(function(){return 0;return self.case_settings_vm.census_data().reduce(function addDeclined(acc,app){return app.enrollment_status==='declined'?acc+1:acc;},0);})};self.send_type=ko.observable("");self.emailSettings=self.case_settings_vm.emailSettings;self.num_emails_to_send=ko.pureComputed(function(){if(!self.send_type())return 0;return self.numbers[self.send_type().replace("-","_")]();});self.resetEmail=function(){self.emailSettings.message(settings.default_email_message);self.emailSettings.subject(settings.default_email_subject);};self.errors=ko.observableArray();self.send_emails=function(){self.errors([]);if(!confirm("You are about to send out emails. Are you sure?")){return false;}
self.show_loading_panel();if(window.case_settings.can_edit_case){window.case_settings.save_settings(save_callback);}else{send_emails({});}
function save_callback(promise){promise.then(send_emails,handle_failed_save);}
function handle_failed_save(){bootbox.alert("Sorry, there was a problem saving the case data before sending the emails. No emails were sent.");}
function send_emails(data){$.ajax({url:urls.get_case_email_self_enrollment_batches_url(self.case_settings_vm.case_id)+'?send_type='+self.send_type(),method:'POST',dataType:'json',success:function(results){self.show_finished_panel();var sent_status_list=results.data;$('#email-target-links-modal #email-status-wrap').html(sent_status_list.join('<br>'));},error:function(xhr){self.show_error_panel();}});}};self.show_form_panel=function(){$('#email-target-links-modal .success-buttons').hide();$('#email-target-links-modal .form-buttons').show();$('#email-target-links-modal .modal-panel').hide();$('#email-target-links-modal .form-panel').show();};self.show_loading_panel=function(){$('#email-target-links-modal .form-panel').hide();$('#email-target-links-modal .form-buttons').hide();$('#email-target-links-modal .loading-panel').show();$('#email-target-links-modal .processing-buttons').show();};self.show_finished_panel=function(){$('#email-target-links-modal .loading-panel').hide();$('#email-target-links-modal .success-panel').show();$('#email-target-links-modal .processing-buttons').hide();$('#email-target-links-modal .success-buttons').show();$("#email-target-links-modal .success-buttons button").click(function(){self.show_form_panel();});};self.show_error_panel=function(){$('#email-target-links-modal .loading-panel').hide();$('#email-target-links-modal .processing-buttons').hide();$('#email-target-links-modal .form-buttons').hide();$('#email-target-links-modal .error-panel').show();$('#email-target-links-modal .error-buttons').show();$("#email-target-links-modal .error-buttons button:not(.back-btn)").click(function(){$('#email-target-links-modal .error-buttons').hide();$('#email-target-links-modal .processing-buttons').show();$('#email-target-links-modal .modal-panel').hide();$('#email-target-links-modal .form-panel').show();});};};var wizard_applicant=(function(){var _applicant_count=0;function Applicant(options){var self=this;var defaults={first:"",last:"",email:"",phone:"",birthdate:null,ssn:"",gender:null,height:null,weight:null,is_smoker:null,street_address:"",street_address2:"",city:"",state:"",zip:"",existing_coverages:[],occupation:undefined};var applicant_data=$.extend({},defaults,options);self.type=applicant_data.type;self._id=_applicant_count++;self.first=ko.observable(applicant_data.first);self.last=ko.observable(applicant_data.last);self.email=ko.observable(applicant_data.email);self.phone=ko.observable(applicant_data.phone);self.birthdate=ko.observable(normalize_date_of_birth(applicant_data.birthdate));self.ssn=ko.observable(applicant_data.ssn);self.gender=ko.observable(applicant_data.gender);self.height=ko.observable(parseFloat(applicant_data.height)?parseFloat(applicant_data.height):null);self.weight=ko.observable(applicant_data.weight||null);self.is_smoker=ko.observable(applicant_data.is_smoker);self.height_error=ko.observable(null);self.weight_error=ko.observable(null);self.address1=ko.observable(applicant_data.street_address);self.address2=ko.observable(applicant_data.street_address2);self.city=ko.observable(applicant_data.city);self.state=ko.observable(applicant_data.state);self.zip=ko.observable(applicant_data.zip);self.occupation=applicant_data.occupation;self.existing_coverages=applicant_data.existing_coverages||[];self.has_valid_gender=ko.pureComputed(function(){return self.gender()!==null;});self.has_valid_height=ko.computed(function(){return self.height()!=null&&self.height()>0&&self.height_error()==null;});self.has_valid_weight=ko.computed(function(){return self.weight()!=null&&self.weight_error()==null;});self.is_valid=ko.computed(function(){return($.trim(self.first())!=""&&$.trim(self.last())!=""&&$.trim(self.birthdate())!="");});self.any_valid_field=ko.computed(function(){return($.trim(self.first())!==""||$.trim(self.last())!==""||$.trim(self.birthdate())!=="");});self.name=ko.computed(function(){if(self.is_valid()){return self.first();}else{return"";}});self.get_age=ko.computed(function(){return age_for_date(self.birthdate());});self.is_age_in_band=function(min_age,max_age){var is_in_band=true;if(min_age!==null){is_in_band=is_in_band&&self.get_age()>=min_age;}
if(max_age!==null){is_in_band=is_in_band&&self.get_age()<=max_age;}
return is_in_band;};self.serialize_data=function(){var data={};data.first=self.first();data.last=self.last();data.email=self.email();data.age=self.get_age();data.weight=self.weight();data.height=self.height();data.is_smoker=self.is_smoker();data.birthdate=self.birthdate();data.ssn=self.ssn();data.gender=self.gender();data.phone=self.phone();data.address1=self.address1();data.address2=self.address2();data.city=self.city();data.state=self.state();data.zip=self.zip();return data;};self.get_existing_coverage_amount_for_product=function(product_id){var amount=self.get_existing_coverage_amount_by_product()[product_id];if(!amount){return 0;}
return parseFloat(amount);};self.get_existing_coverage_amount_by_product=function(){return _.reduce(self.existing_coverages,function(by_product_id,coverage){if(!(coverage.product.id in by_product_id)){by_product_id[coverage.product.id]=0.0;}
if(coverage.coverage_status==='enrolled'){by_product_id[coverage.product.id]+=parseFloat(coverage.coverage_face_value);}
return by_product_id;},{});};}
Applicant.EmployeeType="employee";Applicant.SpouseType="spouse";Applicant.ChildType="children";var ApplicantGroup=function(options,applicants){var self=this;self.type=options.type;self.applicants=applicants;self._id=_applicant_count++;self.is_valid=ko.computed(function(){return _.all(self.applicants(),function(applicant){return(applicant.any_valid_field()&&applicant.is_valid())||!applicant.any_valid_field();});});self.name=ko.pureComputed(function(){var non_empty_name_applicants=_.filter(self.applicants(),function(applicant){return $.trim(applicant.name())!=="";});return _.invoke(non_empty_name_applicants,"name").join(", ");});self.is_age_in_band=function(min_age,max_age){return self.all_ages_in_band(min_age,max_age);};self.all_ages_in_band=function(min_age,max_age){var is_in_band=true;if(min_age!==null){is_in_band=is_in_band&&_.all(self.applicants(),function(applicant){return applicant.get_age()>=min_age;});}
if(max_age!==null){is_in_band=is_in_band&&_.all(self.applicants(),function(applicant){return applicant.get_age()<=max_age;});}
return is_in_band;};self.any_valid_field=function(){return _.any(self.applicants(),function(applicant){return applicant.any_valid_field();});};self.serialize_data=function(){return{type:self.type,applicants:_.map(self.applicants(),function(applicant){return applicant.serialize_data();})};};self.get_existing_coverage_amount_for_product=function(product_id){if(self.applicants().length===0){return 0;}
return self.applicants()[0].get_existing_coverage_amount_for_product(product_id);};};var ApplicantList=function(initial_list,should_show_spouse,should_show_children){this.applicants=ko.observableArray(initial_list||[]);this.children=ko.pureComputed(this.get_children,this);this._children_group=null;this.should_show_spouse=should_show_spouse;this.should_show_children=should_show_children;this.get_valid_applicants_for_coverage=ko.pureComputed(this._get_valid_applicants_for_coverage,this);this.get_valid_applicants=ko.pureComputed(this._get_valid_applicants,this);if(this.get_employee()===undefined){this.applicants.push(create_applicant({type:Applicant.EmployeeType}));}
if(this.get_spouse()===undefined){this.applicants.push(create_applicant({type:Applicant.SpouseType,last:this.get_employee().last()}));}};ApplicantList.prototype={_get_valid_applicants_for_coverage:function(){var applicants=[];if(this.has_valid_employee()){applicants.push(this.get_employee());}
if(this.should_show_spouse()&&this.has_valid_spouse()){applicants.push(this.get_spouse());}
if(this.should_show_children()&&this.has_valid_children()){applicants.push(this.get_children_group());}
return applicants;},_get_valid_applicants:function(){return _.filter(vm.coverage_vm.applicants.applicants(),function(a){return a.is_valid();});},get_employee:function(){return this._find_applicant_by_type(Applicant.EmployeeType);},get_spouse:function(){return this._find_applicant_by_type(Applicant.SpouseType);},get_children:function(){return _.filter(this.applicants(),function(a){return a.type===Applicant.ChildType;});},get_children_group:function(){if(this._children_group===null){this._children_group=new ApplicantGroup({type:Applicant.ChildType},this.children);}
return this._children_group;},has_valid_employee:function(){return this.get_employee()&&this.get_employee().is_valid();},has_valid_spouse:function(){return this.get_spouse()&&this.get_spouse().is_valid();},has_valid_children:function(){return _.any(this.get_children(),function(c){return c.is_valid();});},get_valid_children:function(){return _.filter(this.get_children(),function(c){return c.is_valid();});},add_applicant:function(applicant){this.applicants.push(applicant);},remove_applicant:function(applicant){this.applicants.remove(applicant);},_find_applicant_by_type:function(applicant_type){return _.find(this.applicants(),function(applicant){return applicant.type===applicant_type;});}};function age_for_date(date){var bd=parse_date(date,"MM/DD/YYYY");if(bd.isValid()){if(bd.isAfter(now())){return-1;}else{return now().diff(bd,"years");}}else{return"";}}
function create_applicant(options){return new Applicant(options);}
return{Applicant:Applicant,ApplicantGroup:ApplicantGroup,ApplicantList:ApplicantList,create_applicant:create_applicant,age_for_date:age_for_date};})();var beneficiary=(function(){"use strict";function Beneficiary(options){var self=this;var defaults={name:"",relationship:"",ssn:"",date_of_birth:"",is_nonperson_entity:false};options=$.merge({},defaults,options);self.name=ko.observable(options.name);self.relationship=ko.observable(options.relationship);self.ssn=ko.observable(options.ssn);self.date_of_birth=ko.observable(options.date_of_birth);self.is_nonperson_entity=ko.observable(options.is_nonperson_entity);self.date_of_birth_validation_error=ko.observable(null);self.date_of_birth.subscribe(function(value){self.date_of_birth_validation_error(get_date_of_birth_validation_error(value));});self.serialize=function(){return{name:self.name(),relationship:self.relationship(),ssn:self.ssn(),date_of_birth:self.date_of_birth(),is_nonperson_entity:self.is_nonperson_entity()};};}
return{Beneficiary:Beneficiary};})();function CoverageOption(options){var self=this;self.is_by_face=options.is_by_face;self.premium=options.premium;self.payment_mode=options.payment_mode;self.face_value=options.face_value;self.applicant_type=options.applicant_type;self.tier=options.tier;self.get_total_premium=function(){return self.premium;};self.format_premium=function(){return format_premium_value(self.premium);};self.format_premium_option=function(){return self.format_premium()+" "+self.payment_mode().display_lowercase();};self.format_face_value=function(){return format_face_value(self.face_value);};self.format_face_option=function(){return self.format_face_value()+" face amount";};self.format_for_dropdown=function(){if(self.is_by_face){return self.format_face_option();}else{return self.format_premium_option();}};self.is_valid=function(){return true;};self.serialize_data=function(){return{premium:self.premium,face_value:self.face_value};};}
CoverageOption.display_benefit_option=function(item){return item.format_for_dropdown();};function CICoverageOption(wrapped_option){var self=this;self.is_by_face=wrapped_option.is_by_face;self.premium=wrapped_option.premium;self.get_total_premium=wrapped_option.get_total_premium;self.face_value=wrapped_option.face_value;self.format_premium=wrapped_option.format_premium;self.format_premium_option=wrapped_option.format_premium_option;self.format_face_value=function(){var face_value_formatted=format_face_value(self.face_value);var ci_value=Math.round(self.face_value*.3);var ci_value_formatted=format_face_value(ci_value);return face_value_formatted+"<br><small>("+ci_value_formatted+" CI)</small>";};self.format_for_dropdown=wrapped_option.format_for_dropdown;self.is_valid=wrapped_option.is_valid;self.serialize_data=wrapped_option.serialize_data;self.payment_mode=wrapped_option.payment_mode;self.applicant_type=wrapped_option.applicant_type;}
function SimpleCoverageOption(options){var self=this;self.is_by_face=true;self.premium=options.premium;if(typeof self.premium==='string'){self.premium=parseFloat(self.premium);}
self.coverage_tier=options.coverage_tier;self.payment_mode=options.payment_mode;self.face_value=options.face_value;self.applicant_type=options.applicant_type;self.get_total_premium=function(){return self.premium;};self.format_premium=function(){if(self.applicant_type!=wizard_applicant.Applicant.EmployeeType){return"";}
return format_premium_value(self.premium);};self.format_premium_option=function(){if(self.applicant_type!=wizard_applicant.Applicant.EmployeeType){return"";}
return self.format_premium()+" "+self.payment_mode().display_lowercase();};self.format_face_value=function(){if(self.applicant_type!=wizard_applicant.Applicant.EmployeeType){return"";}
return'Selected';};self.format_face_option=function(){if(self.applicant_type!=wizard_applicant.Applicant.EmployeeType){return"";}
return self.format_face_value()+" face amount";};self.format_for_dropdown=function(){if(self.applicant_type!=wizard_applicant.Applicant.EmployeeType){return"";}
if(self.is_by_face){return self.format_face_option();}else{return self.format_premium_option();}};self.is_valid=function(){return true;};self.serialize_data=function(){return{premium:self.premium,coverage_selection:self.coverage_tier}}}
function NullCoverageOption(){var self=this;self.is_by_face=true;self.premium=0;self.face_value=0;self.is_removed_from_product=ko.observable(false);self.is_valid=function(){return false;};self.format_premium_option=function(){return"";};self.format_premium=function(){};self.get_total_premium=function(){return 0;};self.format_face_value=function(){return"- no benefit -";};self.format_for_dropdown=function(){return"- no benefit -";};self.serialize_data=function(){return{}};self.payment_mode=function(){return null;};}
var null_coverage=new NullCoverageOption();var health_question_buttons=(function(){function HealthButtonRow(question,product_coverage,product_health_questions){var self=this;self.question=question;self.product_coverage=product_coverage;self.product_health_questions=product_health_questions;self.button_groups=ko.pureComputed(function(){return _.map(self.product_coverage.applicant_list.get_valid_applicants(),function(applicant){var response=self.product_health_questions.get_applicant_answer_for_question(applicant,question);return new ResponseButtonGroup(question,applicant,response,{});});});}
function ResponseButtonGroup(question,applicant,response,options){var self=this;self.question=question;self.applicant=applicant;self.response=response;self.options=_.defaults(options,{'yes_text':'Yes','no_text':'No'});self.yes_text=options.yes_text||"Yes";self.no_text=options.yes_text||"No";self.yes_highlight=self.question.get_yes_highlight();self.no_highlight=self.question.get_no_highlight();self.handle_yes=function(){self.response.value('Yes');if(question.has_static_value){question.value(true);}
if(self.question.action_name===HealthQuestions.Responses.Yes){self.question.show_yes_dialogue(self.applicant);}};self.handle_no=function(){self.response.value('No');if(question.has_static_value){question.value(false);}
if(self.question.action_name===HealthQuestions.Responses.No){self.question.show_yes_dialogue(self.applicant);}};self.does_applicant_need_to_answer=ko.pureComputed(function(){return self.question.does_applicant_need_to_answer(self.applicant);});self.should_show_yes_flag=ko.pureComputed(function(){return self.response.value()==="Yes"&&self.yes_highlight==="flag";});self.should_show_yes_stop=ko.pureComputed(function(){return self.response.value()==="Yes"&&self.yes_highlight==="stop";});self.should_show_yes_checkmark=ko.pureComputed(function(){return self.response.value()==="Yes"&&self.yes_highlight==="checkmark";});self.should_show_yes_default=ko.pureComputed(function(){return self.response.value()!=="Yes";});self.should_show_no_flag=ko.pureComputed(function(){return self.response.value()==="No"&&self.no_highlight==="flag";});self.should_show_no_stop=ko.pureComputed(function(){return self.response.value()==="No"&&self.no_highlight==="stop";});self.should_show_no_checkmark=ko.pureComputed(function(){return self.response.value()==="No"&&self.no_highlight==="checkmark";});self.should_show_no_default=ko.pureComputed(function(){return self.response.value()!=="No";});}
function are_health_questions_valid(){if(window.vm.should_show_other_insurance_questions()&&window.vm.is_in_person_application()&&general_questions_by_id['existing_insurance'].get_val()===null){return false;}
if(window.vm.should_show_other_insurance_questions()&&(!window.vm.did_select_any_fpp_product()&&general_questions_by_id['replace_insurance'].get_val()!="No")||(window.vm.did_select_any_fpp_product()&&general_questions_by_id['replace_insurance'].get_val()===null)){return false;}
var valid=true;_.each(window.vm.selected_product_health_questions(),function(product_health_questions){_.each(product_health_questions.health_button_rows(),function(health_button_row){_.each(health_button_row.button_groups(),function(button_group){if(button_group.does_applicant_need_to_answer()){if(!button_group.question.does_yes_stop_app()&&button_group.response.value()===null){valid=false;return false;}else if(button_group.question.does_yes_stop_app()&&button_group.response.value()!=="No"){valid=false;return false;}else if(button_group.question.does_no_stop_app()&&button_group.response.value()!=='Yes'){valid=false;return false;}}});if(!valid){return false;}});if(!valid){return false;}});return valid;}
return{HealthButtonRow:HealthButtonRow,ResponseButtonGroup:ResponseButtonGroup,are_health_questions_valid:are_health_questions_valid}})();function QuestionButton(element,val,highlight_func,unhighlight_func){var self=this;self.elements=[$(element)];self.val=val;self.highlight=function(){$.each(self.elements,function(){highlight_func(this);});};self.unhighlight=function(){$.each(self.elements,function(){unhighlight_func(this);});};}
function QuestionButtonGroup(question,is_required){var self=this;self.question=question;self.buttons=[];self.selected_btn=ko.observable(null);self.is_required=is_required;self.get_val=ko.computed(function(){if(self.selected_btn()==null){return false;}else{return self.selected_btn().val;}});self.add_button=function(element,val,high_func,unhigh_func){var btn=null;$.each(self.buttons,function(){if(this.val==val){btn=this;}});if(btn){btn.elements.push(element);}else{self.buttons.push(new QuestionButton(element,val,high_func,unhigh_func));}};self.click_button=function(val){var btn=null;$.each(self.buttons,function(){if(this.val==val){btn=this;}
this.unhighlight();});btn.highlight();self.selected_btn(btn);};}
var general_questions_by_id={};ko.bindingHandlers.flagBtn={init:function(element,value_accessor){var val=ko.unwrap(value_accessor());$(element).addClass("flagBtn").addClass("val_"+val.val);var btn_group;if(val.applicant){var applicant=val.applicant;var product_health_questions=val.product_health_questions;var applicant_coverage=product_health_questions.product_coverage.__get_coverage_for_applicant(applicant);var question_text=val.question.get_question_text();btn_group=null;if(!btn_group){btn_group=new QuestionButtonGroup(val.question,val.is_required);}}else{var group_lookup=general_questions_by_id;if(val.question.get_question_text()in group_lookup){btn_group=group_lookup[val.question.get_question_text()];}else{btn_group=new QuestionButtonGroup(val.question,val.is_required);group_lookup[val.question.get_question_text()]=btn_group;}
if(val.is_selected===true){btn_group.click_button(val.val);}}
btn_group.add_button(element,val.val,function(el){var highlight_type;if(typeof val.highlight==="function"){highlight_type=val.highlight();}else{highlight_type=val.highlight;}
if(highlight_type==="flag"){$(el).prepend('<i class="icon glyphicon glyphicon-flag"></i>').addClass("btn btn-warning");}else if(highlight_type==="checkmark"){$(el).prepend('<i class="icon glyphicon glyphicon-ok"></i>').addClass("btn-success");}else if(highlight_type==="stop"){$(el).prepend('<i class="icon glyphicon glyphicon-remove"></i>').addClass("btn-danger");}},function(el){$(el).removeClass("btn-success btn-warning btn-danger").addClass("btn-default");$(el).find(".glyphicon").remove();});$(element).on("click",function(){btn_group.click_button(val.val);if(val.onclick){val.onclick();}});if(btn_group.selected_btn&&btn_group.selected_btn.val==val.val){btn_group.click_button(val.val);}},update:function(element,value_accessor){}};function handle_existing_insurance_modal(){if(window.vm.did_select_any_fpp_product()){}else{$("#modal_text_existing_warning_title").show();$("#modal_text_replacement_warning_title").hide();$("#modal_text_soh_warning_title").hide();$("#modal_text_existing_warning").show();$("#modal_text_replacement_warning").hide();$("#modal_text_soh_warning").hide();$("#health_modal").modal('show');$("#existing_warning_text").show();}
window.vm.existing_insurance(true);}
function reset_existing_insurance_warning(){window.vm.existing_insurance(false);$("#existing_warning_text_remote").hide();$("#existing_warning_text").hide();}
function handle_replacement_insurance_modal(){if(window.vm.did_select_any_fpp_product()){}else{$("#modal_text_existing_warning_title").hide();$("#modal_text_replacement_warning_title").show();$("#modal_text_soh_warning_title").hide();$("#modal_text_existing_warning").hide();$("#modal_text_existing_warning_remote").hide();$("#modal_text_replacement_warning").show();$("#modal_text_soh_warning").hide();$("#health_modal").modal('show');$("#replacement_warning_text").show();}
window.vm.replacing_insurance(true);}
function reset_replacement_insurance_warning(){$("#replacement_warning_text").hide();window.vm.replacing_insurance(false);}
function handle_question_yes(){$("#modal_text_existing_warning_title").hide();$("#modal_text_replacement_warning_title").hide();$("#modal_text_soh_warning_title").show();$("#modal_text_existing_warning").hide();$("#modal_text_existing_warning_remote").hide();$("#modal_text_replacement_warning").hide();$("#modal_text_soh_warning").show();$("#health_modal").modal('show');}
var health_questions=(function(){'use strict';function ProductHealthQuestions(product_coverage,spouse_questions,all_health_questions,employee_questions,applicant_list,omit_actively_at_work,omit_actively_at_work_observable){var self=this;self.product_coverage=product_coverage;self.applicant_list=applicant_list;self.employee=_.find(applicant_list.applicants(),function(applicant){return applicant.type===wizard_applicant.Applicant.EmployeeType;});self.spouse=_.find(applicant_list.applicants(),function(applicant){return applicant.type===wizard_applicant.Applicant.SpouseType;});self.health_questions=ko.pureComputed(function(){var questions=[];var emp_questions=health_questions.process_employee_question_data(employee_questions,self.product_coverage,self.employee,omit_actively_at_work,omit_actively_at_work_observable);var sp_questions=health_questions.process_spouse_question_data(spouse_questions,self.product_coverage,self.spouse,omit_actively_at_work,omit_actively_at_work_observable);var soh_questions=health_questions.process_health_question_data(all_health_questions,self.product_coverage);$.merge(questions,emp_questions);$.merge(questions,sp_questions);$.merge(questions,soh_questions);return questions;});self.show_yes_dialogue=function(applicant,message){var button_options={remove:{label:"Remove this applicant",className:'btn-danger',callback:function(){var applicant_coverage_options=self.product_coverage.get_coverage_options_for_applicant(applicant);if(applicant.type===wizard_applicant.Applicant.ChildType){self.product_coverage.applicant_list.remove_applicant(applicant);}else{var null_option=_.find(applicant_coverage_options,function(o){return o.face_value===0;});self.product_coverage.__get_coverage_for_applicant(applicant).customized_coverage_option(null_option);}
decline_product_if_no_coverage(self.product_coverage);}},ignore:{label:"Ignore and Continue",className:'btn-default',callback:function(){}}};var product_name=self.product_coverage.format_product_name();message=message||"A \""+self.action_name+"\" response to this question disqualifies this person from obtaining coverage for "+"'"+product_name+"'. You may proceed with this application after removing this individual from the "+"coverage selection before proceeding.";bootbox.dialog({message:message,buttons:button_options});};self.health_button_rows=ko.pureComputed(function(){return _.map(self.health_questions(),function(question){return new health_question_buttons.HealthButtonRow(question,self.product_coverage,self);});});self.do_any_health_questions_need_answering=function(){if(self.health_questions().length==0){return false;}
return _.any(self.health_questions(),function(question){return question.does_any_applicant_need_to_answer();});};self._health_question_responses=[];self.get_applicant_answer_for_question=function(applicant,question){var found_response=_.find(self._health_question_responses,function(response){return response.question===question&&response.applicant===applicant;});if(found_response===undefined){var resp=new HealthQuestionResponse(question,applicant,null);self._health_question_responses.push(resp);return resp;}else{return found_response;}};self.serialize_answers_for_applicant=function(applicant){return _.map(self.health_questions(),function(question){var response=self.get_applicant_answer_for_question(applicant,question);return response.serialize();});};}
function HealthQuestionResponse(question,applicant,initial_response){var self=this;self.question=question;self.applicant=applicant;self.value=ko.observable(initial_response);self.serialize=function(){var answer=null;if(self.question.does_applicant_need_to_answer(self.applicant)){answer=self.value();}else if(self.question.can_applicant_skip_due_to_GI(self.applicant)){answer='GI';}
return{question:self.question.get_question_text(),label:self.question.get_question_label(),is_spouse_only:self.question.is_spouse_only(),answer:answer};};}
function process_applicant_question_data(question_data_by_product,product_coverage,applicant,omit_actively_at_work,actively_at_work_observable){var questions=[];var product_data=product_coverage.product.product_data;var omit_actively_at_work_question=typeof omit_actively_at_work!=='undefined'?!!omit_actively_at_work:false;_.each(question_data_by_product,function(product_questions,product_id){if(product_id==product_data.id){var question_factory;if(product_coverage.product.product_data.is_guaranteed_issue){question_factory=function(question_data){if(question_data.label==='Employee Actively at Work'){return null;}
return new GIHealthQuestion(product_coverage.product,question_data,product_coverage,product_data.gi_criteria,product_data.statement_of_health_bypass_type,product_data.bypassed_soh_questions);};}else{question_factory=function(question_data){if(question_data.label==='Employee Actively at Work'){return null;}
return new StandardHealthQuestion(question_data,product_coverage);}}
questions=_.chain(product_questions).filter(function(question){if(question.label==='Employee Actively at Work'){return!omit_actively_at_work_question;}
return true;}).map(question_factory).value();}});return questions;}
function process_health_question_data(health_question_data_by_product,product_coverage){var questions=[];var product_data=product_coverage.product.product_data;_.each(health_question_data_by_product,function(product_health_questions,product_id){if(product_id==product_data.id){var question_factory;if(product_data.is_guaranteed_issue){question_factory=function(question_data){return new GIHealthQuestion(product_coverage.product,question_data,product_coverage,product_data.gi_criteria,product_data.statement_of_health_bypass_type,product_data.bypassed_soh_questions);};}else if(product_coverage.product.product_type=="Group CI"){question_factory=function(question_data){return new GIHealthQuestion(product_coverage.product,question_data,product_coverage,[{guarantee_issue_amount:10000,applicant_type:'Employee',age_max:null,age_min:null,weight_min:null,weight_max:null,height_min:null,height_max:null},{guarantee_issue_amount:25000,applicant_type:'Child',age_max:null,age_min:null,weight_min:null,weight_max:null,height_min:null,height_max:null}],"selected",[{question_type_label:"5yr Heart"},{question_type_label:"5yr Hypertension / Cholesterol"},{question_type_label:"5yr Lung / Colon"},{question_type_label:"5yr Skin Cancer"},{question_type_label:"5yr HPV/HSV"},{question_type_label:"Abnormal Results"},{question_type_label:"Ever been rejected"}]);};}else{question_factory=function(question_data){return new StandardHealthQuestion(question_data,product_coverage);};}
questions=_.map(product_health_questions,question_factory);}});return questions;}
return{ProductHealthQuestions:ProductHealthQuestions,HealthQuestionResponse:HealthQuestionResponse,process_health_question_data:process_health_question_data,process_spouse_question_data:process_applicant_question_data,process_employee_question_data:process_applicant_question_data};})();var GlobalSOHQuestion=function(question_text){var self=this;self.question_text=question_text;};GlobalSOHQuestion.prototype.get_question_text=function(){return this.question_text;};var NonHealthQuestion=function(question_text){var self=this;self.question_text=question_text;};NonHealthQuestion.prototype.get_question_text=function(){return this.question_text;};function decline_product_if_no_coverage(product_coverage){'use strict';if(!product_coverage.did_select_valid_coverage()){if(window.vm.coverage_vm.has_multiple_products()){product_coverage.did_decline(true);}else{window.vm.did_decline(true);}}
if(window.vm.did_decline_all_products()){window.vm.set_wizard_step(1);}}
var HealthQuestions={Responses:{}};Object.defineProperty(HealthQuestions.Responses,'Yes',{value:'yes'});Object.defineProperty(HealthQuestions.Responses,'No',{value:'no'});var StandardHealthQuestion=function(question,product_coverage){var self=this;self.product_coverage=product_coverage;self.question=question;self.does_employee_need_to_answer=ko.computed(function(){if(self.question.is_spouse_only){return false;}
return self.product_coverage.did_select_employee_coverage();});self.does_spouse_need_to_answer=ko.computed(function(){return self.product_coverage.did_select_spouse_coverage();});self.does_child_need_to_answer=function(child){if(self.question.is_spouse_only){return false;}
return self.product_coverage.did_select_children_coverage();};self.can_employee_skip_due_to_GI=function(){return false};self.can_spouse_skip_due_to_GI=function(){return false};self.can_child_skip_due_to_GI=function(child){return false};self.show_yes_dialogue_employee=function(){return self.show_yes_dialogue();};self.show_yes_dialogue_spouse=function(){return self.show_yes_dialogue();};self.show_yes_dialogue_child=function(child){return self.show_yes_dialogue();};self.show_yes_dialogue=function(applicant,message){if(!self.does_question_stop_app()){return;}
var button_options={remove:{label:"Remove this applicant",className:'btn-danger',callback:function(){var applicant_coverage_options=self.product_coverage.get_coverage_options_for_applicant(applicant);if(applicant.type===wizard_applicant.Applicant.ChildType){self.product_coverage.applicant_list.remove_applicant(applicant);}else{var null_option=_.find(applicant_coverage_options,function(o){return o.face_value===0;});self.product_coverage.__get_coverage_for_applicant(applicant).customized_coverage_option(null_option);}
decline_product_if_no_coverage(self.product_coverage);}},ignore:{label:"Ignore and Continue",className:'btn-default',callback:function(){}}};var product_name=self.product_coverage.format_product_name();message=message||"A \""+self.action_name+"\" response to this question disqualifies this person from obtaining coverage for '"+product_name+"'.";bootbox.dialog({message:message+" You may proceed with this application after removing this individual from the coverage selection before proceeding.",buttons:button_options});};self.does_any_applicant_need_to_answer=ko.pureComputed(function(){return _.any(self.product_coverage.applicant_coverage_selections(),function(app_cov){return self.does_applicant_need_to_answer(app_cov.applicant);});});Object.defineProperty(self,'action_name',{value:HealthQuestions.Responses.Yes,configurable:true});Object.defineProperty(self,'has_static_value',{value:false,configurable:true});};StandardHealthQuestion.prototype.is_spouse_only=function(){return this.question.is_spouse_only;};StandardHealthQuestion.prototype.get_question_text=function(){return this.question.question_text;};StandardHealthQuestion.prototype.get_question_label=function(){return this.question.label;};StandardHealthQuestion.prototype.does_applicant_need_to_answer=function(applicant){if(applicant.type===wizard_applicant.Applicant.EmployeeType){return this.does_employee_need_to_answer();}
if(applicant.type===wizard_applicant.Applicant.SpouseType){return this.does_spouse_need_to_answer();}
if(applicant.type===wizard_applicant.Applicant.ChildType){if(!applicant.applicants){return this.does_child_need_to_answer(applicant);}else{return _.any(applicant.applicants(),function(child){return this.does_child_need_to_answer(child);},this);}}
return false;};StandardHealthQuestion.prototype.can_applicant_skip_due_to_GI=function(applicant){if(applicant.type===wizard_applicant.Applicant.EmployeeType){return this.can_employee_skip_due_to_GI();}else if(applicant.type===wizard_applicant.Applicant.SpouseType){return this.can_spouse_skip_due_to_GI();}else if(applicant.type===wizard_applicant.Applicant.ChildType){return this.can_child_skip_due_to_GI(applicant);}else{console.error("Invalid applicant type "+applicant.type,applicant);}};StandardHealthQuestion.prototype.does_question_stop_app=function(){return this.does_yes_stop_app()||this.does_no_stop_app();};StandardHealthQuestion.prototype.get_yes_highlight=function(){return this.does_yes_stop_app()?'stop':'checkmark';};StandardHealthQuestion.prototype.get_no_highlight=function(){return'checkmark';};StandardHealthQuestion.prototype.does_yes_stop_app=function(){return!this.question.is_ignored;};StandardHealthQuestion.prototype.does_no_stop_app=function(){return this.action_name===HealthQuestions.Responses.No;};var GIHealthQuestion=function(product,question,product_coverage,applicant_criteria,skip_mode,skipped_questions){'use strict';var self=this;self.product=product;self.product_coverage=product_coverage;self.question=question;self.applicant_criteria=applicant_criteria;self.skip_mode=skip_mode;self.skipped_questions=skipped_questions;Object.defineProperty(self,'action_name',{value:HealthQuestions.Responses.Yes,configurable:true});Object.defineProperty(self,'has_static_value',{value:false,configurable:true});self.get_criteria=function(applicant_type){return _.filter(self.applicant_criteria,function(c){return self._clean_criteria_applicant_type(c.applicant_type)===applicant_type;});};self._clean_criteria_applicant_type=function(applicant_type){if(applicant_type==='Employee'){return wizard_applicant.Applicant.EmployeeType;}else if(applicant_type==='Spouse'){return wizard_applicant.Applicant.SpouseType;}else if(applicant_type==='Child'){return wizard_applicant.Applicant.ChildType;}else{return applicant_type;}};self.get_met_gi_criteria_for_employee=ko.computed(function(){var applicant=self.product_coverage.applicant_list.get_employee();var coverage=self.product_coverage.__get_coverage_for_applicant(applicant);var employee_criteria=self.get_criteria(applicant.type);return _.find(employee_criteria,function(criterion){return self.does_applicant_meet_GI_criteria(applicant,coverage,criterion);});});self.has_employee_met_GI_criteria=ko.computed(function(){return self.get_met_gi_criteria_for_employee()!==undefined;});self.get_met_gi_criteria_for_spouse=ko.computed(function(){var applicant=self.product_coverage.applicant_list.get_spouse();var coverage=self.product_coverage.__get_coverage_for_applicant(applicant);var criteria=self.get_criteria(applicant.type);return _.find(criteria,function(criterion){return self.does_applicant_meet_GI_criteria(applicant,coverage,criterion);});});self.has_spouse_met_GI_criteria=ko.computed(function(){return self.get_met_gi_criteria_for_spouse()!==undefined;});self.can_employee_skip_due_to_GI=ko.computed(function(){return self.has_employee_met_GI_criteria()&&self.should_skip_if_GI_criteria_met();});self.can_spouse_skip_due_to_GI=ko.computed(function(){return self.has_spouse_met_GI_criteria()&&self.should_skip_if_GI_criteria_met();});self.get_met_gi_criteria_for_child=function(child_applicant){var criteria=self.get_criteria(child_applicant.type);var children=self.product_coverage.applicant_list.get_children_group();var coverage=self.product_coverage.__get_coverage_for_applicant(children);return _.find(criteria,function(criterion){return self.does_applicant_meet_GI_criteria(child_applicant,coverage,criterion);});};self.has_child_met_GI_criteria=function(child_applicant){return self.get_met_gi_criteria_for_child(child_applicant)!==undefined;};self.show_yes_dialogue_employee=function(){self.show_yes_dialogue(self.product_coverage.applicant_list.get_employee());};self.show_yes_dialogue_spouse=function(){self.show_yes_dialogue(self.product_coverage.applicant_list.get_spouse());};self.show_yes_dialogue_child=function(child){self.show_yes_dialogue(child);};self.get_best_GI_criteria=function(applicant,coverage,criteria){var descendingCriteria=_.sortBy(criteria,function(c){return-c.guarantee_issue_amount;});return _.find(descendingCriteria,function(criterion){return(self.does_applicant_meet_demographic_GI_criteria(applicant,criterion)&&criterion.guarantee_issue_amount<coverage);});};self.show_yes_dialogue=function(applicant,message){if(!self.does_question_stop_app()){return;}
var button_options={remove:{label:"Remove this applicant",className:'btn-danger',callback:function(){var applicant_coverage_options=self.product_coverage.get_coverage_options_for_applicant(applicant);if(applicant.type===wizard_applicant.Applicant.ChildType){self.product_coverage.applicant_list.remove_applicant(applicant);}else{var null_option=_.find(applicant_coverage_options,function(o){return o.face_value===0;});self.product_coverage.__get_coverage_for_applicant(applicant).customized_coverage_option(null_option);}
decline_product_if_no_coverage(self.product_coverage);}},ignore:{label:"Ignore and Continue",className:'btn-default',callback:function(){}}};var display_message;if(should_show_reduce_coverage_option(applicant)){add_reduce_option(applicant,button_options);display_message=create_reduce_dialogue_message(applicant,self.action_name);}else{var product_name=self.product_coverage.format_product_name();message=message||"A \""+self.action_name+"\" response to this question disqualifies this person from obtaining coverage for '"+product_name+"'.";display_message=message+" You may proceed with this application after removing this individual from the coverage selection before proceeding.";}
bootbox.dialog({message:display_message,buttons:button_options});};function create_reduce_dialogue_message(applicant,action_name){var face_amount=format_face_value(get_cumulative_coverage(applicant));var gi_amount=get_reduced_coverage_criteria(applicant).guarantee_issue_amount;var formatted_gi_amount=format_face_value(gi_amount);action_name=typeof action_name!=='undefined'?action_name:'yes';return'A "'+action_name+'" response to this question prohibits this person from obtaining the selected '+face_amount+' of coverage. You may proceed, however, by reducing your coverage to the guaranteed coverage amount of '+formatted_gi_amount+'.'+'<br><br>Alternatively, you may remove this individual from the coverage selection altogether (in Step 1) before proceeding with the rest of the application.';}
function get_cumulative_coverage(applicant){var applicant_coverage=self.product_coverage.__get_coverage_for_applicant(applicant);return applicant_coverage.get_cumulative_coverage_amount();}
function get_reduced_coverage_criteria(applicant){var criteria=self.get_criteria(applicant.type);var coverage_amount=get_cumulative_coverage(applicant);return self.get_best_GI_criteria(applicant,coverage_amount,criteria);}
function should_show_reduce_coverage_option(applicant){if(!self.should_skip_if_GI_criteria_met()){return false;}
if(!get_reduced_coverage_criteria(applicant)){return false;}
if(!find_reduced_coverage_option(applicant)){return false;}
return true;}
function add_reduce_option(applicant,button_options){button_options["reduce"]={label:"Reduce the coverage",className:'btn-success',callback:function(){self.product_coverage.__get_coverage_for_applicant(applicant).customized_coverage_option(find_reduced_coverage_option(applicant));}};}
function find_reduced_coverage_option(applicant){var applicant_coverage_options=self.product_coverage.get_coverage_options_for_applicant(applicant);var applicant_coverage=self.product_coverage.__get_coverage_for_applicant(applicant);var previous_coverage_amount=applicant_coverage.get_previous_coverage_amount();var reduced_gi_criterion=get_reduced_coverage_criteria(applicant);var gi_amount=reduced_gi_criterion.guarantee_issue_amount;var filtered_options=_.filter(applicant_coverage_options,function(o){return o.face_value>0&&(previous_coverage_amount+o.face_value)<=gi_amount;});if(filtered_options.length==0){return null;}
return _.max(filtered_options,function(o){return o.face_value;});}
self.does_employee_need_to_answer=ko.computed(function(){if(!self.product_coverage.did_select_employee_coverage()){return false;}
if(self.can_employee_skip_due_to_GI()){return false;}
if(self.question.is_spouse_only){return false;}
return true;});self.does_spouse_need_to_answer=ko.computed(function(){if(!self.product_coverage.did_select_spouse_coverage()){return false;}
if(self.can_spouse_skip_due_to_GI()){return false;}
return true;});self.can_child_skip_due_to_GI=function(child_applicant){return self.has_child_met_GI_criteria(child_applicant)&&self.should_skip_if_GI_criteria_met();};self.does_child_need_to_answer=function(child_applicant){if(!self.product_coverage.did_select_children_coverage()){return false;}
if(self.can_child_skip_due_to_GI(child_applicant)){return false;}
if(self.question.is_spouse_only){return false;}
return true;};self.does_any_applicant_need_to_answer=ko.computed(function(){return _.any(self.product_coverage.applicant_coverage_selections(),function(app_cov){return self.does_applicant_need_to_answer(app_cov.applicant);});});};GIHealthQuestion.prototype=Object.create(StandardHealthQuestion.prototype);GIHealthQuestion.prototype.does_applicant_meet_GI_criteria=function(applicant,coverage,criterion){return(this.does_applicant_meet_coverage_GI_criteria(applicant,coverage,criterion)&&this.does_applicant_meet_demographic_GI_criteria(applicant,criterion));};GIHealthQuestion.prototype.does_applicant_meet_coverage_GI_criteria=function(applicant,applicant_coverage,criterion){var self=this;return applicant_coverage.get_cumulative_coverage_amount()<=criterion.guarantee_issue_amount;};GIHealthQuestion.prototype.does_applicant_meet_demographic_GI_criteria=function(applicant,criterion){var does_meet=true;if(criterion.age_max!==null){does_meet&=applicant.get_age()<=criterion.age_max;}
if(criterion.age_min!==null){does_meet&=applicant.get_age()>=criterion.age_min;}
if(criterion.height_max!==null){does_meet&=applicant.height()!==null&&applicant.height()<=criterion.height_max}
if(criterion.height_min!==null){does_meet&=applicant.height()!==null&&applicant.height()>=criterion.height_min;}
if(criterion.weight_max!==null){does_meet&=applicant.weight()!==null&&applicant.weight()<=criterion.weight_max}
if(criterion.weight_min!==null){does_meet&=applicant.weight()!==null&&applicant.weight()>=criterion.weight_min;}
return does_meet;};GIHealthQuestion.prototype.should_skip_if_GI_criteria_met=function(){var self=this;if(self.skip_mode=="all"){return true;}else{return _.any(self.skipped_questions,function(q){return self.get_question_label()==q.question_type_label});}};GIHealthQuestion.prototype.does_yes_stop_app=function(){var self=this;if(self.question.is_ignored){return false;}
return true;};function ActivelyAtWorkHealthQuestion(question,product_coverage,employee,actively_at_work_observable){"use strict";var self=this;StandardHealthQuestion.call(self,question,product_coverage);self.employee=employee;self.value=actively_at_work_observable||ko.observable(null);Object.defineProperty(self,'action_name',{value:HealthQuestions.Responses.No});Object.defineProperty(self,'has_static_value',{value:true});self.does_spouse_need_to_answer=function(){return false;};self.does_child_need_to_answer=function(){return false;};}
ActivelyAtWorkHealthQuestion.prototype=Object.create(StandardHealthQuestion.prototype);ActivelyAtWorkHealthQuestion.prototype.get_question_text=function(){return'Is '+this.employee.first()+' <a href="#actively_at_work_modal" data-toggle="modal">actively at work?</a>';};ActivelyAtWorkHealthQuestion.prototype.get_yes_highlight=function(){return'checkmark';};ActivelyAtWorkHealthQuestion.prototype.get_no_highlight=function(){return'stop';};ActivelyAtWorkHealthQuestion.prototype.does_yes_stop_app=function(){return false;};function ActivelyAtWorkGiHealthQuestion(product,question,product_coverage,applicant_criteria,skip_mode,skipped_questions,employee,actively_at_work_observable){'use strict';var self=this;GIHealthQuestion.call(self,product,question,product_coverage,applicant_criteria,skip_mode,skipped_questions);self.employee=employee;self.value=actively_at_work_observable||ko.observable(null);Object.defineProperty(self,'action_name',{value:HealthQuestions.Responses.No});Object.defineProperty(self,'has_static_value',{value:true});self.does_spouse_need_to_answer=function(){return false;};self.does_child_need_to_answer=function(){return false;};}
ActivelyAtWorkGiHealthQuestion.prototype=Object.create(GIHealthQuestion.prototype);ActivelyAtWorkGiHealthQuestion.prototype.get_question_text=function(){return'Is '+this.employee.first()+' <a href="#actively_at_work_modal" data-toggle="modal">actively at work?</a>';};ActivelyAtWorkGiHealthQuestion.prototype.get_yes_highlight=function(){return'checkmark';};ActivelyAtWorkGiHealthQuestion.prototype.get_no_highlight=function(){return'stop';};ActivelyAtWorkGiHealthQuestion.prototype.does_yes_stop_app=function(){return false;};function HealthQuestionAnswer(question,button_group,question_object){var self=this;self.question=question;self.question_object=question_object;self.button_group=ko.observable(null);self.answer=ko.computed(function(){if(self.button_group()==null){return null;}else{return self.button_group().get_val();}});self.serialize=function(){var answer;if(self.button_group()){answer=(self.button_group().is_required())?self.button_group().get_val():"GI";}else{answer=null;}
return{question:self.question.question_text,label:self.question.label,is_spouse_only:self.question.is_spouse_only||false,answer:answer}};}
var enrollment_wizard=(function(){return{init:function(data){console.log("init with args: ",arguments);var ui=new wizard_viewmodel.WizardUI(data);window.ui=ui;ko.applyBindings(ui);init_validation();}};})();var payment_mode_module=(function(){function PaymentMode(options){this.frequency=options.frequency;this.label=options.label;}
PaymentMode.prototype={serialize:function(){return this.frequency;},display_lowercase:function(){return this.label.toLowerCase();},display:function(){return this.label;}};var FREQUENCY_LABELS={12:'Monthly',24:'Semimonthly',26:'Biweekly',52:'Weekly'};return{create_payment_mode:function(options){return new PaymentMode(options);},create_payment_mode_by_frequency:function(frequency){var options={frequency:frequency,label:FREQUENCY_LABELS[frequency]};return new PaymentMode(options);},select_initial_payment_mode:function(case_data,payment_modes){var initial_payment_mode=null;if(case_data&&case_data.payment_mode>=0){initial_payment_mode=_.find(payment_modes,function(pm){return pm.frequency===case_data.payment_mode;});if(initial_payment_mode===undefined){initial_payment_mode=null;}}
return initial_payment_mode;},can_change_payment_mode:function(case_data){return(case_data.payment_mode===-1||!case_data.payment_mode);}}})();var product_rates_service=(function(){var is_loading_rates=ko.observable(false);function ProductRatesVM(product){this.product=product;this.rates=ko.observableArray([]);this.recommendations=ko.observableArray([]);this.employee_options=ko.pureComputed(this._get_employee_options,this);this.spouse_options=ko.pureComputed(this._get_spouse_options,this);this.children_options=ko.pureComputed(this._get_children_options,this);this.applicant_coverage_options={};this.applicant_coverage_options[wizard_applicant.Applicant.EmployeeType]=this.employee_options;this.applicant_coverage_options[wizard_applicant.Applicant.SpouseType]=this.spouse_options;this.applicant_coverage_options[wizard_applicant.Applicant.ChildType]=this.children_options;}
ProductRatesVM.prototype={update_rates_data:function(rates_data){this.update_product_rates(rates_data);this.update_recommendations(rates_data);},update_product_rates:function(rates_data){this.rates(this.get_coverage_options_from_api_data(rates_data));},get_coverage_options_from_api_data:function(rates_data){var rates=[];rates=$.merge(rates,this.create_coverage_options_for_applicant(wizard_applicant.Applicant.EmployeeType,rates_data.employee_rates));rates=$.merge(rates,this.create_coverage_options_for_applicant(wizard_applicant.Applicant.SpouseType,rates_data.spouse_rates));rates=$.merge(rates,this.create_coverage_options_for_applicant(wizard_applicant.Applicant.ChildType,rates_data.children_rates));return rates;},create_coverage_options_for_applicant:function(applicant_type,applicant_rates_data){var options=[];if(applicant_rates_data&&applicant_rates_data.bypremium){options=$.merge(options,this.create_coverage_options(false,applicant_type,applicant_rates_data.bypremium));}
if(applicant_rates_data&&applicant_rates_data.byface){options=$.merge(options,this.create_coverage_options(true,applicant_type,applicant_rates_data.byface));}
if(applicant_rates_data&&applicant_rates_data.bytier){options=$.merge(options,this.create_coverage_options(false,applicant_type,applicant_rates_data.bytier));}
return options;},get_rate_for_coverage_tier:function(coverage_tier){var rates=this.rates();return _.find(rates,function(rate){return rate.coverage_tier&&rate.coverage_tier===coverage_tier;});},create_coverage_options:function(is_by_face,applicant_type,rate_options){return _.map(rate_options,function(data){var key_count=_.size(data);return this.product.create_coverage_option({applicant_type:applicant_type,is_by_face:is_by_face,face_value:data.coverage,coverage_tier:data.coverage_tier,premium:data.premium,payment_mode:function(){return payment_mode_module.create_payment_mode_by_frequency(data.payment_mode)}.bind(this)});},this);},update_recommendations:function(rates_data){if(rates_data.recommendations){this.recommendations(this.process_recommendations(rates_data.recommendations));}},process_recommendations:function(recommendations){var processed_recommendations=[];_.each(recommendations,function(rec_data){var emp_option=this.find_applicant_coverage_option(wizard_applicant.Applicant.EmployeeType,rec_data.coverages.employee);var sp_option=this.find_applicant_coverage_option(wizard_applicant.Applicant.SpouseType,rec_data.coverages.spouse);var ch_option=this.find_applicant_coverage_option(wizard_applicant.Applicant.ChildType,rec_data.coverages.children);processed_recommendations.push(new RecommendationSet(rec_data.name,[new Recommendation(rec_data.name,wizard_applicant.Applicant.EmployeeType,emp_option,this.product),new Recommendation(rec_data.name,wizard_applicant.Applicant.SpouseType,sp_option,this.product),new Recommendation(rec_data.name,wizard_applicant.Applicant.ChildType,ch_option,this.product)]));},this);return processed_recommendations;},find_applicant_coverage_option:function(applicant_type,coverage_amount){if(!coverage_amount){return null_coverage;}
var all_options=this._get_all_options_by_applicant_type(applicant_type);var option=_.find(all_options,function(opt){return opt.face_value===parseInt(coverage_amount);});if(option){return option;}else{return null_coverage;}},get_coverage_options_observable_for_applicant:function(applicant){return this.applicant_coverage_options[applicant.type];},_get_employee_options:function(){return this._get_applicant_type_options(wizard_applicant.Applicant.EmployeeType);},_get_spouse_options:function(){return this._get_applicant_type_options(wizard_applicant.Applicant.SpouseType);},_get_children_options:function(){return this._get_applicant_type_options(wizard_applicant.Applicant.ChildType);},_get_applicant_type_options:function(applicant_type){if(this.product.does_override_rate_options(applicant_type)){var all_options=this._get_all_options_by_applicant_type(applicant_type);return this.product.filter_coverage_options_for_applicant_type(all_options,applicant_type);}
return this._get_all_options_by_applicant_type(applicant_type);},_get_all_options_by_applicant_type:function(applicant_type){return _.select(this.rates(),function(option){return option.applicant_type===applicant_type;});}};var rates_by_product_id={};function update_product_rates(products,payment_mode,applicant_list,error_callback,statecode,coverage_vm,classification_mappings,occupation){is_loading_rates(true);var requests=_.map(products,function(product){var enabled_riders=coverage_vm.get_enabled_riders_for_product(product);var data=_build_rate_parameters(payment_mode,applicant_list,statecode,enabled_riders,product,classification_mappings,occupation);var request=remote_service.get_product_rates(product.product_data.id,data);request.product_id=product.product_data.id;return request;});function process_product_rates(){var product_rate_response;for(var i=0;i<products.length;i++){if(products.length===1){product_rate_response=arguments[0];}else{product_rate_response=arguments[i][0];}
var product_rates=product_rate_response.data;var product=_.find(products,function(p){return p.product_data.id===product_rates.product_id;},this);var product_rates_viewmodel=get_or_create_product_rates_viewmodel(product);product_rates_viewmodel.update_rates_data(product_rates);}
is_loading_rates(false);}
$.when.apply($,requests).done(process_product_rates).fail(error_callback);}
function _build_rate_parameters(payment_mode,applicant_list,statecode,enabled_riders,product,occupation_mappings,occupation){var params={payment_mode:payment_mode.frequency,statecode:statecode,rider_codes:_.pluck(enabled_riders,"code")};if(product&&product.requires_occupation()&&occupation_mappings&&occupation){params.rate_level=occupation_mappings[product.product_data.id][occupation];}
return $.extend({},params,_build_applicant_parameters(applicant_list));}
function _build_applicant_parameters(applicant_list){return{employee:applicant_list.get_employee().serialize_data(),spouse:(applicant_list.has_valid_spouse())?applicant_list.get_spouse().serialize_data():null};}
function get_or_create_product_rates_viewmodel(product){var rates_vm;if(!(product.product_data.id in rates_by_product_id)){rates_vm=new ProductRatesVM(product);rates_by_product_id[product.product_data.id]=rates_vm;}else{rates_vm=rates_by_product_id[product.product_data.id];}
return rates_vm;}
function get_product_recommendations(product){var rates=get_or_create_product_rates_viewmodel(product);return rates.recommendations;}
function get_product_coverage_options_for_applicant(product,applicant){var rates=get_or_create_product_rates_viewmodel(product);return rates.get_coverage_options_observable_for_applicant(applicant);}
function get_product_rate_for_coverage_tier(product,coverage_tier){var rates=get_or_create_product_rates_viewmodel(product);return rates.get_rate_for_coverage_tier(coverage_tier);}
return{update_product_rates:update_product_rates,is_loading_rates:is_loading_rates,get_product_coverage_options_for_applicant:get_product_coverage_options_for_applicant,get_product_recommendations:get_product_recommendations,get_product_rate_for_coverage_tier:get_product_rate_for_coverage_tier};})();var wizard_products=(function(){function build_products(root,products){'use strict';if(products.length===0){alert("Error: No products to enroll.");return null;}
var product_objects=_.map(products,function(product){return build_product(root,product);});return _.filter(product_objects,function(product){return product!==null;});}
function build_product(root,product_data){var base_type=product_data.base_product_type;var base_product;if(base_type==="FPPTI"){base_product=new FPPTIProduct(product_data);}else if(base_type==="FPPCI"){base_product=new FPPCIProduct(product_data);}else if(base_type==="Group CI"){base_product=new GroupCIProduct(root,product_data);}else if(base_type==="FPP-Gov"){base_product=new FPPGovProduct(product_data);}else if(base_type==="ACC"){base_product=new ACCProduct(product_data);}else if(base_type==='HI'){base_product=new HIProduct(product_data);}else{alert("Invalid product type '"+base_type+"'");base_product=new FPPTIProduct(product_data);}
return base_product;}
function Product(){}
Product.prototype={min_emp_age:function(){return 18;},max_emp_age:function(){return 70;},min_sp_age:function(){return 18;},max_sp_age:function(){return 70;},min_child_age:function(){return 0;},max_child_age:function(){return 23;},is_valid_employee:function(employee){var age=employee.get_age();return(age>=this.min_emp_age()&&age<=this.max_emp_age());},is_valid_spouse:function(spouse){var age=spouse.get_age();return(age>=this.min_sp_age()&&age<=this.max_sp_age());},is_valid_child:function(child){var age=child.get_age();return(age>=this.min_child_age()&&age<=this.max_child_age());},create_coverage_option:function(options){return new CoverageOption(options);},requires_gender:function(){return false;},requires_height:function(){return false;},requires_weight:function(){return false;},requires_is_smoker:function(){return false;},has_simple_coverage:function(){return false;},has_critical_illness_coverages:function(){return false;},get_maximum_coverage_amount:function(applicant){var options=product_rates_service.get_product_coverage_options_for_applicant(this,applicant)();if(options.length>0){return _.max(_.pluck(options,"face_value"));}
return 0;},does_override_rate_options:function(){return false;},should_show_other_insurance_questions:function(){return this.is_fpp_product();},should_show_step_two:function(){return true;},should_show_step_four:function(){return true;},should_show_step_5:function(){return true;},should_use_date_of_hire_for_identity:function(){return true;},is_fpp_product:function(){return true;},should_confirm_disclosure_notice:function(){return this.is_fpp_product();},should_confirm_payroll_deduction:function(){return this.is_fpp_product();},should_show_contingent_beneficiary:function(){return this.is_fpp_product();},get_replacement_paragraphs:function(){return[];},does_use_recommended_coverage_table:function(){return true;},get_occupations:function(){return[];},requires_occupation:function(){return false;},get_coverage_tiers:function(){return[];},requires_additional_information:function(){return this.requires_gender()||this.requires_height()||this.requires_weight()||this.requires_is_smoker();}};function ApplicantSelectionProduct(product_data){this.product_type=product_data.base_product_type;this.product_data=product_data;}
ApplicantSelectionProduct.prototype={does_use_recommended_coverage_table:function(){return false;}};function FPPTIProduct(product_data){this.product_type="FPPTI";this.product_data=product_data;}
FPPTIProduct.prototype=Object.create(Product.prototype);FPPTIProduct.prototype.get_replacement_paragraphs=function(){return this.product_data.replacement_paragraphs;};function FPPCIProduct(product_data){this.product_type="FPPCI";this.product_data=product_data;}
FPPCIProduct.prototype=Object.create(Product.prototype);FPPCIProduct.prototype.create_coverage_option=function(options){return new CICoverageOption(new CoverageOption(options));};FPPCIProduct.prototype.has_critical_illness_coverages=function(){return true;};FPPCIProduct.prototype.get_replacement_paragraphs=function(){return this.product_data.replacement_paragraphs;};function GroupCIProduct(root,product_data){var self=this;self.root=root;self.product_type="Group CI";self.product_data=product_data;self.employee_current_benefit_subscription=null;self.spouse_options_for_demographics=ko.observableArray([]);self.all_spouse_rate_options=ko.observableArray([]);self.all_posible_children_options=ko.observableArray([]);self.all_coverage_options={employee:ko.observableArray([]),spouse:ko.observableArray([]),children:ko.observableArray([])};self.does_override_rate_options=function(applicant_type){return(applicant_type===wizard_applicant.Applicant.EmployeeType||applicant_type===wizard_applicant.Applicant.SpouseType);};self.filter_coverage_options_for_applicant_type=function(all_options,applicant_type){if(applicant_type===wizard_applicant.Applicant.EmployeeType){return self.filter_employee_coverage_options(all_options);}else if(applicant_type===wizard_applicant.Applicant.SpouseType){return self.filter_spouse_coverage_options(all_options);}else{return self.filter_children_coverage_options(all_options);}};self.filter_employee_coverage_options=function(all_options){return self.filter_base_rate_options(all_options);};function get_employee_total_cumulative_coverage(){var emp_coverage_option=window.vm.coverage_vm.get_applicant_coverage_option_for_product(window.vm.employee(),self);var emp_existing_coverage_amount=window.vm.employee().get_existing_coverage_amount_for_product(self);var emp_current_coverage_amount=(emp_coverage_option.is_valid()?emp_coverage_option.face_value:0);return emp_existing_coverage_amount+emp_current_coverage_amount;}
function has_employee_selected_coverage(){var applicant_coverage=window.vm.coverage_vm.get_applicant_coverage_for_product(window.vm.employee(),self);return applicant_coverage.has_selected_coverage();}
function has_employee_answered_required_question_yes(){return false;}
self.filter_spouse_coverage_options=function(all_options){var base_options=self.filter_base_rate_options(all_options);if(!has_employee_selected_coverage()||has_employee_answered_required_question_yes()){return _.filter(base_options,function(o){return o.face_value<=25000;});}else{var limit=_.min([get_employee_total_cumulative_coverage()/2.0,25000]);var valid_options=_.filter(base_options,function(o){return o.face_value<=limit});self.append_halfway_coverage_option_if_needed(valid_options,limit,all_options);return valid_options;}};self.append_halfway_coverage_option_if_needed=function(valid_options,max_coverage_limit,all_options){if(valid_options.length&&valid_options[valid_options.length-1].face_value<max_coverage_limit){var half_opt=_.find(all_options,function(o){return o.face_value===max_coverage_limit});if(half_opt){valid_options.push(half_opt);}}};self.filter_children_coverage_options=function(all_options){var base_options=self.filter_base_rate_options(all_options);if(!has_employee_selected_coverage()||has_employee_answered_required_question_yes()){return _.filter(base_options,function(o){return o.face_value<=10000;});}else{var limit=_.min([get_employee_total_cumulative_coverage()/2.0,10000]);return _.filter(base_options,function(o){return o.face_value<=limit});}};self.filter_base_rate_options=function(all_options){return _.filter(all_options,function(o){return o.face_value%5000===0;});};}
GroupCIProduct.prototype=Object.create(Product.prototype);GroupCIProduct.prototype.is_valid_employee=function(employee){var age=employee.get_age();var valid=(age>=this.min_emp_age()&&age<=this.max_emp_age());valid&=employee.is_smoker()!=null;valid&=employee.has_valid_weight();valid&=employee.has_valid_height();valid&=employee.has_valid_gender();return valid;};GroupCIProduct.prototype.is_valid_spouse=function(spouse){var age=spouse.get_age();var valid=(age>=this.min_sp_age()&&age<=this.max_sp_age());valid&=spouse.is_smoker()!=null;valid&=spouse.has_valid_weight();valid&=spouse.has_valid_height();valid&=spouse.has_valid_gender();return valid;};GroupCIProduct.prototype.requires_gender=function(){return true;};GroupCIProduct.prototype.requires_height=function(){return true;};GroupCIProduct.prototype.requires_weight=function(){return true;};GroupCIProduct.prototype.requires_is_smoker=function(){return true;};GroupCIProduct.prototype.has_critical_illness_coverages=function(){return true;};GroupCIProduct.prototype.should_show_step_5=function(){return false;};GroupCIProduct.prototype.should_use_date_of_hire_for_identity=function(){return false;};GroupCIProduct.prototype.is_fpp_product=function(){return false;};function FPPGovProduct(product_data){this.product_type="FPP-Gov";this.product_data=product_data;}
FPPGovProduct.prototype=Object.create(Product.prototype);FPPGovProduct.prototype.requires_gender=function(){return false;};FPPGovProduct.prototype.requires_height=function(){return false;};FPPGovProduct.prototype.requires_weight=function(){return false;};FPPGovProduct.prototype.requires_is_smoker=function(){return false;};FPPGovProduct.prototype.has_critical_illness_coverages=function(){return false;};FPPGovProduct.prototype.get_replacement_paragraphs=function(){return this.product_data.replacement_paragraphs;};function HIProduct(product_data){this.product_type="HI";this.product_data=product_data;}
HIProduct.prototype=Object.create(Product.prototype);HIProduct.prototype.requires_gender=function(){return false;};HIProduct.prototype.requires_height=function(){return false;};HIProduct.prototype.requires_weight=function(){return false;};HIProduct.prototype.requires_is_smoker=function(){return false;};HIProduct.prototype.has_critical_illness_coverages=function(){return false;};HIProduct.prototype.has_critical_illness_coverages=function(){return false;};HIProduct.prototype.has_simple_coverage=function(){return true;};HIProduct.prototype.requires_occupation=function(){return true;};HIProduct.prototype.get_coverage_tiers=function(applicant_types){var hi_coverage_tiers=['EE','ES','EC','EF'];if(Array.isArray(applicant_types)){if(!_.any(applicant_types,function(applicant_type){return applicant_type===wizard_applicant.Applicant.SpouseType})){_.remove(hi_coverage_tiers,function(tier){return tier==='ES'||tier==='EF';})}
if(!_.any(applicant_types,function(applicant_type){return applicant_type===wizard_applicant.Applicant.ChildType;})){_.remove(hi_coverage_tiers,function(tier){return tier==='EC'||tier==='EF';})}}
return hi_coverage_tiers;};HIProduct.prototype.create_coverage_option=function(options){return new SimpleCoverageOption(options);};HIProduct.prototype.is_fpp_product=function(){return false;};HIProduct.prototype.should_show_step_two=function(){return false;};HIProduct.prototype.should_show_step_four=function(){return false;};HIProduct.prototype.should_show_step_5=function(){return false;};function ACCProduct(product_data){this.product_type="ACC";this.product_data=product_data;}
ACCProduct.prototype=Object.create(Product.prototype);ACCProduct.prototype.has_simple_coverage=function(){return true;};ACCProduct.prototype.get_occupations=function(){return['Management','Worker','Secretary'];};ACCProduct.prototype.requires_occupation=function(){return true;};ACCProduct.prototype.get_coverage_tiers=function(applicant_types){var acc_coverage_tiers=['EE','ES','EC','EF'];if(Array.isArray(applicant_types)){if(!_.any(applicant_types,function(applicant_type){return applicant_type===wizard_applicant.Applicant.SpouseType})){_.remove(acc_coverage_tiers,function(tier){return tier==='ES'||tier==='EF';})}
if(!_.any(applicant_types,function(applicant_type){return applicant_type===wizard_applicant.Applicant.ChildType;})){_.remove(acc_coverage_tiers,function(tier){return tier==='EC'||tier==='EF';})}}
return acc_coverage_tiers;};ACCProduct.prototype.create_coverage_option=function(options){return new SimpleCoverageOption(options);};ACCProduct.prototype.is_fpp_product=function(){return false;};ACCProduct.prototype.should_show_step_two=function(){return false;};ACCProduct.prototype.should_show_step_four=function(){return false;};return{build_products:build_products};})();function RecommendationSet(name,recommendations){var self=this;self.name=name;self.recommendations=recommendations;self.get_applicant_recommendation=function(applicant_type){return _.find(self.recommendations,function(rec){return rec.applicant_type===applicant_type;})};self.get_recommended_applicant_coverage=function(applicant_type){var rec=self.get_applicant_recommendation(applicant_type);if(!rec){return null_coverage;}
return rec.recommended_coverage;};self.formatted_payment_mode=function(){if(self.recommendations.length===0){return"";}
if(!_.any(_.invoke(self.recommendations,"is_valid"))){return"";}
var valid_recommendation=_.find(self.recommendations,function(rec){return rec.is_valid()});return valid_recommendation.recommended_coverage.payment_mode().display_lowercase();};self.formatted_total_premium=function(){return format_premium_value(self.get_total_premium());};self.get_total_premium=function(){var total=0.0;if(vm.employee().is_valid()){total+=self.get_applicant_recommendation(wizard_applicant.Applicant.EmployeeType).get_total_premium();}
if(vm.should_include_spouse_in_table()){total+=self.get_applicant_recommendation(wizard_applicant.Applicant.SpouseType).get_total_premium();}
if(vm.should_include_children()){total+=self.get_applicant_recommendation(wizard_applicant.Applicant.ChildType).get_total_premium();}
return total;};}
function Recommendation(name,applicant_type,coverage_option,product){var self=this;self.name=name;self.applicant_type=applicant_type;self.recommended_coverage=coverage_option;self.product=product;self.is_valid=function(){return self.recommended_coverage.is_valid();};self.get_total_premium=function(){if(self.product.is_fpp_product()&&self.applicant_type===wizard_applicant.Applicant.ChildType){return self.recommended_coverage.premium*window.vm.coverage_vm.applicants.get_valid_children().length;}
return self.recommended_coverage.premium;};self.format_total_premium=function(){if(!self.recommended_coverage.is_valid()){return"";}
return format_premium_value(self.get_total_premium());};self.format_premium_option=function(){return self.recommended_coverage.format_premium_option()};self.format_coverage=function(){return self.recommended_coverage.format_face_value();};}
function NullRecommendation(name){var self=this;self.name=name;self.recommended_coverage=new NullCoverageOption();self.is_valid=function(){return false;};self.get_total_premium=function(){return 0.0;};self.format_premium_option=function(){return"";};self.format_total_premium=function(){return"";};self.format_coverage=function(){return"";};}
var remote_service=(function(){function get_product_rates(product_id,data){return $.ajax({url:"/products/"+product_id+"/rates",dataType:"json",method:"POST",contentType:"application/json; charset=utf-8",processData:false,data:JSON.stringify(data)});}
return{get_product_rates:get_product_rates};})();function ReplacementPolicy(){var self=this;self.name=ko.observable('');self.policy_number=ko.observable('');self.insured=ko.observable('');self.replaced_or_financing=ko.observable(null);self.replacement_reason=ko.observable("");self.serialize=function(){return{name:self.name(),policy_number:self.policy_number(),insured:self.insured(),replaced_or_financing:self.replaced_or_financing(),replacement_reason:self.replacement_reason()};};}
function submit_application(){window.vm.is_submitting(true);window.vm.submission_error("");var results=_.map(window.vm.coverage_vm.selected_product_coverages(),function(product_cov){return build_wizard_results_for_product_coverage(product_cov);});var please_wait_dialogue=bootbox.dialog({message:"Preparing application for submission. Please wait, this make take a minute...",buttons:{}});_send_wizard_results(results);}
var POLL_WAIT=5000;var MAX_POLL_COUNT=25;var poll_count=0;function _send_wizard_results(wizard_results){ajax_post("/submit-wizard-data",{"wizard_results":wizard_results},function(resp){if(resp.error){window.vm.is_submitting(false);bootbox.dialog({message:"There was a problem generating the application form ("+resp.error+").  Please contact the enrollment system administrator.",buttons:{"success":{"label":"OK","className":"btn-sm btn-primary"}}});}else if(resp.redirect_url){window.location.href=resp.redirect_url}else{setTimeout(function(){poll_envelope_result(resp.poll_url,wizard_results);},POLL_WAIT);}},function(req){window.vm.is_submitting(false);handle_error_and_retry(req,wizard_results);},true);}
function poll_envelope_result(url,wizard_results){poll_count+=1;if(poll_count>MAX_POLL_COUNT){alert("Sorry, an error occurred generating the signature page. Please check your Agent Inbox to sign this application.");window.location.href=urls.get_manage_case_url(window.vm.options.case_data.id)+'#enrollment';}
$.get(url).success(function(resp){if(resp.status==='ready'||resp.status==='declined'){window.location.href=resp.redirect_url;}else{setTimeout(function(){poll_envelope_result(url,wizard_results);},POLL_WAIT);}}).error(function(resp){handle_error_and_retry(resp,wizard_results)})}
function handle_error_and_retry(resp,wizard_results){handle_remote_error_with_retry(resp,function retry_callback(success){if(success){_send_wizard_results(wizard_results);}});}
var SUBMISSION_RETRIES_ALLOWED=3;var submission_retry_count=0;function handle_remote_error_with_retry(response,retry_callback){window.vm.is_submitting(false);if(response.status===401){}else if(response.status===503){alert("Sorry, an error occurred communicating with the server. Please check your Agent Inbox to sign this application.");window.location=urls.get_manage_case_url(window.vm.options.case_data.id)+'#enrollment';}else if(response.status===500){alert("Sorry, the server encountered an error processing this request.");}else{alert("Sorry, an error occurred communicating with the server. Please check your connection to the internet and try again.");}}
function build_wizard_results_for_product_coverage(product_cov){var root=window.vm;var health_questions=vm.get_product_health_questions(product_cov);var did_decline=(root.coverage_vm.has_multiple_products())?product_cov.did_decline():root.did_decline();var occupation=Array.isArray(root.selected_occupation())?root.selected_occupation()[0].label:undefined;var wizard_results={product_id:product_cov.product.product_data.id,case_id:root.enrollment_case.id,enrollCity:root.enrollCity(),enrollState:root.enrollState(),payment_mode:root.coverage_vm.payment_mode().frequency,payment_mode_text:root.coverage_vm.payment_mode().label,occupation_class:occupation,method:(root.is_in_person_application())?'in_person':'self_enroll_email',did_decline:did_decline,identityToken:root.identityToken(),identityType:root.identityType(),employee:root.employee().serialize_data(),spouse:root.spouse().serialize_data(),is_spouse_address_same_as_employee:root.is_spouse_address_same_as_employee(),is_spouse_email_same_as_employee:root.is_spouse_email_same_as_employee(),employee_owner:product_cov.policy_owner(),employee_other_owner_name:product_cov.other_owner_name(),employee_other_owner_ssn:product_cov.other_owner_ssn(),spouse_owner:product_cov.spouse_policy_owner(),spouse_other_owner_name:product_cov.spouse_other_owner_name(),spouse_other_owner_ssn:product_cov.spouse_other_owner_ssn(),employee_beneficiary:product_cov.employee_beneficiary_type(),spouse_beneficiary:product_cov.spouse_beneficiary_type(),employee_contingent_beneficiary_type:product_cov.employee_contingent_beneficiary_type(),employee_contingent_beneficiary:product_cov.employee_contingent_beneficiary().serialize(),employee_beneficiary_name:product_cov.employee_other_beneficiary().name(),employee_beneficiary_relationship:product_cov.employee_other_beneficiary().relationship(),employee_beneficiary_ssn:product_cov.employee_other_beneficiary().ssn(),employee_beneficiary_dob:product_cov.employee_other_beneficiary().date_of_birth(),spouse_beneficiary_name:product_cov.spouse_other_beneficiary().name(),spouse_beneficiary_relationship:product_cov.spouse_other_beneficiary().relationship(),spouse_beneficiary_ssn:product_cov.spouse_other_beneficiary().ssn(),spouse_beneficiary_dob:product_cov.spouse_other_beneficiary().date_of_birth(),spouse_contingent_beneficiary_type:product_cov.spouse_contingent_beneficiary_type(),spouse_contingent_beneficiary:product_cov.spouse_contingent_beneficiary().serialize()};wizard_results.children=[];_.each(product_cov.get_covered_children(),function(child){wizard_results['children'].push(child.serialize_data());});if(did_decline){return wizard_results;}
wizard_results=$.extend({},wizard_results,{existing_insurance:root.existing_insurance(),replacing_insurance:root.replacing_insurance(),is_employee_actively_at_work:root.is_employee_actively_at_work(),has_spouse_been_treated_6_months:product_cov.has_spouse_been_treated_6_months(),has_spouse_been_disabled_6_months:product_cov.has_spouse_been_disabled_6_months(),});if(health_questions){wizard_results.employee_soh_questions=health_questions.serialize_answers_for_applicant(vm.employee());wizard_results.spouse_soh_questions=health_questions.serialize_answers_for_applicant(vm.spouse());}
if(!root.should_include_spouse_in_table()){wizard_results.employee_beneficiary="other";}
var emp_coverage=product_cov.__get_coverage_for_applicant(root.employee());if(emp_coverage.coverage_option().is_valid()){wizard_results['employee_coverage']=emp_coverage.coverage_option().serialize_data();}else{wizard_results['employee_coverage']=""}
var sp_benefit=product_cov.__get_coverage_for_applicant(root.spouse());if(sp_benefit.coverage_option().is_valid()){wizard_results['spouse_coverage']=sp_benefit.coverage_option().serialize_data();}else{wizard_results['spouse_coverage']=""}
wizard_results['child_coverages']=[];wizard_results['children_soh_questions']=[];_.each(product_cov.get_covered_children(),function(child){var coverage=product_cov.__get_coverage_for_applicant(child);wizard_results['child_coverages'].push(coverage.coverage_option().serialize_data());if(health_questions){var soh_questions=health_questions.serialize_answers_for_applicant(child);wizard_results['children_soh_questions'].push(soh_questions);}});wizard_results.replacement_read_aloud=root.replacement_read_aloud();wizard_results.replacement_is_terminating=root.replacement_is_terminating();wizard_results.replacement_using_funds=root.replacement_using_funds();wizard_results.replacement_policies=_.invoke(root.replacement_policies(),"serialize");wizard_results.rider_data=product_cov.selected_riders.serialize_data();wizard_results.address_alternate={street1:$("#eeStreet1").val(),street2:$("#eeStreet2").val(),city:$("#eeCity").val(),state:$("#eeState").val(),zip:$("#eeZip").val()};return wizard_results;}
function submit_decline(){var root=window.vm;window.vm.is_submitting(true);window.vm.submission_error("");var results=_.map(root.product_coverage_viewmodels(),function(product_cov){return build_wizard_results_for_product_coverage(product_cov);});ajax_post("/submit-wizard-data",{"wizard_results":results},function(resp){if(resp.error){bootbox.dialog({message:"There was a problem submitting the form ("+resp.error+").  Please contact the enrollment system administrator.",buttons:{"success":{"label":"OK","className":"btn-sm btn-primary"}}});}else{location=resp.redirect;}},handle_remote_error,true);}
function init_validation(ui){$('[data-rel=tooltip]').tooltip();var validation_debug=false;$('#enrollment-wizard').ace_wizard().on('actionclicked.fu.wizard',function(e,info){if(validation_debug){return true;}
var is_valid;if(info.step===1){$("#health_questions_error").html("");if(ui.did_decline_all_products()){submit_decline();e.preventDefault();return;}
is_valid=ui.validator.form();if(!ui.is_coverage_selection_visible()){ui.step_one_validation_error('Please click \"Show Coverage Options\"');e.preventDefault();return;}else{ui.step_one_validation_error(null);}
function validate_coverage_amount(applicant_coverage){var product_id=applicant_coverage.product.product_data.id;var product=applicant_coverage.product;var applicant=applicant_coverage.applicant;var existing_coverage_amount=applicant.get_existing_coverage_amount_for_product(product_id);if(!existing_coverage_amount){return true;}
var selected_option=applicant_coverage.get_selected_coverage();var applied_coverage_amount=(selected_option.is_valid())?selected_option.face_value:0;var max_coverage_amount=applicant_coverage.product.get_maximum_coverage_amount(applicant_coverage.applicant);var name=applicant.name();if(applied_coverage_amount>0&&existing_coverage_amount&&(max_coverage_amount<existing_coverage_amount+applied_coverage_amount)){var additional_allowed_coverage=max_coverage_amount-existing_coverage_amount;additional_allowed_coverage=_.max([0,additional_allowed_coverage]);var msg=("Due to one or more previous applications for "+product.product_data.name+" this enrollment period for "+
format_face_value(existing_coverage_amount)+" coverage, "+name+" can apply for a maximum of "+
format_face_value(additional_allowed_coverage)+" additional coverage.");alert(msg);return false;}
return true;}
_.each(ui.coverage_vm.selected_product_coverages(),function(product_coverage){_.each(product_coverage.applicant_coverage_selections(),function(applicant_coverage){var can_apply=validate_coverage_amount(applicant_coverage);if(!can_apply){is_valid=false;return false;}});if(!is_valid){return false;}});if(!ui.is_coverage_selection_visible()){ui.show_coverage_options_visibility_error();e.preventDefault();return false;}
if(ui.requires_actively_at_work()&&ui.is_employee_actively_at_work()===null){e.preventDefault();return false;}
if(is_valid){$(document.body).scrollTop(0);}else{e.preventDefault();}}
if(info.step===2&&info.direction==='next'){var validator=ui.validators.step2;is_valid=validator.form();if(ui.did_select_any_fpp_product()&&(ui.should_show_replacement_form())){is_valid=$('#questions-form').valid()&&is_valid;}
if(ui.did_select_any_fpp_product()&&(ui.replacing_insurance()===null||ui.existing_insurance()===null)){is_valid=false;}
if(ui.did_select_any_fpp_product()&&ui.is_KY_OR_KS()&&ui.replacing_insurance()){is_valid=false;}
if(ui.did_select_any_fpp_product()&&ui.is_self_enroll()&&(ui.replacement_is_terminating()||ui.replacement_using_funds())){is_valid=false;}
is_valid=health_question_buttons.are_health_questions_valid()&&is_valid;if(!is_valid){$("#health_questions_error").html("Please answer all questions for all applicants.  Invalid responses may prevent you from continuing this online application; if so, please see your agent or enrollment professional.");e.preventDefault();return;}else{$("#health_questions_error").html("");}}
if(info.step===3&&info.direction==='next'){is_valid=$('#step3-form').valid();if(!is_valid){e.preventDefault();return;}}
if(info.step===4&&info.direction==='next'){if(!$('#step4-form').valid()){e.preventDefault();return;}}
if(info.step===5&&info.direction==='next'){_.forEach(ui.coverage_vm.product_coverage_viewmodels(),function(product_coverage_vm){product_coverage_vm.employee_other_beneficiary().date_of_birth.valueHasMutated();if(product_coverage_vm.employee_contingent_beneficiary_type()==='other'){product_coverage_vm.employee_contingent_beneficiary().date_of_birth.valueHasMutated();}});var has_beneficiary_errors=_.any(ui.coverage_vm.product_coverage_viewmodels(),function has_beneficiary_errors(product_coverage_vm){if(product_coverage_vm.employee_contingent_beneficiary_type()==='other'){return!!product_coverage_vm.employee_other_beneficiary().date_of_birth_validation_error()||!!product_coverage_vm.employee_contingent_beneficiary().date_of_birth_validation_error();}
return!!product_coverage_vm.employee_other_beneficiary().date_of_birth_validation_error();});if(!$('#step5-form').valid()||has_beneficiary_errors){e.preventDefault();return;}
if(ui.has_contingent_beneficiary_error()){e.preventDefault();return;}}
if(info.step==6&&info.direction=='next'){if(!$('#step6-form').valid()){e.preventDefault();return;}}}).on('finished.fu.wizard',function(e){if(!$('#step6-form').valid()){return false;}
if(ui.should_confirm_disclosure_notice()&&!ui.disclaimer_notice_confirmed()){bootbox.dialog({message:"Please confirm that you have received the disclosure notice.",buttons:{"danger":{"label":"OK","className":"btn-warning"}}});return false;}
if(ui.should_confirm_payroll_deduction()&&!ui.payroll_deductions_confirmed()){bootbox.dialog({message:"Please confirm that you agree to payroll deductions by your employer.",buttons:{"danger":{"label":"OK","className":"btn-warning"}}});return false;}
if(!ui.can_submit_wizard()){e.preventDefault();vm.submission_error("Please wait, the submission is still processing.");return false;}
submit_application();}).on('stepclick.fu.wizard',function(e){return true;});$.mask.definitions['~']='[+-]';$('#phone').mask('(999) 999-9999');$('#eeDOB').mask('99/99/1999');$('.input-mask-date').mask('99/99/9999');$('.input-mask-ssn').mask('999-99-9999');$('.input-mask-zip').mask('99999');jQuery.validator.addMethod("phone",function(value,element){return this.optional(element)||/^\(\d{3}\) \d{3}\-\d{4}( x\d{1,6})?$/.test(value);},"Enter a valid phone number.");var step_2_validator=$('#questions-form').validate({errorElement:'div',errorClass:'help-block',focusInvalid:false,rules:{replacement_read_aloud:{required:{depends:function(){return ui.is_replacement_form_required();}}},replacement_is_terminating:{required:{depends:function(){return ui.is_replacement_form_required();}}},replacement_using_funds:{required:{depends:function(){return ui.is_replacement_form_required();}}}},highlight:wizard_validate_highlight,success:wizard_validate_success,errorPlacement:wizard_error_placement});$.validator.addClassRules("replacement-question",{required:{depends:function(){return ui.is_replacement_form_required();}}});$.validator.addClassRules("replacement-details-input",{required:{depends:function(){return ui.should_show_replacement_details_form();}}});function isEmployeeOtherOwnerRequired(element){var product_coverage=ko.dataFor(element);return product_coverage.policy_owner()==="other";}
function isSpouseOtherOwnerRequired(element){var product_coverage=ko.dataFor(element);return product_coverage.spouse_policy_owner()==="other";}
$.validator.addClassRules("ee-other-owner-name",{required:{depends:function(element){return isEmployeeOtherOwnerRequired(element);}}});$.validator.addClassRules("ee-other-owner-ssn",{required:{depends:function(element){return isEmployeeOtherOwnerRequired(element);}}});$.validator.addClassRules("sp-other-owner-name",{required:{depends:function(element){return isSpouseOtherOwnerRequired(element);}}});$.validator.addClassRules("sp-other-owner-ssn",{required:{depends:function(element){return isSpouseOtherOwnerRequired(element);}}});$.validator.addMethod('city-state-zip-required',function(){var result=!!ui.employee().city()&&!!ui.employee().state()&&!!ui.employee().zip();return result;},"required");$('#step3-form').validate({errorElement:'div',errorClass:'help-block',focusInvalid:false,rules:{email:{email:true,required:{depends:function(){return ui.is_self_enroll();}}},eeFName2:{required:true},eeLName2:{required:true},eeGender:{required:true},eessn:{required:true},eeStreet1:{required:true},eeCity:{'city-state-zip-required':true},eeState:{'city-state-zip-required':true},eeZip:{'city-state-zip-required':true},eeOwner:{required:true}},messages:{email:{email:"Please provide a valid email."},eeFName2:"required",eeLName2:"required",eeGender:"Please choose gender",eessn:"required",eeStreet1:"required",eeCity:"required",eeState:"required",eeZip:"required",eeOwner:"Please confirm policy owner"},highlight:wizard_validate_highlight,success:wizard_validate_success,errorPlacement:wizard_error_placement});$('#step4-form').validate({errorElement:'div',errorClass:'help-block',focusInvalid:false,rules:{spFName2:{required:true},spLName2:{required:true},spGender:{required:true},spssn:{required:{depends:function(element){return($("#spOwner-self").is(':checked'))}}},spOwner:{required:true}},messages:{spFName2:"required",spLName2:"required",spGender:"Please choose gender",spssn:"Spouse SSN required",spOwner:"Please confirm policy owner"},highlight:wizard_validate_highlight,success:wizard_validate_success,errorPlacement:wizard_error_placement});function is_other_beneficiary_detail_required(element,applicant_type,beneficiary_type){var product_coverage=ko.dataFor(element);if(beneficiary_type==="contingent"&&!product_coverage.should_show_contingent_beneficiary()){return false;}
if(applicant_type==="spouse"&&!ui.coverage_vm.did_select_spouse_coverage()){return false;}
if(applicant_type==="employee"){if(beneficiary_type==="primary"){return product_coverage.employee_beneficiary_type()==="other"||!ui.coverage_vm.did_select_spouse_coverage();}else{return product_coverage.employee_contingent_beneficiary_type()==="other";}}else if(applicant_type==='spouse'){if(beneficiary_type==="primary"){return product_coverage.spouse_beneficiary_type()==="other";}else{return product_coverage.spouse_contingent_beneficiary_type()==="other";}}}
var beneficiary_depends_rules={"ee-bene-name":function(el){return is_other_beneficiary_detail_required(el,'employee','primary')},"ee-bene-rel":function(el){return is_other_beneficiary_detail_required(el,'employee','primary')},"ee-cont-bene-name":function(el){return is_other_beneficiary_detail_required(el,'employee','contingent')},"ee-cont-bene-rel":function(el){return is_other_beneficiary_detail_required(el,'employee','contingent')},"sp-bene-name":function(el){return is_other_beneficiary_detail_required(el,'spouse','primary')},"sp-bene-rel":function(el){return is_other_beneficiary_detail_required(el,'spouse','primary')},"sp-cont-bene-name":function(el){return is_other_beneficiary_detail_required(el,'spouse','contingent')},"sp-cont-bene-rel":function(el){return is_other_beneficiary_detail_required(el,'spouse','contingent')}};for(className in beneficiary_depends_rules){var depends_func=beneficiary_depends_rules[className];$.validator.addClassRules(className,{required:{depends:depends_func}})}
$('#step5-form').validate({errorElement:'div',errorClass:'help-block',focusInvalid:false,rules:{},highlight:wizard_validate_highlight,success:wizard_validate_success,errorPlacement:wizard_error_placement});$('#step6-form').validate({errorElement:'div',errorClass:'help-block',focusInvalid:false,rules:{confirmDisclaimer:{required:true},enrollCity:{required:true},tokenType:{required:true},ConfirmationToken:{required:function(){return window.vm.should_use_date_of_hire_for_identity();}},hireDate:{required:true}},messages:{confirmDisclaimer:"please acknowledge that you have received the notice",enrollCity:"required",tokenType:"required",ConfirmationToken:"Valid date required"},highlight:wizard_validate_highlight,success:wizard_validate_success,errorPlacement:wizard_error_placement});}
function wizard_validate_highlight(e){$(e).closest('.form-group').removeClass('has-info').addClass('has-error');}
function wizard_validate_success(e){$(e).closest('.form-group').removeClass('has-error').addClass('has-info');$(e).remove();}
function wizard_error_placement(error,element){if(element.is(':checkbox')||element.is(':radio')){var controls=element.closest('div[class*="col-"]');if(controls.find(':checkbox,:radio').length>1){controls.append(error);}else{error.insertAfter(element.nextAll('.lbl:eq(0)').eq(0));}}else if(element.is('.select2')){error.insertAfter(element.siblings('[class*="select2-container"]:eq(0)'));}else if(element.is('.chosen-select')){error.insertAfter(element.siblings('[class*="chosen-container"]:eq(0)'));}else if(element.is('#eeStreet1')){$('#street-error-anchor').remove();var street_error_element=$('<div class="col-xs-12 col-sm-9 col-sm-offset-3" id="street-error-anchor"></div>');street_error_element.insertAfter(element.parent().parent()).append(error);}else if(element.is('#eeCity')||element.is('#eeState')||element.is('#eeZip')){$('#city-state-zip-error-anchor').remove();var city_state_zip_element=$('<div class="col-xs-12 col-sm-9 col-sm-offset-3" id="city-state-zip-error-anchor"></div>');city_state_zip_element.insertAfter(element.parent()).append(error);}else if(element.closest('.form-group').length>0){error.appendTo(element.closest('.form-group'));}else{error.insertAfter(element);}}
function step_two_error_placement(error,element){'use strict';if((element.is('[name="height_feet_0"]')||element.is('[name="height_inches_0"]')||element.is('[name="weight_0"]'))&&$('#weight_0-error').length===0&&$('#height_feet_0-error').length===0&&$('#height_inches_0-error').length===0){error.appendTo($('#employee-height-weight'));}else if((element.is('[name="height_feet_1"]')||element.is('[name="height_inches_1"]')||element.is('[name="weight_1"]'))&&$('#weight_1-error').length===0&&$('#height_feet_1-error').length===0&&$('#height_inches_1-error').length===0){error.appendTo($('#spouse-height-weight'));}else if(element.is('[name="tobacco-0"]')||element.is('[name="tobacco-1"]')||element.is('[name="gender-0"]')||element.is('[name="gender-1"]')){error.appendTo(element.parent().parent());}}
var wizard_viewmodel=(function(){ko.bindingHandlers.wizard={init:function(element,val_accessor){var val=val_accessor();val($(element).ace_wizard());$(element).wizard('selectedItem',{step:1});}};function CoverageVM(available_products,applicant_list,case_data,all_payment_modes,should_include_spouse,should_include_children,root){this.products=available_products;this.applicants=applicant_list;this.should_include_spouse=should_include_spouse;this.should_include_children=should_include_children;this.root=root;this.multiproduct_wizard_widget=ko.observable(null);this.applicants_in_table=ko.computed(function(){var applicants_in_table=[];if(this.applicants.has_valid_employee()){applicants_in_table.push(this.applicants.get_employee());}
if(this.applicants.has_valid_spouse()&&this.should_include_spouse()){applicants_in_table.push(this.applicants.get_spouse());}
if(this.applicants.has_valid_children()&&this.should_include_children()){_.each(this.applicants.get_children(),function(c){if(c.any_valid_field()){applicants_in_table.push(c);}});}
return applicants_in_table;},this);this.payment_modes=_.map(all_payment_modes||[],function(pm){return payment_mode_module.create_payment_mode(pm);});this.payment_mode=ko.observable(payment_mode_module.select_initial_payment_mode(case_data,this.payment_modes));this.can_change_payment_mode=ko.computed(function(){return payment_mode_module.can_change_payment_mode(case_data);});this.is_payment_mode_valid=ko.pureComputed(this._is_payment_mode_valid,this);this.product_coverage_viewmodels=ko.observableArray(_.map(this.products,function(p){return new ProductCoverageViewModel(p,case_data,applicant_list,this.payment_mode,this.should_include_spouse,this.should_include_children,this.root);},this));this.current_product=ko.observable(this.product_coverage_viewmodels()[0]);this.select_product=function(product_coverage){this.current_product(product_coverage);}.bind(this);this.has_multiple_products=ko.pureComputed(function(){return this.product_coverage_viewmodels().length>1;},this);this.previous_product=ko.pureComputed(function(){var index=this.product_coverage_viewmodels().indexOf(this.current_product());return val_or_null(this.product_coverage_viewmodels(),index-1);},this);this.next_product=ko.pureComputed(function(){var index=this.product_coverage_viewmodels().indexOf(this.current_product());return val_or_null(this.product_coverage_viewmodels(),index+1);},this);function val_or_null(array,index){if(index>=0&&index<array.length){return array[index];}
return null;}
this.coverage_summary_vm=new CoverageSummaryVM(this.product_coverage_viewmodels,this.applicants);var self=this;this.selected_product_coverages=ko.pureComputed(function(){return _.select(self.product_coverage_viewmodels(),function(prod_cov){return prod_cov.did_select_coverage();});},this);self.did_select_employee_coverage=ko.pureComputed(function(){return _.any(self.selected_product_coverages(),function(cov){return cov.did_select_employee_coverage();});});self.did_select_spouse_coverage=ko.pureComputed(function(){return _.any(self.selected_product_coverages(),function(cov){return cov.did_select_spouse_coverage();});});self.did_select_children_coverage=ko.pureComputed(function(){return _.any(self.selected_product_coverages(),function(cov){return cov.did_select_children_coverage();});});self.get_covered_children=ko.pureComputed(function(){var children=[];_.each(self.selected_product_coverages(),function(cov){_.each(cov.get_covered_children(),function(child){if(_.includes(children,child)){return;}
children.push(child);});});return children;});}
CoverageVM.prototype={_is_payment_mode_valid:function(){return((!this.can_change_payment_mode())||(this.can_change_payment_mode()&&this.payment_mode()!=null));},get_applicant_coverage_option_for_product:function(applicant,product){if(applicant.type==wizard_applicant.Applicant.SpouseType&&!this.should_include_spouse()){return null_coverage;}
if(applicant.type==wizard_applicant.Applicant.ChildType&&!this.should_include_children()){return null_coverage;}
var applicant_coverage_selection=this.get_applicant_coverage_for_product(applicant,product);return applicant_coverage_selection.get_selected_coverage();},get_applicant_coverage_for_product:function(applicant,product){var product_coverage=this.get_product_coverage(product);return product_coverage.get_coverage_for_applicant(applicant);},format_total_premium_for_product:function(product){var product_coverage=this.get_product_coverage(product);var total=product_coverage.get_total_premium();return format_premium_value(total);},get_enabled_riders_for_product:function(product){return this.get_product_coverage(product).enabled_riders;},format_total_premium_for_applicant:function(applicant){var applicant_total=0.0;_.each(this.product_coverage_viewmodels(),function(pcov){if(pcov.did_decline()){return true;}
var matching_applicant_coverage=_.find(pcov.valid_applicant_coverage_selections(),function(app_cov){return app_cov.applicant===applicant;});if(!matching_applicant_coverage){return format_premium_value(0.0);}
applicant_total+=matching_applicant_coverage.get_total_premium();});return format_premium_value(applicant_total);},format_grand_total_premium:function(){var grand_total=0.0;_.each(this.product_coverage_viewmodels(),function(pcov){if(pcov.did_decline()){return true;}
grand_total+=pcov.get_total_premium();});return format_premium_value(grand_total);},get_product_coverage:function(product){return _.find(this.product_coverage_viewmodels(),function(pcov){return pcov.product.product_data.id===product.product_data.id;});},go_to_next_product:function(){if(this.next_product()){this.current_product(this.next_product());}},go_to_previous_product:function(){if(this.previous_product()){this.current_product(this.previous_product());}}};function ProductCoverageViewModel(product,case_data,applicant_list,payment_mode,should_include_spouse,should_include_children,root){var self=this;self.product=product;self.case_data=case_data;self.payment_mode=payment_mode;self.applicant_list=applicant_list;self.employee=_.find(applicant_list.applicants(),function(applicant){return applicant.type===wizard_applicant.Applicant.EmployeeType;});self.should_include_spouse=should_include_spouse;self.should_include_children=should_include_children;self.root=root;self.did_decline=ko.observable(false);self.available_recommendations=product_rates_service.get_product_recommendations(self.product,payment_mode);self.selected_recommendation=ko.observable(null);self.selected_simple_coverage_option=ko.observable(new NullCoverageOption());self.selected_simple_coverage_value=ko.computed({read:function(){if(!self.selected_simple_coverage_option().is_valid()){return null;}else{return self.selected_simple_coverage_option().coverage_tier;}},write:function(val){self.selected_simple_coverage_option(product_rates_service.get_product_rate_for_coverage_tier(self.product,val));}});self.get_label_for_coverage_tier=function(coverage_tier){var employee_first_name=self.employee.first();switch(coverage_tier){case'EE':return employee_first_name;case'ES':return employee_first_name+' + Spouse';case'EC':return employee_first_name+' + Child(ren)';case'EF':return'Family (All)';default:return'';}};self.get_coverage_rate_for_tier=function(coverage_tier){var coverage_option=product_rates_service.get_product_rate_for_coverage_tier(self.product,coverage_tier);if(coverage_option){return coverage_option.format_premium();}
return'';};self._applicant_coverage_viewmodels={};self.applicant_coverage_selections=ko.computed(this._get_applicant_coverage_selections,this);self.get_coverage_options_for_applicant=function(applicant){return _.find(self.applicant_coverage_selections(),function(cov){return cov.applicant.type===applicant.type;}).get_coverage_options();};self.has_completed_selection=ko.computed(this._has_completed_selection,this);self.did_select_coverage=ko.pureComputed(function(){return self.has_completed_selection()&&!self.did_decline();},this);self.did_select_valid_coverage=ko.pureComputed(function(){return self.did_select_coverage()&&(self.did_select_employee_coverage()||self.did_select_spouse_coverage()||self.did_select_children_coverage());});self.did_select_employee_coverage=ko.pureComputed(function(){return _.any(self.valid_applicant_coverage_selections(),function(cov){return cov.applicant.type==wizard_applicant.Applicant.EmployeeType&&cov.coverage_option().is_valid();});});self.did_select_spouse_coverage=ko.pureComputed(function(){return _.any(self.valid_applicant_coverage_selections(),function(cov){return cov.applicant.type==wizard_applicant.Applicant.SpouseType&&cov.coverage_option().is_valid();});});self.did_select_children_coverage=ko.pureComputed(function(){return _.any(self.valid_applicant_coverage_selections(),function(cov){return cov.applicant.type==wizard_applicant.Applicant.ChildType&&cov.coverage_option().is_valid();});});self.get_covered_children=ko.computed(function(){return self._get_covered_children();});function is_rider_enabled_for_case(rider,case_data){return _.any(case_data.product_settings.riders,function(r){return(self.product.product_data.id===r.product_id&&rider.code===r.rider_code&&r.is_selected);});}
self.enabled_riders=_.select(product.product_data.riders,function(r){return is_rider_enabled_for_case(r,case_data);});self.shown_rider=ko.observable(null);self.rider_options=[];_.each([self.applicant_list.get_employee(),self.applicant_list.get_spouse()],function(applicant){_.each(self.enabled_riders,function(rider){var vm=new ApplicantRiderOptionVM(self,rider,applicant);self.rider_options.push(vm);});});self.visible_rider_options=ko.computed(function(){return _.select(self.rider_options,function(option){return option.is_visible()});});self.selected_riders=ko.computed(function(){var selected_emp_riders=_.select(self.visible_rider_options(),function(option){return option.applicant===self.applicant_list.get_employee()&&option.is_selected();});var selected_sp_riders=_.select(self.visible_rider_options(),function(option){return option.applicant===self.applicant_list.get_spouse()&&option.is_selected();});return{emp:_.pluck(selected_emp_riders,'rider'),sp:_.pluck(selected_sp_riders,'rider')};});self.selected_riders.serialize_data=ko.computed(function(){return{emp:self.selected_riders().emp,sp:self.selected_riders().sp};});self.get_selected_riders=function(person){if(person.applicant_type==="employee"){return self.selected_riders().emp;}else if(person.applicant_type==="spouse"){return self.selected_riders().sp;}
return[];};self.policy_owner=ko.observable("self");self.other_owner_name=ko.observable("");self.other_owner_ssn=ko.observable("");self.spouse_policy_owner=ko.observable("employee");self.spouse_other_owner_name=ko.observable("");self.spouse_other_owner_ssn=ko.observable("");self.employee_beneficiary_type=ko.observable("spouse");self.employee_other_beneficiary=ko.observable(new beneficiary.Beneficiary());self.employee_contingent_beneficiary_type=ko.observable("none");self.employee_contingent_beneficiary=ko.observable(new beneficiary.Beneficiary());self.spouse_beneficiary_type=ko.observable("spouse");self.spouse_other_beneficiary=ko.observable(new beneficiary.Beneficiary());self.spouse_contingent_beneficiary_type=ko.observable("none");self.spouse_contingent_beneficiary=ko.observable(new beneficiary.Beneficiary());self.is_employee_beneficiary_info_required=function(){return!self.did_select_spouse_coverage()||$("#eeBeneOther").is(':checked')};self.should_show_contingent_beneficiary=function(){return self.product.should_show_contingent_beneficiary();};self.has_contingent_beneficiary_error=ko.computed(function(){var employee_beneficiary_error=(self.employee_contingent_beneficiary_type()==='spouse'&&self.employee_beneficiary_type()==='spouse');var spouse_beneficiary_error=(self.did_select_spouse_coverage()&&self.should_show_contingent_beneficiary()&&self.spouse_contingent_beneficiary_type()==='spouse'&&self.spouse_beneficiary_type()==='spouse');return(self.should_show_contingent_beneficiary()&&(employee_beneficiary_error||spouse_beneficiary_error));});self.has_spouse_been_treated_6_months=ko.pureComputed(function(){return _find_answer_for_spouse_question_with_label("Spouse Treated 6 Months");});self.has_spouse_been_disabled_6_months=ko.pureComputed(function(){return _find_answer_for_spouse_question_with_label("Spouse Disabled 6 Months");});function _find_answer_for_spouse_question_with_label(lbl){if(!self.did_select_spouse_coverage()){return null;}
var product_questions=self.root.get_product_health_questions(self);var spouse_question=_.find(product_questions.health_questions(),function(q){return q.get_question_label()===lbl;});if(!spouse_question){return null;}
if(spouse_question.can_spouse_skip_due_to_GI()){return"GI";}
var spouse_answer=product_questions.get_applicant_answer_for_question(self.root.spouse(),spouse_question);return spouse_answer.value();}
self.applicant_subscriptions=[];window.setTimeout(function(){self.applicant_coverage_selections.subscribe(observe_coverage_option_changes,0);observe_coverage_option_changes()});function observe_coverage_option_changes(){_.each(self.applicant_subscriptions,function(subscription){subscription.dispose();});self.applicant_subscriptions=[];_.each(self.applicant_coverage_selections(),function(acov){var subscription=acov.get_coverage_options.subscribe(function(new_options){var selected_cov=acov.coverage_option();if(!selected_cov.is_valid()){return;}
if(!_.contains(new_options,selected_cov)){var filtered_options=_.filter(new_options,function(o){return o.face_value<=selected_cov.face_value;});var best_option=_.max(filtered_options,function(o){return o.face_value;});window.setTimeout(function(){if(acov.customized_coverage_option()){acov.customized_coverage_option(best_option);}else if(!_.contains(acov.get_coverage_options(),acov.coverage_option())){acov.recommended_coverage_option(null);acov.customized_coverage_option(best_option);}},0);}});self.applicant_subscriptions.push(subscription);});}}
ProductCoverageViewModel.prototype={format_product_name:function(){return this.product.product_data.name;},get_coverage_selection_template:function(){if(this.product.has_simple_coverage()){return'simple_coverage_selection';}else if(this.product.does_use_recommended_coverage_table()){return'recommendation_coverage_selection';}else{return'category_coverage_selection';}},select_recommended_coverage:function(recommendation_set){this.selected_recommendation(recommendation_set);_.each(this.valid_applicant_coverage_selections(),function(applicant_coverage){applicant_coverage.select_recommended_coverage(recommendation_set);},this);},_has_completed_selection:function(){if(this.did_decline()){return true;}else if(this.product.has_simple_coverage()&&true){return true;}
return _.all(this.valid_applicant_coverage_selections(),function(applicant_coverage){return applicant_coverage.did_select_option();},this);},_get_applicant_coverage_selections:function(){var selections=[];if(this.product.has_simple_coverage()){selections.push(this.__get_coverage_for_applicant(this.applicant_list.get_employee()));return selections;}
if(this.applicant_list.has_valid_employee()){selections.push(this.__get_coverage_for_applicant(this.applicant_list.get_employee()));}
if(this.applicant_list.has_valid_spouse()&&this.should_include_spouse()){selections.push(this.__get_coverage_for_applicant(this.applicant_list.get_spouse()));}
if(this.applicant_list.has_valid_children()&&this.should_include_children()){selections.push(this.__get_coverage_for_applicant(this.applicant_list.get_children_group()));}
return selections;},valid_applicant_coverage_selections:function(){return _.filter(this.applicant_coverage_selections(),function(acov){var applicant=acov.applicant;return((applicant.type===wizard_applicant.Applicant.EmployeeType&&this.applicant_list.has_valid_employee())||(applicant.type===wizard_applicant.Applicant.SpouseType&&(this.applicant_list.has_valid_spouse()&&this.should_include_spouse()))||(applicant.type===wizard_applicant.Applicant.ChildType&&(this.applicant_list.has_valid_children()&&this.should_include_children())))},this);},get_coverage_for_applicant:function(applicant){return this.__get_coverage_for_applicant(applicant);},__get_coverage_for_applicant:function(applicant){if(applicant.type===wizard_applicant.Applicant.ChildType){applicant=this.applicant_list.get_children_group();}
var applicant_coverage;if(applicant._id in this._applicant_coverage_viewmodels){applicant_coverage=this._applicant_coverage_viewmodels[applicant._id];}else{var new_selection_instance=new ApplicantCoverageSelectionVM(applicant,this);this._applicant_coverage_viewmodels[applicant._id]=new_selection_instance;applicant_coverage=new_selection_instance;}
return applicant_coverage;},_get_covered_children:function(){var coverage=this.get_coverage_for_applicant(this.applicant_list.get_children_group());if(coverage.coverage_option().is_valid()){return _.filter(this.applicant_list.get_children(),function(child){return child.is_valid();});}else{return[];}},get_total_premium:function(){var total=0.0;if(this.did_decline()){return total;}
_.each(this.applicant_coverage_selections(),function(applicant_coverage){total+=applicant_coverage.get_total_premium();},this);return total;},is_applicant_type_covered:function(applicant_type){var coverage_option_view_model=this.get_coverage_for_applicant(this.employee);var coverage_option=coverage_option_view_model.coverage_option();if(!coverage_option||!coverage_option.is_valid()){return false;}
if(applicant_type===wizard_applicant.Applicant.EmployeeType){return true;}
if(applicant_type===wizard_applicant.Applicant.SpouseType){return coverage_option.coverage_tier==='ES'||coverage_option.coverage_tier==='EF';}
if(applicant_type===wizard_applicant.Applicant.ChildType){return coverage_option.coverage_tier==='EC'||coverage_option.coverage_tier==='EF';}},get_coverage_status:function(applicant){var coverage_option_view_model=this.get_coverage_for_applicant(this.employee);var coverage_option=coverage_option_view_model.coverage_option();var is_covered=this.is_applicant_type_covered(applicant.type);if(applicant.type===wizard_applicant.Applicant.EmployeeType&&is_covered){return coverage_option.format_face_value();}else if(is_covered){return'Included';}else if(coverage_option.is_valid()){return'Not Included';}else{return'Select Coverage';}}};function ApplicantCoverageSelectionVM(applicant,product_coverage){this.applicant=applicant;this.product_coverage=product_coverage;this.product=product_coverage.product;this.customized_coverage_option=ko.observable(null);this.recommended_coverage_option=ko.observable(null);this.coverage_option=ko.computed(function(){if(!this.applicant.is_valid()){return null_coverage;}else if(this.applicant.type===wizard_applicant.Applicant.SpouseType&&!this.product_coverage.root.should_include_spouse_in_table()){return null_coverage;}else if(this.applicant.type===wizard_applicant.Applicant.ChildType&&!this.product_coverage.root.should_include_children_in_table()){return null_coverage;}
if(this.product.has_simple_coverage()){return this.product_coverage.selected_simple_coverage_option();}
var custom_option=this.customized_coverage_option();var recommended_option=this.recommended_coverage_option();if(custom_option){return custom_option;}else if(recommended_option){return recommended_option;}else{return new NullCoverageOption();}},this);this.did_select_option=ko.pureComputed(function(){if(this.product.has_simple_coverage()){return this.product_coverage.selected_simple_coverage_option().is_valid();}
return(this.customized_coverage_option()!==null&&this.customized_coverage_option()!==undefined)||this.recommended_coverage_option()!==null;},this);this.riders=ko.observableArray();this.beneficiaries=ko.observableArray([]);this.get_coverage_options=ko.pureComputed(this._get_coverage_options,this);}
ApplicantCoverageSelectionVM.prototype={select_recommended_coverage:function(recommendation_set){if(!recommendation_set){this.recommended_coverage_option(null);this.customized_coverage_option(null);return;}
var coverage_option=recommendation_set.get_recommended_applicant_coverage(this.applicant.type);if(coverage_option){this.recommended_coverage_option(coverage_option);this.customized_coverage_option(null);}},select_custom_coverage:function(option){this.customized_coverage_option(option);},has_selected_coverage:function(){return this.coverage_option().is_valid();},get_selected_coverage:function(){return this.coverage_option();},get_cumulative_coverage_amount:function(){var previous_coverage_amount=this.applicant.get_existing_coverage_amount_for_product(this.product.product_data.id);var current_coverage_amount=(this.has_selected_coverage()?this.coverage_option().face_value:0);return previous_coverage_amount+current_coverage_amount;},format_name:function(){return this.applicant.name();},_get_coverage_options:function(){var options=[null_coverage];options=$.merge(options,product_rates_service.get_product_coverage_options_for_applicant(this.product,this.applicant)());return options;},format_recommendation_coverage:function(recommendation_set){var coverage=recommendation_set.get_recommended_applicant_coverage(this.applicant.type);return coverage.format_face_value();},format_recommendation_premium:function(recommendation_set){var recommendation=recommendation_set.get_applicant_recommendation(this.applicant.type);return recommendation.format_total_premium();},format_selected_coverage:function(){return this.get_selected_coverage().format_face_value();},format_selected_premium:function(){if(this.applicant.type==wizard_applicant.Applicant.ChildType&&this.product_coverage.product.is_fpp_product()&&this.has_selected_coverage()){var premium=this.get_selected_coverage().get_total_premium()*window.vm.coverage_vm.applicants.get_valid_children().length;return format_premium_value(premium);}
return this.get_selected_coverage().format_premium_option();},get_total_premium:function(){if(this.applicant.type===wizard_applicant.Applicant.ChildType&&this.product.is_fpp_product()){var num_valid_children=window.vm.applicant_list.get_valid_children().length;return this.coverage_option().premium*num_valid_children;}
return this.coverage_option().premium;},get_previous_coverage_amount:function(){return this.applicant.get_existing_coverage_amount_for_product(this.product.product_data.id);}};function CoverageSummaryVM(product_coverages,applicant_list){this.product_coverages=product_coverages;this.applicant_list=applicant_list;this.product_names=ko.pureComputed(function(){return _.map(this.product_coverages(),function(pcov){return pcov.product.format_product_name();});},this);this.valid_applicants=ko.pureComputed(function(){return this.applicant_list.get_valid_applicants_for_coverage();},this);this.all_coverages=ko.computed(function(){var _coverages=[];_.each(this.product_coverages(),function(pcov){_.each(pcov.valid_applicant_coverage_selections(),function(app_cov){_coverages.push(app_cov);});});return _coverages;},this);}
function ApplicantRiderOptionVM(root,rider,applicant){var self=this;self.MAX_COVERAGE=150000;self.root=root;self.rider=rider;self.applicant=applicant;self._user_selection=ko.observable(false);self.can_user_select=ko.computed(function(){return self.rider.code==='AIR';});self.is_visible=ko.computed(function(){return self.root.get_coverage_for_applicant(self.applicant).has_selected_coverage();});self.is_selected=ko.computed({read:function(){if(self.can_user_select()){return self._user_selection();}else{return self.is_visible();}},write:function(val){self._user_selection(val);}});self.format_rider_name=function(){return self.rider.user_facing_name;};self.format_applicant_name=function(){return self.applicant.name();};self.has_rider_modal=function(){return(self.rider.code==="AIR"||self.rider.code==="QOL3"||self.rider.code==="QOL4"||self.rider.code==="WP");};self.show_rider_info=function(){self.root.shown_rider(self);switch(self.rider.code){case"AIR":$("#modal-auto-increase-rider").modal('show');break;case"WP":$("#modal-wop-rider").modal('show');break;case"QOL3":$("#modal-qol3-rider").modal('show');break;case"QOL4":$("#modal-qol4-rider").modal('show');break;}};self.get_policy_years=function(){var policy_years=[];for(var year=2;year<=6;year++){if(self.get_age_for_policy_year(year)<=70&&self.get_total_coverage_for_year(year)<self.MAX_COVERAGE){policy_years.push(year);}}
return policy_years;};self.get_age_for_policy_year=function(n){return self.applicant.get_age()+n-1;};self.format_coverage_for_year=function(n){var coverage=self.get_coverage_for_year(n);return format_face_value(coverage);};self.format_total_coverage_for_year=function(n){var coverage=self.get_total_coverage_for_year(n);return format_face_value(coverage);};self.format_coverage_for_policy=function(){var coverage=0;var years=self.get_policy_years();for(i=0;i<years.length;i++){coverage+=self.get_coverage_for_year(years[i]);}
return format_face_value(coverage);};self.get_coverage_for_year=function(n){var age=self.get_age_for_policy_year(n);return self.get_coverage_for_applicant_age(age);};self.get_total_coverage_for_year=function(n){var additional_coverage=self.get_coverage_for_year(n);if(n==2){var selected_coverage=parseInt(self.root.get_coverage_for_applicant(self.applicant).coverage_option().face_value);return selected_coverage+additional_coverage;}
var total_coverage_last_year=self.get_total_coverage_for_year(n-1);return additional_coverage+total_coverage_last_year;};self.get_coverage_for_applicant_age=function(n){var _coverage_values={18:'15339',19:'15339',20:'15339',21:'15339',22:'15339',23:'15339',24:'15339',25:'15339',26:'15249',27:'14986',28:'14566',29:'13978',30:'13299',31:'12621',32:'11954',33:'11280',34:'10612',35:'9962',36:'9336',37:'8739',38:'8176',39:'7636',40:'7123',41:'6624',42:'6154',43:'5727',44:'5339',45:'4986',46:'4668',47:'4381',48:'4117',49:'3869',50:'3629',51:'3390',52:'3152',53:'2920',54:'2698',55:'2495',56:'2311',57:'2147',58:'2002',59:'1871',60:'1751',61:'1641',62:'1540',63:'1445',64:'1353',65:'1264',66:'1174',67:'1085',68:'999',69:'917',70:'839'};return parseInt(_coverage_values[n]);};self.format_premium=function(){if(self.rider.code==="AIR"){return"No initial premium charge";}else{return"Included";}};}
function WizardVM(options){var self=this;self.options=options;self.enrollment_case=options.case_data;self.products=wizard_products.build_products(self,options.products);self.is_rate_table_loading=product_rates_service.is_loading_rates;self.is_show_rates_clicked=ko.observable(false);_.defaults(self.enrollment_case,{omit_actively_at_work:false});self.should_show_actively_at_work=function(product,applicant){applicant=typeof applicant!=='undefined'?applicant:null;if(applicant){return applicant.type===wizard_applicant.Applicant.EmployeeType&&_.startsWith(product.product_data.base_product_type,"FPP")&&!self.enrollment_case.omit_actively_at_work&&!product.product_data.is_guaranteed_issue;}
return _.startsWith(product.product_data.base_product_type,"FPP")&&!self.enrollment_case.omit_actively_at_work&&!product.product_data.is_guaranteed_issue;};self.requires_actively_at_work=ko.pureComputed(function(){return!self.enrollment_case.omit_actively_at_work;});init_applicants();init_jquery_validator();self.occupations=ko.observableArray(sort_occupations(_.map(options.case_data.occupations,function(occupation){return new OccupationVM(occupation.label,occupation.level);})));self.selected_occupation=ko.observable(_.find(self.occupations(),function(occupation){return!!self.employee().occupation&&self.employee().occupation===occupation.label;}));if(!self.selected_occupation()){self.selected_occupation(_.find(self.occupations(),function(occupation){return occupation.label==='Default';}));}
self.requires_occupation=_.any(self.products,function(product_view_model){return product_view_model.requires_occupation();});self.should_show_occupation=self.requires_occupation&&!self.selected_occupation()&&self.options.is_in_person;self.set_wizard_step=function(){var wizard=$('#enrollment-wizard').data('fu.wizard');wizard.currentStep=step_number;wizard.setState();};self.get_wizard_step=function(){var wizard=$('#enrollment-wizard').data('fu.wizard');return wizard.currentStep;};self.applicant_types=ko.pureComputed(function(){return _.chain(self.applicant_list.applicants()).filter(function(applicant){return applicant.type===wizard_applicant.Applicant.EmployeeType||(applicant.type===wizard_applicant.Applicant.ChildType&&self.should_include_children_in_table())||(applicant.type===wizard_applicant.Applicant.SpouseType&&self.should_include_spouse_in_table());}).map(function(applicant){return applicant.type;}).uniq().value();});self.should_include_spouse_in_table=ko.computed(function(){return self.should_show_spouse()&&self.spouse().is_valid();});self.should_include_children_in_table=ko.computed(function(){return(self.should_include_children()&&self.applicant_list.has_valid_children());});self.reset_simple_coverage_options=function(){_.forEach(self.coverage_vm.product_coverage_viewmodels(),function(product_coverage_viewmodel){if(product_coverage_viewmodel.product.has_simple_coverage()){product_coverage_viewmodel.selected_simple_coverage_option(new NullCoverageOption());}});};self.should_include_spouse_in_table.subscribe(self.reset_simple_coverage_options);self.should_include_children_in_table.subscribe(self.reset_simple_coverage_options);self.coverage_vm=new CoverageVM(self.products,self.applicant_list,options.case_data,options.payment_modes,self.should_show_spouse,self.should_include_children,self);self.product_coverage_viewmodels=self.coverage_vm.product_coverage_viewmodels;self.add_child=function(){var child=wizard_applicant.create_applicant({last:self.employee().last(),type:wizard_applicant.Applicant.ChildType});self.applicant_list.add_applicant(child);};self.remove_child=function(child){self.applicant_list.remove_applicant(child);if(self.applicant_list.get_children().length===0){self.should_include_children(false);}};self.rendered_child=function(element){$(element).hide().slideDown(400);};self.removing_child=function(element){$(element).slideUp(function(){$(element).remove();});};self.is_recommended_table_visible=ko.computed(function(){return(self.is_show_rates_clicked()&&self.can_display_rates_table());});self.is_applicant_editor_visible=ko.pureComputed(function(){return!self.is_recommended_table_visible();});self.update_rate_table=function(){if(self.validator){self.validator.resetForm();}
self.is_show_rates_clicked(true);if(!self.is_recommended_table_visible()){return;}
self.refresh_rate_table();};self.refresh_rate_table=function(){var products_to_fetch=_.chain(self.product_coverage_viewmodels()).filter(function(product_coverage_view_model){return!product_coverage_view_model.did_decline();}).map(function(product_coverage_view_model){return product_coverage_view_model.product;}).value();var occupation=null;if(self.selected_occupation()&&Array.isArray(self.selected_occupation())){occupation=self.selected_occupation()[0].label;}else if(self.selected_occupation()){occupation=self.selected_occupation().label;}
product_rates_service.update_product_rates(products_to_fetch,self.coverage_vm.payment_mode(),self.applicant_list,self.handle_update_rates_error,self.enrollment_case.situs_state,self.coverage_vm,self.enrollment_case.product_settings.classification_mappings,occupation);};self.handle_update_rates_error=function(resp){if(resp.status===400&&resp.responseJSON&&resp.responseJSON.errors){$.each(resp.responseJSON.errors,function(error){var field_name=this.field;var message=this.error;self.limit_error_lookup[field_name](true);self.validator.form();});if(self.get_wizard_step&&self.get_wizard_step()===2){var product_id=resp.product_id;if(!product_id){return;}
var employee_height_error=_.find(resp.responseJSON.errors,function(error){return error.field==='employee_height';});var employee_weight_error=_.find(resp.responseJSON.errors,function(error){return error.field==='employee_weight';});var spouse_height_error=_.find(resp.responseJSON.errors,function(error){return error.field==='spouse_height';});var spouse_weight_error=_.find(resp.responseJSON.errors,function(error){return error.field==='spouse_weight';});var applicant;if(employee_height_error||employee_weight_error){applicant=self.employee();}
if(spouse_height_error||spouse_weight_error){applicant=self.spouse();}
if(!applicant){return;}
var product=_.find(self.products,function(product){return product.product_data.id===product_id;});var health_questions_vm=_.find(self.selected_product_health_questions(),function(health_question_vm){return health_question_vm.product_coverage.product.product_data.id===product_id;});health_questions_vm.show_yes_dialogue(applicant,"This applicant is not within the height and weight"+" requirements for '"+product.product_data.name+"'. You may proceed with this application after"+" removing this individual from the coverage selection before proceeding.");self.validators.step2.resetForm();self.validators.step2.form();self.show_height_weight_dialog_if_invalid();}}else{handle_remote_error(resp,function(){});}};self.show_height_weight_dialog_if_applicants_invalid=function(){var products_require_additional_information=_.any(self.coverage_vm.product_coverage_viewmodels(),function(product_coverage_viewmodel){return product_coverage_viewmodel.product.requires_additional_information()&&!product_coverage_viewmodel.did_decline();});if(!products_require_additional_information){return false;}
var is_employee_invalid=_.any(self.products,function(product){return!is_applicant_weight_valid(self.enrollment_case.product_height_weight_tables,product,self.employee())&&product.requires_additional_information();});is_employee_invalid=is_employee_invalid&&!!self.employee().height()&&!!self.employee().weight();if(is_employee_invalid){show_height_weight_error(_.find(self.products,function(product){return product.requires_additional_information();}),self.employee());return;}
var is_spouse_invalid=_.any(self.products,function(product){return(self.should_show_spouse()&&!is_applicant_weight_valid(self.enrollment_case.product_height_weight_tables,product,self.spouse()))&&product.requires_additional_information();});is_spouse_invalid=is_spouse_invalid&&!!self.spouse().height()&&!!self.spouse().weight();if(is_spouse_invalid){show_height_weight_error(_.find(self.products,function(product){return product.requires_additional_information();}),self.spouse());}};function show_height_weight_error(product,applicant){var health_questions_vm=_.find(self.selected_product_health_questions(),function(health_question_vm){return health_question_vm.product_coverage.product.product_data.id===product.product_data.id;});health_questions_vm.show_yes_dialogue(applicant,"This applicant is not within the height and weight"+" requirements for '"+product.product_data.name+"'. You may proceed with this application after"+" removing this individual from the coverage selection before proceeding.");}
function get_row_for_height(table,height){return _.find(table,function(row){return row.height===height;});}
function is_applicant_height_valid(product_tables,product,applicant){if(!product_tables||!product||!applicant){return false;}
if(!applicant.height()||!applicant.weight()){return true;}
var result;var gender=applicant.gender();var height=applicant.height();if(typeof height==='string'){height=parseInt(height);}
try{var gender_tables=product_tables[product.product_data.base_product_type];var table=gender_tables[gender];result=!!get_row_for_height(table,height);}catch(ignored){result=false;}
return result;}
function is_applicant_weight_valid(product_tables,product,applicant){if(!product_tables||!product||!applicant){return false;}
if(!applicant.height()||!applicant.weight()){return true;}
var result;var gender=applicant.gender();var height=applicant.height();var weight=applicant.weight();if(typeof height==='string'){height=parseInt(height);}
if(typeof weight==='string'){weight=parseInt(weight);}
try{var table=product_tables[product.product_data.base_product_type][gender];var row=get_row_for_height(table,height);result=weight>row.min_weight&&weight<row.max_weight;}catch(ignored){result=false;}
return result;}
self.show_height_weight_dialog_if_applicants_invalid=function(){var is_employee_invalid=_.any(self.products,function(product){return!is_applicant_weight_valid(self.enrollment_case.product_height_weight_tables,product,self.employee())&&product.requires_additional_information();});if(is_employee_invalid){show_height_weight_error(_.first(self.products,function(product){return product.requires_additional_information();}),self.employee());return;}
var is_spouse_invalid=_.any(self.products,function(product){return(self.should_show_spouse()&&!is_applicant_weight_valid(self.enrollment_case.product_height_weight_tables,product,self.spouse()))&&product.requires_additional_information();});if(is_spouse_invalid){show_height_weight_error(_.first(self.products,function(product){return product.requires_additional_information();}),self.spouse());}};var observables=[self.employee().height,self.employee().weight];if(self.should_show_spouse()){observables.push(self.spouse().height,self.spouse().weight);}
_.forEach(observables,function(observable){observable.subscribe(function(){self.show_height_weight_dialog_if_applicants_invalid();});});self.should_allow_grandchildren=ko.computed(function(){return!!self.products&&self.products.length===1&&_.some(self.products,function(product){return product.is_fpp_product();});});self.show_spouse_name=ko.computed(function(){return(self.should_include_spouse_in_table())?self.spouse().name():"";});self.has_show_rates_been_clicked=ko.observable(false);self.is_employee_actively_at_work=ko.observable(null);self.show_aaw_error=ko.observable(false);self.is_aaw_answered=ko.pureComputed(function(){return self.is_employee_actively_at_work()===true||self.is_employee_actively_at_work()===false;});self.can_display_rates_table=ko.computed(function(){var is_employee_valid=self.applicant_list.has_valid_employee();var is_payment_valid=self.coverage_vm.is_payment_mode_valid();var has_limit_errors=self.any_limit_error();var is_aaw_selected=(self.requires_actively_at_work()&&self.is_employee_actively_at_work()===true)||!self.requires_actively_at_work();return is_employee_valid&&is_payment_valid&&!has_limit_errors&&is_aaw_selected;});self.show_coverage_selection_table=function(){$.each(self.limit_error_lookup,function(k,v){self.limit_error_lookup[k](null);});var valid_form=true;if(!self.can_display_rates_table()){valid_form=false;}
valid_form=self.validator.form()&&valid_form;if(self.is_aaw_answered()){self.show_aaw_error(false);}else{self.show_aaw_error(true);}
if(valid_form){self.has_show_rates_been_clicked(true);self.update_rate_table();}};self.show_applicant_editor=function(){self.has_show_rates_been_clicked(false);self.is_show_rates_clicked(false);};self.is_coverage_selection_visible=ko.pureComputed(function(){return(self.has_show_rates_been_clicked()&&self.can_display_rates_table());});self.step_one_validation_error=ko.observable(null);self.has_step_one_validation_error=ko.pureComputed(function(){return!!self.step_one_validation_error();});self.is_coverage_selection_visible.subscribe(function(value){if(value){self.step_one_validation_error(null);}});self.should_display_show_rates_button=ko.pureComputed(function(){return!self.is_coverage_selection_visible();});self.should_show_critical_illness_styling=function(){return false;};var any_product=function(method_name){return _.any(_.invoke(self.products,method_name));};var all_products=function(method_name){return _.all(_.invoke(self.products,method_name));};self.should_show_extended_questions=function(){return(any_product('requires_gender')||any_product('requires_height')||any_product('requires_weight')||any_product('requires_is_smoker'));};function requires_additional_employee_information(){return _.any(self.coverage_vm.product_coverage_viewmodels(),function(product_coverage_view_model){var product=product_coverage_view_model.product;var requires_additional_information=!product_coverage_view_model.did_decline()&&(product.requires_gender()||product.requires_height()||product.requires_weight()||product.requires_is_smoker());return requires_additional_information&&product_coverage_view_model.did_select_employee_coverage();});}
function requires_additional_spouse_information(){if(!self.should_include_spouse_in_table()){return false;}
return _.any(self.coverage_vm.product_coverage_viewmodels(),function(product_coverage_view_model){var product=product_coverage_view_model.product;var requires_additional_information=!product_coverage_view_model.did_decline()&&(product.requires_gender()||product.requires_height()||product.requires_weight()||product.requires_is_smoker());return requires_additional_information&&product_coverage_view_model.did_select_spouse_coverage();});}
self.requires_additional_employee_information=ko.computed(requires_additional_employee_information);self.requires_additional_spouse_information=ko.computed(requires_additional_spouse_information);self.requires_additional_information=ko.computed(function(){return self.requires_additional_employee_information()||self.requires_additional_spouse_information();});self.should_show_gender=function(){return any_product('requires_gender');};self.should_show_height=function(){return any_product('requires_height');};self.should_show_weight=function(){return any_product('requires_weight');};self.should_show_smoker=function(){return any_product('requires_is_smoker');};function min_emp_age(){return _.min(_.invoke(self.products,'min_emp_age'));}
function min_sp_age(){return _.min(_.invoke(self.products,'min_sp_age'));}
function min_ch_age(){return _.min(_.invoke(self.products,'min_child_age'));}
function max_emp_age(){return _.max(_.invoke(self.products,'max_emp_age'));}
function max_sp_age(){return _.max(_.invoke(self.products,'max_sp_age'));}
function max_ch_age(){return _.max(_.invoke(self.products,'max_child_age'));}
self.can_decline=ko.computed(function(){return(!_.any(self.product_coverage_viewmodels(),function(product_coverage){return _.any(self.applicant_list.applicants(),function(applicant){return _.any(applicant.existing_coverages,function(existing_coverage){return existing_coverage.product_id===product_coverage.product.id&&existing_coverage.coverage_status==='enrolled';});});}));});self.is_submitting=ko.observable(false);self.submission_error=ko.observable("");self.can_submit_wizard=ko.pureComputed(function(){return!self.is_submitting();});self.did_decline=ko.observable(false);self.did_decline_all_products=ko.pureComputed(function(){return self.did_decline()||_.all(self.product_coverage_viewmodels(),function(pcov){return pcov.did_decline();});});self.did_decline.subscribe(function(val){if(val){bootbox.dialog({message:"Please note that even after declining enrollment, you may still change your decision and elect to enroll at a later time, provided that your employer's enrollment period is still active.",buttons:{"success":{"label":"Close","className":"btn-sm btn-primary"}}});}});self.exit_application=function(){bootbox.dialog({message:"Are you sure you want to exit? All data on this application will be discarded.",buttons:{default:{label:"Cancel",className:"btn-default",callback:function(){}},danger:{label:"Exit application and discard data",className:"btn-danger",callback:function(){window.location.href="/enrollment-case/"+self.options.case_data.id+"#enrollment";}}}});};self.attempted_advance_step=ko.observable(false);self.is_selection_error_visible=ko.computed(function(){return self.attempted_advance_step()&&!self.is_coverage_selection_valid();});self.show_no_selection_error=function(){self.attempted_advance_step(true);};self.show_coverage_options_visibility_error=function(){self.attempted_advance_step(true);};self.is_coverage_selection_valid=function(){return _.all(self.coverage_vm.product_coverage_viewmodels(),function(prod_cov){return prod_cov.did_select_valid_coverage()||prod_cov.did_decline();});};self.existing_insurance=ko.observable(null);self.replacing_insurance=ko.observable(null);self.selected_product_health_questions=ko.computed(function(){return _.map(self.coverage_vm.selected_product_coverages(),function(product_cov){return new health_questions.ProductHealthQuestions(product_cov,options.spouse_questions,options.health_questions,options.employee_questions,self.applicant_list,self.enrollment_case.omit_actively_at_work,self.is_employee_actively_at_work);});});self.get_product_health_questions=function(product_coverage){return _.find(self.selected_product_health_questions(),function(phq){return phq.product_coverage===product_coverage;});};self.should_show_other_insurance_questions=ko.pureComputed(function(){return _.any(self.coverage_vm.selected_product_coverages(),function(product_cov){return product_cov.product.should_show_other_insurance_questions();});});self.should_show_step_two=ko.pureComputed(function(){return _.any(self.coverage_vm.selected_product_coverages(),function(product_coverage){return product_coverage.product.should_show_step_two();});});self.should_show_step_four=ko.pureComputed(function(){return _.any(self.coverage_vm.selected_product_coverages(),function(product_coverage){return product_coverage.product.should_show_step_four();});});self.get_replacement_paragraphs=function(){var paragraph_map={};_.each(self.coverage_vm.selected_product_coverages(),function(prod_cov){var paragraphs=prod_cov.product.get_replacement_paragraphs();$.extend(paragraph_map,paragraphs);});var paragraphs=paragraph_map[self.enrollment_case.situs_state];if(!paragraphs){return[];}
return paragraphs;};self.did_select_any_fpp_product=ko.pureComputed(function(){return _.find(self.coverage_vm.selected_product_coverages(),function(ps){return ps.product.is_fpp_product();});});self.NAIC_AND_MI=['AK','AL','AR','AZ','CO','IA','LA','MD','ME','MS','MT','NC','NE','NH','NJ','NM','OH','OR','RI','SC','TX','UT','VA','VT','WI','WV','MI'];self.is_NAIC_OR_MI=function(){return self.did_select_any_fpp_product()&&_.contains(self.NAIC_AND_MI,self.enrollment_case.situs_state);};self.is_KY_OR_KS=function(){return self.enrollment_case.situs_state=="KY"||self.enrollment_case.situs_state=="KS";};self.is_CT_DC_ND_VI=function(){return _.contains(['CT','DC','ND','VI'],self.enrollment_case.situs_state);};self.is_non_NAIC_other=function(){return!(self.is_NAIC_OR_MI()||self.is_KY_OR_KS()||self.is_CT_DC_ND_VI());};self.is_in_person_application=function(){return'is_in_person'in options&&options.is_in_person;};self.is_self_enroll=function(){return!self.is_in_person_application()};self.get_has_existing_question_highlight=function(){if(self.is_self_enroll()){return'flag';}
return"checkmark";};self.get_replacing_question_highlight=function(){if(self.is_KY_OR_KS()){return"stop";}
if(self.is_CT_DC_ND_VI()){return"checkmark";}
return'flag';};self.warning_modal_title=ko.observable("");self.warning_modal_body=ko.observable("");self.show_warning_modal=function(title,body){self.warning_modal_title(title);self.warning_modal_body(body);$("#warning_modal").modal('show');};var default_warning_body='STOP: A "yes" response to this question disqualifies you from completing this application in your state.';self.select_has_existing_insurance=function(){self.existing_insurance(true);};self.select_replacing_insurance=function(){self.replacing_insurance(true);if(!self.did_select_any_fpp_product()||self.is_KY_OR_KS()){self.show_warning_modal("Replacement Notice",default_warning_body);}};self.should_show_NAIC_replacement_notice=ko.computed(function(){return(self.is_NAIC_OR_MI()&&self.replacing_insurance()===false);});self.should_show_replacement_form=ko.computed(function(){if(!self.did_select_any_fpp_product()){return false;}
if(self.is_KY_OR_KS()||self.is_CT_DC_ND_VI()){return false;}
if(self.is_self_enroll()&&self.existing_insurance()){return true;}
if(self.should_show_NAIC_replacement_notice()){return false;}
return self.replacing_insurance();});self.replacement_read_aloud=ko.observable(false);self.replacement_is_terminating=ko.observable(null);self.replacement_using_funds=ko.observable(null);var self_enroll_stop_message="This response requires you to speak with your insurance representative directly, and prevents you from continuing enrollment at this time. You may cancel this enrollment session and contact your representative.";self.replacement_is_terminating.subscribe(function(){if(self.is_self_enroll()&&self.replacement_is_terminating()){self.show_warning_modal("Replacement Notice",self_enroll_stop_message);}});self.replacement_using_funds.subscribe(function(){if(self.is_self_enroll()&&self.replacement_using_funds()){self.show_warning_modal("Replacement Notice",self_enroll_stop_message);}});self.should_show_replacement_details_form=ko.pureComputed(function(){if(self.is_self_enroll()){return false;}
return self.replacement_using_funds()||self.replacement_is_terminating();});self.replacement_policies=ko.observableArray([new ReplacementPolicy()]);self.add_replacement_policy=function(){self.replacement_policies.push(new ReplacementPolicy());};self.remove_replacement_policy=function(policy){self.replacement_policies.remove(policy);};self.is_replacement_form_required=ko.computed(function(){return(self.did_select_any_fpp_product()&&(self.existing_insurance()||self.replacing_insurance()));});self.company_name=ko.observable(self.enrollment_case.company_name);self.is_spouse_address_same_as_employee=ko.observable(!self.spouse().address1()||(self.employee().address1()===self.spouse().address1()&&self.employee().address2()===self.spouse().address2()&&self.employee().city()===self.spouse().city()&&self.employee().state()===self.spouse().state()&&self.employee().zip()===self.spouse().zip()));self.is_spouse_email_same_as_employee=ko.observable((!self.spouse().email()||self.employee().email()===self.spouse().email()));self.should_show_step_5=function(){return _.any(self.coverage_vm.selected_product_coverages(),function(pcov){return pcov.product.should_show_step_5();})};self.should_show_contingent_beneficiary=function(){return _.any(_.invoke(self.products,"should_show_contingent_beneficiary"));};self.has_contingent_beneficiary_error=ko.computed(function(){return _.any(self.coverage_vm.selected_product_coverages(),function(prod_cov){return prod_cov.has_contingent_beneficiary_error();});});self.disclaimer_notice_confirmed=ko.observable(false);self.payroll_deductions_confirmed=ko.observable(false);self.identityToken=ko.observable("");self.identityType=ko.observable("");self.enrollState=ko.observable(self.enrollment_case.situs_state);self.enrollCity=ko.observable(self.enrollment_case.situs_city);self.should_confirm_disclosure_notice=ko.pureComputed(function(){return any_selected_product('should_confirm_disclosure_notice');});self.should_confirm_payroll_deduction=function(){return any_selected_product('should_confirm_payroll_deduction');};self.should_use_date_of_hire_for_identity=function(){return true;};function any_selected_product(method){var selected_products=_.pluck(self.coverage_vm.selected_product_coverages(),'product');return _.any(_.invoke(selected_products,method));}
function init_applicants(){var initial_applicant_list=_.map(options.applicants||[],function(applicant_data){return wizard_applicant.create_applicant(applicant_data);});self.should_show_spouse=ko.observable(false);self.should_include_children=ko.observable(false);self.applicant_list=new wizard_applicant.ApplicantList(initial_applicant_list,self.should_show_spouse,self.should_include_children);self.employee=function(){return self.applicant_list.get_employee();};self.spouse=function(){return self.applicant_list.get_spouse();};self.smoker_status_changed_dialog_loading=ko.observable(false);self.smoker_status_changed_message=ko.observable('');self.smoker_status_changed_messages=ko.observableArray([]);self.show_smoker_status_changed_dialog=function(value,old_value,applicant){$('#smoking-status-dialog').modal('show');var applicant_coverage_selection_view_models=_.chain(self.coverage_vm.product_coverage_viewmodels()).map(function(view_model){return view_model._get_applicant_coverage_selections();}).flatten().filter(function(applicant_coverage_vm){return applicant_coverage_vm.product_coverage.product.requires_is_smoker();}).value();var old_selected_coverage_options=_.map(applicant_coverage_selection_view_models,function(applicant_coverage_selection_view_model){return applicant_coverage_selection_view_model.coverage_option();});self.smoker_status_changed_dialog_loading(true);self.refresh_rate_table();var subscription;subscription=self.is_rate_table_loading.subscribe(function(value){if(!!value){return;}
self.smoker_status_changed_dialog_loading(false);self.smoker_status_changed_messages.removeAll();if(subscription){subscription.dispose();subscription=null;}
_.forEach(applicant_coverage_selection_view_models,function(applicant_coverage_selection_view_model){var old_coverage_option=_.find(old_selected_coverage_options,function(coverage_option){return coverage_option.applicant_type===applicant_coverage_selection_view_model.applicant.type;});var view_model=_.find(self.coverage_vm.product_coverage_viewmodels(),function(view_model){return applicant_coverage_selection_view_model.product_coverage===view_model;});var new_coverage_options=view_model.get_coverage_options_for_applicant(applicant_coverage_selection_view_model.applicant);if(!old_coverage_option){old_coverage_option=_.find(new_coverage_options,function(new_coverage_option){return new_coverage_option.face_value===0;});}
var coverage_option=_.chain(new_coverage_options).find(function(coverage_option){return coverage_option.face_value===old_coverage_option.face_value;}).value();if(!coverage_option){coverage_option=_.chain(new_coverage_options).filter(function(coverage_option){return coverage_option.face_value<old_coverage_option.face_value;}).max(function(coverage_option){return coverage_option.face_value;}).value();}
var premium_changed=coverage_option.premium!==old_coverage_option.premium;var face_value_changed=coverage_option.face_value!==old_coverage_option.face_value;applicant_coverage_selection_view_model.customized_coverage_option(coverage_option);if(applicant===applicant_coverage_selection_view_model.applicant){var start_type='non-smoker';var end_type='smoker';if(old_value===true&&value===false){start_type='smoker';end_type='non-smoker';}
self.smoker_status_changed_messages.push('The status change from '+
start_type+' to '+end_type+' adjusts your premium for '+
applicant_coverage_selection_view_model.product_coverage.format_product_name()+' to '+
coverage_option.format_premium()+' for '+coverage_option.format_face_value()+' coverage.');}});});};self.on_smoker_status_changed_dialog=function(){$('#smoking-status-dialog').modal('hide');};function subscribe_to_boolean_changes(observable,callback){if(!observable){return;}
var caller_args=arguments;var previous_value;observable.subscribe(function(old_value){previous_value=old_value;},null,'beforeChange');observable.subscribe(function(value){if((previous_value===undefined||previous_value===null)&&value===false){return;}
if((previous_value!==undefined&&previous_value!==null)||value===true){var args=[value,previous_value];if(caller_args.length>2){_.forEach(Array.prototype.slice.call(caller_args,2),function(arg){args.push(arg);});}
callback.apply(this,args);}});}
subscribe_to_boolean_changes(self.employee().is_smoker,self.show_smoker_status_changed_dialog,self.employee());if(self.spouse()){subscribe_to_boolean_changes(self.spouse().is_smoker,self.show_smoker_status_changed_dialog,self.spouse());}
self.children=ko.computed(function(){return self.applicant_list.get_children();});var should_show_spouse_initially=self.spouse().any_valid_field();self.should_show_spouse(should_show_spouse_initially);var should_show_children_initially=self.applicant_list.has_valid_children();self.should_include_children(should_show_children_initially);var num_initial_children=self.children().length;var last_name=self.employee().last()||"";if(num_initial_children==0){var num_blank_children_forms=(2-num_initial_children);for(var i=0;i<num_blank_children_forms;i+=1){var ch=wizard_applicant.create_applicant({last:last_name,type:wizard_applicant.Applicant.ChildType});self.applicant_list.add_applicant(ch);}}}
function init_jquery_validator(){$.validator.addMethod("minAge",function(val,element,params){var age=wizard_applicant.age_for_date(val);return(age!==""&&age>=params);},"Must be at least {0} years old for this product");$.validator.addMethod("maxAge",function(val,element,params){var age=wizard_applicant.age_for_date(val);return(age!==""&&age<=params);},"Must be no more than {0} years old for this product");self.limit_error_lookup={employee_height:self.employee().height_error,employee_weight:self.employee().weight_error,spouse_height:self.spouse().height_error,spouse_weight:self.spouse().weight_error};self.any_limit_error=ko.pureComputed(function(){return self.employee().height_error()||self.employee().weight_error()||self.spouse().height_error()||self.spouse().weight_error();});$.validator.addMethod("empHeightLimit",function(val,el,params){return _.chain(self.products).filter(function(product){return product.requires_additional_information();}).all(function(product){return is_applicant_height_valid(self.enrollment_case.product_height_weight_tables,product,self.employee());}).value()||!requires_additional_employee_information();},"The height or weight entered is outside the limits for this product.");$.validator.addMethod("empWeightLimit",function(val,el,params){return _.chain(self.products).filter(function(product){return product.requires_additional_information();}).all(function(product){return is_applicant_weight_valid(self.enrollment_case.product_height_weight_tables,product,self.employee());}).value()||!requires_additional_employee_information();},"The height or weight entered is outside the limits for this product.");$.validator.addMethod("spHeightLimit",function(val,el,params){return _.chain(self.products).filter(function(product){return product.requires_additional_information();}).all(function(product){return is_applicant_height_valid(self.enrollment_case.product_height_weight_tables,product,self.spouse());}).value()||!requires_additional_employee_information();},"The height or weight entered is outside the limits for this product.");$.validator.addMethod("spWeightLimit",function(val,el,params){return _.chain(self.products).filter(function(product){return product.requires_additional_information();}).all(function(product){return is_applicant_weight_valid(self.enrollment_case.product_height_weight_tables,product,self.spouse());}).value()||!requires_additional_employee_information();},"The height or weight entered is outside the limits for this product.");$.validator.addMethod("isValidPaymentMode",function(value,element){return self.coverage_vm.is_payment_mode_valid();},"You must select a payment mode.");$.validator.addMethod('isValidOccupation',function(value,element,params){return self.selected_occupation();},'You must select an occupation.');function any_valid_spouse_field(){return self.spouse().any_valid_field();}
self.validator=$("#step1-form").validate({highlight:wizard_validate_highlight,success:wizard_validate_success,errorPlacement:wizard_error_placement,errorElement:'div',errorClass:'help-block',rules:{eeBenefitFName:"required",eeBenefitLName:"required",eeBenefitDOB:{required:true,date:true,minAge:min_emp_age(),maxAge:max_emp_age()},spFName:{required:{depends:any_valid_spouse_field}},spLName:{required:{depends:any_valid_spouse_field}},spDOB:{required:{depends:any_valid_spouse_field},date:{depends:any_valid_spouse_field},minAge:{param:min_sp_age(),depends:any_valid_spouse_field},maxAge:{param:max_sp_age(),depends:any_valid_spouse_field}},paymentMode:{isValidPaymentMode:{depends:self.can_change_payment_mode}}},groups:{emp_height:"height_feet_0 height_inches_0",sp_height:"height_feet_1 height_inches_1"}});self.validators={};self.validators.step1=self.validator;self.validators.step2=$('#questions-form').validate({highlight:wizard_validate_highlight,success:wizard_validate_success,errorPlacement:step_two_error_placement,errorElement:'span',errorClass:'help-block',rules:{'tobacco-0':{required:requires_additional_employee_information},'gender-0':{required:requires_additional_employee_information},'height_feet_0':{required:requires_additional_employee_information,empHeightLimit:true},'height_inches_0':{required:requires_additional_employee_information,empHeightLimit:true},'weight_0':{required:requires_additional_employee_information,empWeightLimit:true},'tobacco-1':{required:{depends:requires_additional_spouse_information}},'gender-1':{required:{depends:requires_additional_spouse_information}},'weight_1':{required:{depends:requires_additional_spouse_information},spWeightLimit:true},'height_feet_1':{required:{depends:requires_additional_spouse_information},spHeightLimit:true},'height_inches_1':{required:{depends:requires_additional_spouse_information},spHeightLimit:true},occupation:{isValidOccupation:{depends:self.requires_occupation}},paymentMode:{isValidPaymentMode:{depends:self.can_change_payment_mode}}}});function is_child_name_required(element){if($(element).attr("id")==="child-first-0"||$(element).attr("id")==="child-last-0"||$(element).attr("id")==="child-dob-0"){return self.should_include_children();}
var child=ko.dataFor(element);if(!child){return false;}
return child.any_valid_field();}
function is_child_field_required(element){if($(element).attr("id")==="child-first-0"||$(element).attr("id")==="child-last-0"||$(element).attr("id")==="child-dob-0"){return self.should_include_children();}
var child=ko.dataFor(element);if(!child){return false;}
return child.any_valid_field();}
$.validator.addClassRules("child_birthdate",{required:{depends:is_child_field_required},date:{depends:is_child_field_required},minAge:{param:min_ch_age(),depends:is_child_field_required},maxAge:{param:max_ch_age(),depends:is_child_field_required}});$.validator.addClassRules("child_first",{required:{depends:is_child_name_required}});$.validator.addClassRules("child_last",{required:{depends:is_child_name_required}});}
init_validation(self);self.has_spouse=ko.computed(function(){return!!self.spouse();});self.has_children=ko.computed(function(){return!!self.children()&&self.children().length>0;});self.spouse_and_employee_names=ko.computed(function(){if(self.spouse()){return self.employee().first()+' + '+self.spouse().first();}else{return self.employee().first();}});self.aaw_yes_class=ko.pureComputed(function(){return self.is_employee_actively_at_work()===true?'btn-success':'';});self.aaw_no_class=ko.pureComputed(function(){return self.is_employee_actively_at_work()===false?'btn-danger':'';});self.aaw_yes=function(){self.is_employee_actively_at_work(true);};self.aaw_no=function(){self.is_employee_actively_at_work(false);bootbox.dialog({title:'Actively at Work',message:'All enrollments require the primary applicant to be "Actively at work". You may not proceed with this enrollment.',buttons:{stop:{className:'btn-danger',label:'Stop Enrollment',callback:function(){window.location.href='/enrollment-cases';}},continue:{label:'Ignore and Continue',className:'btn-default'}}});};self.aaw_is_yes=ko.pureComputed(function(){return self.is_employee_actively_at_work()===true;});self.aaw_is_no=ko.pureComputed(function(){return self.is_employee_actively_at_work()===false;});self.employee_or_first=ko.pureComputed(function(){return self.employee().first()?self.employee().first():'employee';});}
function handle_remote_error(request,retry_callback){if(request.status==401){if(ui.account_href!=null){prompt_login(retry_callback);}else{login_reauth(null,null,retry_callback);}}else{alert("Sorry, an error occurred communicating with the server.");}}
function prompt_login(callback){bootbox.confirm({message:"Please type your password to login again: <input id='password' class='form-control' placeholder='Password' type='password'/>",title:"Session Timed Out, Please Re-Login:",buttons:{"cancel":{"label":"Cancel"},"confirm":{"label":"Login","className":"width-35 pull-right btn btn-primary"}},callback:function(result){if(result==true){login_reauth(ui.account_href,$('#password').val(),callback);}}});}
function login_reauth(account_href,password,callback){var post_data={"account_href":account_href,"password":password,"success_message":"You were re-authenticated successfully.  Please continue with the application.","session_data":{"is_self_enroll":ui.is_self_enroll(),"active_case_id":ui.case_id,"enrolling_census_record_id":ui.record_id}};ajax_post('/reauth',post_data,function(reauth_response){bootbox.alert(reauth_response.message);if(callback){callback(true);}},function(){bootbox.alert("There was a problem reauthenticating. Please try again.");if(callback){callback(false);}},true);}
function ajax_post(url,data,on_success,on_error,is_json){var options={data:data,error:on_error,success:on_success,dataType:"json",method:"POST"};if(is_json===true){options.contentType="application/json; charset=utf-8";options.processData=false;options.data=JSON.stringify(data);}
$.ajax(url,options);}
return{WizardVM:WizardVM};})
();var agent_inbox=(function(){var AgentInboxViewModel=function(agent_id){var self=this;self.current_agent_id=agent_id;self.is_loading=ko.observable(true);self.envelopes=ko.observableArray([]);self.pending_envelopes=ko.pureComputed(function(){return _.filter(self.envelopes(),function(e){return e.is_pending();});});self.completed_envelopes=ko.pureComputed(function(){return _.filter(self.envelopes(),function(e){return e.is_completed();});});self.sign_envelope=function(){var envelope_id=$(this).attr("data-id");sign_envelope(envelope_id,{from_inbox:true}).success(function(resp){var data=resp.data;if(data.errors&&data.errors.length>0&&data.errors[0].reason==="voided_envelope"){var envelope=_.find(self.envelopes(),function(e){return e.id===envelope_id});if(envelope){self.envelopes.remove(envelope);}}});};self.table_options={order:[[2,"asc"]],columns:[{sortable:false,data:function(row){var icon_class;if(row.should_show_sign_button(self.current_agent_id)){icon_class="glyphicon glyphicon-pencil";}else if(row.should_show_view_button(self.current_agent_id)){icon_class="glyphicon glyphicon-file";}else{return"";}
return'<button class="btn btn-primary btn-xs sign-button" data-id="'+row.id+'"><span class="ace-icon '+icon_class+'"></span> '+row.button_text+'</button>';}},{data:"status"},{data:"timestamp",visible:false},{data:"formatted_timestamp",orderData:[2]},{data:"agent"},{data:"group"},{data:function(row){return"<a href='/enrollment-case/"+row.case_id+"/census/"+row.census_record_id+"'>"+row.employee_first+"</a>";}},{data:function(row){return"<a href='/enrollment-case/"+row.case_id+"/census/"+row.census_record_id+"'>"+row.employee_last+"</a>";}}]};fetch_envelopes(self.is_loading,self.envelopes);$("body").on("click","button.sign-button",self.sign_envelope);};var EnvelopeViewModel=function(envelope){var self=this;self.id=envelope.id;self.case_id=envelope.case_id;self.census_record_id=envelope.census_record_id;self.application_status=envelope.application_status;self.agent_signing_status=envelope.agent_signing_status;self.employee_signing_status=envelope.employee_signing_status;self.employee_signing_datetime=envelope.employee_signing_datetime;self.agent_signing_datetime=envelope.agent_signing_datetime;if(self.employee_signing_status==="pending"||self.employee_signing_status==="declined_to_sign"){self.status="Pending Employee";self.button_text="Sign";self.timestamp=envelope.timestamp;self.formatted_timestamp=format_time();}else if(self.agent_signing_status===null||self.agent_signing_status==="pending"){self.status="Pending Agent";self.button_text="Sign";self.timestamp=envelope.timestamp;self.formatted_timestamp=format_time();}else if(self.agent_signing_status==="signed"){self.status="Complete";self.button_text="View";self.timestamp=(self.employee_signing_datetime)?self.employee_signing_datetime:self.agent_signing_datetime;self.formatted_timestamp=format_time();}else if(self.agent_signing_status==="declined_to_sign"){self.status="Agent Declined";self.timestamp=envelope.timestamp;self.formatted_timestamp=format_time();}else{self.status="Unknown";self.button_text="";self.timestamp=envelope.timestamp;self.formatted_timestamp=format_time();}
self.group=envelope.group;self.agent=envelope.agent;self.employee_first=envelope.employee_first;self.employee_last=envelope.employee_last;self.agent_id=envelope.agent_id;self.is_pending=function(){return self.agent_signing_status!=="signed"&&self.agent_signing_status!=="declined_to_sign"&&self.application_status!=="voided";};self.is_completed=function(){return self.agent_signing_status==="signed"&&self.application_status!=="voided";};self.should_show_sign_button=function(current_agent_id){return self.button_text==="Sign"&&(current_agent_id===self.agent_id||self.agent_id===null);};self.should_show_view_button=function(current_agent_id){return self.button_text==="View";};function format_time(){return moment(self.timestamp).format("MM/DD/YYYY h:mma");}};function fetch_envelopes(loading_observable,envelopes_observable){loading_observable(true);$.ajax("/envelopes").success(function(data){loading_observable(false);var envelopes=_.map(data.data,function(envelope_data){return new EnvelopeViewModel(envelope_data);});envelopes_observable(envelopes);})}
function sign_envelope(envelope_id,options){var url="/envelopes/"+envelope_id+"/sign";if(options&&options.from_inbox){url+="?from=inbox";}
var req=$.post(url).success(function(data){return handle_signing_redirect(envelope_id,data)}).error(handle_signing_failure);bootbox.alert("Redirecting to signing page, please wait...");return req;}
function handle_signing_redirect(envelope_id,resp){var data=resp.data;if(data.errors.length>0){bootbox.hideAll();bootbox.alert(data.errors[0].message);return;}
window.location.href=data.url;}
function handle_signing_failure(data){bootbox.hideAll();bootbox.alert("There was a problem redirecting to the signing page.");}
return{init_viewmodel:function(params){return new AgentInboxViewModel(params);},sign_envelope:function(envelope_id){return sign_envelope(envelope_id);}}})();var case_management=(function(){var loading_html="<span class='icon-spinner icon-spin grey bigger-200'></span> <span class='bigger-175'> Loading data...</span>";function refresh_census_table(case_id,url,table_selector,loading_selector,init_callback,no_data_cb,success_callback){var loading=$(loading_selector);var table=$(table_selector);var table_settings={"responsive":{breakpoints:get_responsive_datatables_breakpoints()},"autoWidth":false,"processing":true,"pagingType":"full","serverSide":true,"ajax":"/cases/"+case_id+"/census_records","columnDefs":[{targets:[0],sortable:false,name:"action",data:function(row){if(row.enrollment_status==="enrolled"){return'<button class="btn btn-primary btn-xs enroll-employee" data-id="'+row.id+'"><span class="ace-icon glyphicon glyphicon-plus"></span> Add Coverage</button>';}else if(row.enrollment_status==="pending_employee"||row.enrollment_status==="pending_agent"){return"";}else{return'<button class="btn btn-primary btn-sm enroll-employee" data-id="'+row.id+'">Enroll</button>';}}},{targets:[1],name:"status",data:function(row){return format_enrollment_status_html(row.enrollment_status);}},{targets:[2],name:"employee_first",data:function(row){return"<a href='/enrollment-case/"+row.case_id+"/census/"+row.id+"'>"+row.employee_first+"</a>";}},{targets:[3],name:"employee_last",data:function(source){return"<a href='/enrollment-case/"+source.case_id+"/census/"+source.id+"'>"+source.employee_last+"</a>";}},{targets:[4],sortable:false,name:"employee_birthdate",data:function(source){return normalize_date(source.employee_birthdate);}},{targets:[5],sortable:false,name:"employee_email",data:"employee_email",className:"min-breakIII"}],sorting:[[3,"asc"]]};table.show();$(".no-census-header").hide();if(!$.fn.DataTable.fnIsDataTable(table[0])){table.wrap("<div class='dataTables_borderWrap' />").DataTable(table_settings);}else{table.DataTable().columns.adjust().draw();}}
function refresh_enrollments_table(case_id,url,table_selector,loading_selector,table_options,init_callback){var loading=$(loading_selector);var table=$(table_selector);var table_defaults={"responsive":{breakpoints:get_responsive_datatables_breakpoints()},"autoWidth":false,"processing":true,"pagingType":"full","serverSide":true,"ajax":"/cases/"+case_id+"/enrollment_records","columnDefs":[{"targets":[0],name:"date","data":function(source){return format_date(parse_date(source.date));},"className":"min-breakII"},{"targets":[1],name:"employee_first","data":function(row){return"<a href='/enrollment-case/"+row.case_id+"/census/"+row.census_record_id+"'>"+row.employee_first+"</a>";}},{"targets":[2],name:"employee_last","data":function(row){return"<a href='/enrollment-case/"+row.case_id+"/census/"+row.census_record_id+"'>"+row.employee_last+"</a>";}},{"targets":[3],name:"employee_birthdate",sortable:false,"data":function(source){return format_date(parse_date(source.employee_birthdate,"YYYY-MM-DD"));},"className":"min-breakI"},{targets:[4],name:"agent_name",data:"agent_name","className":"min-breakII"},{"targets":[5],name:"enrollment_status","data":function(source){return format_enrollment_status_html(source.enrollment_status)},className:"min-breakV"},{"targets":[6],name:"total_premium","data":function(source){return'$'+source.total_premium;},className:"text-right"}],"sorting":[[2,"asc"]],"displayLength":25};var table_settings=$.extend({},table_defaults,table_options||{});if(!table_exists(table)){table.show();table.wrap("<div class='dataTables_borderWrap' />").DataTable(table_settings);init_callback(table);}else{table.DataTable().columns.adjust().draw();}}
function table_exists(table){return $.fn.DataTable.fnIsDataTable(table.get(0));}
function clear_table(table){if($.fn.DataTable.fnIsDataTable(table.get(0))){table.dataTable().fnClearTable();}}
function update_table_data(table,data){table.dataTable().fnAddData(data);table.DataTable().columns.adjust().draw();}
function init_data_table(table,table_settings,data,init_callback){table.show();table_settings.aaData=data;table.wrap("<div class='dataTables_borderWrap' />").dataTable(table_settings);if(init_callback!==undefined){init_callback(table);}
table.DataTable().columns.adjust().draw();}
var _alphabet_search_letter;$.fn.dataTableExt.afnFiltering.push(function(oSettings,aData,iDataIndex){if(!_alphabet_search_letter){return true;}
var last_name_col=3;return(aData[last_name_col]&&aData[last_name_col].charAt(0)===_alphabet_search_letter);});function init_alphabet_search(table){var alphabet=$('<div class="alphabet hidden-sm hidden-xs"/>').append('Last Name: ');$('<span class="clear active"/>').data('letter','').html('Reset').appendTo(alphabet);for(var i=0;i<26;i++){var letter=String.fromCharCode(65+i);$('<span class="letter"/>').data('letter',letter).html(letter).appendTo(alphabet);}
alphabet.insertBefore(table);alphabet.on('click','span',function(){alphabet.find('.active').removeClass('active');$(this).addClass('active');_alphabet_search_letter=$(this).data('letter');table.fnDraw();});}
var _should_show_enrolled=true;$.fn.dataTableExt.afnFiltering.push(function(oSettings,aData,iDataIndex){if(_should_show_enrolled){return true;}
return(aData[1]==="Not Enrolled");});function init_status_filter(table){var ctn=$('<div class="status-filter">');ctn.html("<label><input type='checkbox' class='ace' checked='checked'> <span class='lbl'> Show Enrolled</span></label>");ctn.on('change','input',function(){_should_show_enrolled=$(this).prop("checked");table.fnDraw();});ctn.insertBefore(table);}
return{refresh_census_table:refresh_census_table,refresh_enrollments_table:refresh_enrollments_table,init_alphabet_search:init_alphabet_search,init_status_filter:init_status_filter};})();var DEFAULT_OCCUPATION_LABEL='Default';var OccupationVM=(function(label,level,has_applicants){'use strict';var self=this;self.has_applicants=!!has_applicants;self.label=label;self.serialize_object=function(){return{product_id:self.product_id,label:self.label};};});function sort_occupations(occupations){if(!Array.isArray(occupations)){return null;}
var new_occupations=[];var default_occupation=_.find(occupations,function(occupation){return occupation.label===DEFAULT_OCCUPATION_LABEL;});if(default_occupation){new_occupations.push(default_occupation);}
var sorted_occupations=_.chain(occupations).filter(function(occupation){return occupation.label!==DEFAULT_OCCUPATION_LABEL;}).sortBy('label').value();_.forEach(sorted_occupations,function(occupation){new_occupations.push(occupation);});return new_occupations;}
function format_face_value(val){if(val==null){return"(NA)";}
return"$"+numberWithCommas(val);}
function format_premium_value(val){if(val==null){return"(NA)";}
return"$"+numberWithCommas(val.toFixed(2));}
function handle_remote_error(){alert("Sorry, an error occurred communicating with the server.");}
function ajax_post(url,data,on_success,on_error,is_json){var options={data:data,error:on_error,success:on_success,dataType:"json",method:"POST"};if(is_json===true){options.contentType="application/json; charset=utf-8";options.processData=false;options.data=JSON.stringify(data);}
$.ajax(url,options);}
function init_case_riders(riders){window.ui.selected_riders["emp"](riders.slice());window.ui.selected_riders["sp"](riders.slice());window.ui.case_riders(riders);}
function init_enrollment_riders(riders){window.ui.enrollment_riders(riders);}
ko.bindingHandlers.wysiwyg=(function(){var toolbars={simple:['bold','italic','underline',null,'createLink','unlink',null,null,null,'undo','redo'],full:[null,null,null,'bold','italic','strikethrough','underline',null,'insertunorderedlist','insertorderedlist',null,'outdent','indent',null,'justifyleft','justifycenter','justifyright','justifyfull',null,{name:'createLink',placeholder:'URL',button_class:'btn-purple',button_text:'Add'},'unlink',null,{name:'insertImage',placeholder:'Image URL',button_insert_class:'btn-purple',button_insert:'Add',choose_file:true,button_class:'btn-success',button_text:'Choose an Image'},null,'foreColor',null,'undo','redo']};return{init:function(element,valueAccessor,allBindings,viewModel,bindingContext){var va=valueAccessor();var html=va.value,type=va.type;var toolbar=toolbars[type]||toolbars.simple;$(element).ace_wysiwyg({toolbar:toolbar});$(element).html(ko.unwrap(html));$(element).on("change",function(){html($(element).html());});},update:function(element,valueAccessor){var updated_html=ko.unwrap(valueAccessor().value);if($(element).html()!=updated_html){$(element).html(updated_html);}}};})();ko.components.register('case-report',{viewModel:{createViewModel:function(params,componentInfo){return new CaseReportsViewModel(params);}},template:{element:'case-report-template'}});ko.subscribable.fn.watch=function(a,b,c,d){var e=typeof a;return"boolean"===e||"undefined"===e?ko.watch(this,{enabled:a!==!1}):"function"!==e||ko.isSubscribable(a)?ko.watch(a,b,c,d||this):ko.watch(this,b||{},a,d||this),this},ko.watch=function(a,b,c,d){function e(h,i,j,k,l,m){if(h&&0!==b.depth&&(-1===b.depth||j.length<(b.depth||1))){if(b.watchedOnly&&!h.watchable&&h!=a)return;if((b.enabled===!1||b.enabled===!0)&&(h.watchable=b.enabled),h.watchable===!1)return;b.seal===!0&&(h.watchable=!1);var n=typeof h;if("object"===n||"function"===n){if(h._watcher===d)return;if(b.hide&&ko.utils.arrayIndexOf(b.hide,h)>-1)return;var o=[].concat(j,i&&i!==a?i:[]);if("function"!==n){if("[object Object]"===Object.prototype.toString.call(h))ko.utils.objectForEach(h,function(a,c){if(c=b.getter?b.getter.call(d,o,h,a):c){if(b.wrap){var f=Object.prototype.toString.call(c);"[object Function]"!==f&&"[object Object]"!==f&&(b.beforeWrap&&b.beforeWrap.call(d,o,h,c)===!1||(c=h[a]="[object Array]"===f?ko.observableArray(c):ko.observable(c)))}b.unloop&&(c._watcher=k?void 0:d);var g=e(c,l?null:h,o,k,null,a);b.tagFields&&void 0===c._fieldName&&(g||"parentsOnly"!==b.tagFields&&"function"==typeof c||"object"==typeof c)&&(c._fieldName=a)}});else if(b.hideArrays!==!0)for(var p=0;p<h.length;p++)e(h[p],l?null:h,o,k);return!0}if("function"==typeof h.notifySubscribers&&c){if(b.enabled===!0&&h.watchable===!1)return;if(k||!b.beforeWatch||b.beforeWatch.call(d,o,h,m)!==!1){var q="function"==typeof h.pop;if(k?f(h):g(h,q,o,l),q)return e(h(),l?null:h,o,k,!0),!0;if(b.hideWrappedValues!==!0)return e(h(),l?null:h,o,k,!0)}}}}}function f(a){var c=a[h];if(!c)throw"Subscriptions field (."+h+") not defined for observable child "+(a._fieldName||"");if(c.change)for(var e=c.change.length-1;e>=0;e--)c.change[e]._watcher===d&&c.change[e].dispose();if(c.beforeChange&&(b.mutable||b.oldValues>0))for(var e=c.beforeChange.length-1;e>=0;e--)c.beforeChange[e]._watcher===d&&c.beforeChange[e].dispose();if(c.arrayChange)for(var e=c.arrayChange.length-1;e>=0;e--)c.arrayChange[e]._watcher===d&&c.arrayChange[e].dispose()}function g(a,f,g,h){f?a.subscribe(function(b){ko.utils.arrayForEach(b,function(b){var f=c.call(d,g,a,b);void 0!==f&&d(f),b.moved||setTimeout(function(){e(b.value,h?null:a,g,"deleted"===b.status)},0)})},void 0,"arrayChange")._watcher=d:(a.subscribe(function(){if(a.watchable!==!1){var f=c.call(d,g,a);void 0!==f&&d(f),b.mutable&&"object"==typeof a()&&e(a(),h?null:a,g)}},null,"change")._watcher=d,(b.oldValues>0||b.mutable)&&(a.subscribe(function(c){if(b.oldValues>0){var d=a.oldValues?a.oldValues:a.oldValues=[];for(d.unshift(c);d.length>b.oldValues;)d.pop()}b.mutable&&"object"==typeof c&&e(c,h?null:a,g,!1,!0)},null,"beforeChange")._watcher=d))}"function"==typeof b&&(d=d||c,c=b,b={}),d=d||this;var h;switch(ko.DEBUG||ko.version){case!0:h="_subscriptions";break;case"3.0.0":h="F";break;case"3.1.0":h="H";break;case"3.2.0":h="M";break;case"3.3.0":h="G";case"3.4.0":h="K";break;default:throw"Unsupported Knockout version. Only v3.0.0 to v3.4.0 are supported when minified. Current version is "+ko.version}return"function"!=typeof a||ko.isSubscribable(a)?(e(a,null,[]),{dispose:function(){e(a,null,[],!0)}}):ko.computed(a,c,b)};window.foo="1.3.6";var urls=(function urls(){return{get_manage_cases_url:function(){return'/enrollment-cases';},get_manage_case_url:function(case_id){return'/enrollment-case/'+case_id;},get_cases_api_url:function(){return"/cases";},get_case_api_url:function(case_id){return'/cases/'+case_id;},get_case_api_enrollment_periods_url:function(case_id){return'/cases/'+case_id+'/enrollment_periods';},get_case_api_enrollment_report_url:function(case_id){return'/cases/'+case_id+'/enrollment_report';},get_case_api_self_enrollment_url:function(case_id){return'/cases/'+case_id+'/self_enrollment_setup';},get_case_api_agent_splits_url:function(case_id){return'/cases/'+case_id+'/agent_splits_setup';},get_case_api_enrollment_records_url:function(case_id){return'/cases/'+case_id+'/enrollment_records';},get_case_api_enrollment_record_url:function(case_id,census_record_id){return'/cases/'+case_id+'/enrollment_records/'+census_record_id;},get_case_api_census_records_url:function(case_id){return'/cases/'+case_id+'/census_records';},get_case_api_census_record_url:function(case_id,census_record_id){return'/cases/'+case_id+'/census_records/'+census_record_id;},get_case_api_census_email_batches:function(case_id){return"/cases/"+case_id+"/self_enroll_email_batches"},get_case_api_census_email_batch_preview_url:function(case_id,batch_id){return"/batch-info/"+case_id+"/preview/"+batch_id},get_case_api_census_email_batch_logs_url:function(case_id,batch_id){return"/batch-info/"+case_id+"/logs/"+batch_id;},get_case_email_self_enrollment_batches_url:function(case_id){return'/cases/'+case_id+'/self_enroll_email_batches';},get_case_email_self_enrollment_batch_url:function(case_id,batch_id){return'/cases/'+case_id+'/self_enroll_email_batches/'+batch_id;},get_product_api_url:function(product_id){return'/products/'+case_id;},get_in_person_enrollment_url:function(){return'/in-person-enrollment';},get_submit_enrollment_records_url:function(){return'/enrollments';},get_delete_enrollment_record_url:function(id){return'/enrollments/records/'+id;},get_flat_file_documentation_url:function(){return"/flat_file_documentation.html";},get_csv_import_documentation_url:function(){return"/delimited_file_import_documentation.html";}}})();$(function(){$.ajaxSetup({cache:false});});function send_form_data(method,url,data,on_success,on_error){return submit_data(method,url,data,true,on_success,on_error);}
function send_file_data(method,url,data,on_success,on_error){return submit_data(method,url,data,false,on_success,on_error,false);}
function send_json_data(method,url,data,on_success,on_error){return submit_data(method,url,JSON.stringify(data),false,on_success,on_error,'application/json');}
function get_loading_html(message){var text=message||"Loading data...";return'<div class="text-center">'+"<h4>"+text+"</h4>"+'<i class="icon-spinner icon-spin grey bigger-200"></i>'+"</div>";}
function format_enrollment_status_text(status){if(status==="enrolled"){return"Enrolled";}else if(status==="declined"){return"Declined";}else if(status==="pending_employee"){return"Pending Employee";}else if(status==="pending_agent"){return"Pending Agent";}else{return"Not Enrolled";}}
function format_enrollment_status_html(status){var status_text=format_enrollment_status_text(status);if(status_text==="Not Enrolled"){return status_text;}else{if(status_text==="Enrolled"){return"<span class='enroll-status ace-icon glyphicon glyphicon-ok'> </span><span class='enroll-status'> Enrolled</span>";}else if(status_text==="Pending Employee"||status_text==="Pending Agent"){return"<span class='enroll-status pending icon glyphicon glyphicon-pencil'></span><span class='enroll-status pending'>"+status_text+"</span>";}else{return"<span class='ace-icon glyphicon glyphicon-remove error'></span> <span class='enroll-status declined'> Declined</span>";}}}
function parse_month_date_input(val){return parse_date(val,"MM/DD");}
function today_between(start,end){var today=moment();var is_after_start=today.isSameOrAfter(moment(start),'day');if(!moment(end).isValid()){return is_after_start;}else{var is_before_end=today.isSameOrBefore(moment(end),'day');return is_after_start&&is_before_end}}
function parse_date(date_str,format_str){if(format_str===undefined){format_str=["YYYY-MM-DD","MM/DD/YYYY"];}
return moment(date_str,format_str);}
function normalize_date(date_str){if(date_str!=''&&is_valid_date(date_str)){return format_date(parse_date(date_str));}else{return'';}}
function normalize_date_of_birth(date_of_birth_string){'use strict';if(date_of_birth_string&&is_valid_date_of_birth(date_of_birth_string)){return format_date(parse_date(date_of_birth_string));}else{return'';}}
function is_valid_date(date_str,format_str){var date=parse_date(date_str,format_str);return date.isValid();}
function is_valid_date_of_birth(date_of_birth){'use strict';if(!date_of_birth){return false;}
var dob_moment=moment.isMoment(date_of_birth)?date_of_birth:moment(date_of_birth,'MM/DD/YYYY');if(!dob_moment.isValid()){dob_moment=moment(date_of_birth,'YYYY-MM-DD');}
var today=moment({hour:0,minute:0,seconds:0,milliseconds:0});return dob_moment.isValid()&&dob_moment.isBefore(today);}
function get_date_of_birth_validation_error(date_of_birth){'use strict';if(!date_of_birth){return null;}
var dob_moment=moment.isMoment(date_of_birth)?date_of_birth:moment(date_of_birth,'MM/DD/YYYY');if(!dob_moment.isValid()){return'Date is invalid.';}
var today=moment({hour:0,minute:0,seconds:0,milliseconds:0});if(dob_moment.isAfter(today)){return'Date must be before today.';}
return null;}
function format_date(moment_date){return moment_date.format("MM/DD/YYYY");}
function now(){return moment();}
function get_responsive_datatables_breakpoints(){return[{name:'breakI',width:Infinity},{name:'breakII',width:1024},{name:'breakIII',width:768},{name:'breakIV',width:600},{name:'breakV',width:560},{name:'smallphone',width:480}];}
function submit_data(method,url,data,should_process_data,on_success,on_error,contentType){on_success=on_success||function(){};on_error=on_error||function(){};var options={url:url,type:method,data:data,dataType:'json',success:function(results){on_success(results);},error:function(xhr){on_error(xhr);}};if(!should_process_data){options.processData=false;}
if(contentType!==undefined){options.contentType=contentType;}
return $.ajax(options);}
function submit_to_url(url,data){var form=document.createElement('form');for(k in data){if(data.hasOwnProperty(k)){$("<input>",{name:k,value:data[k]}).appendTo(form);}}
form.method="POST";form.action=url;var wrapper=$("<div>");wrapper.appendTo("body").hide();$(form).appendTo(wrapper).submit();}
function show_all_errors(all_errors){if(Object.keys(all_errors).length==0){return;}
$(".submit-message").addClass("error").html("Please fix the indicated problems and resubmit.").show();$.each(all_errors,function(field_name,errors){show_errors(field_name,errors);});focus_first_error(all_errors);}
function show_errors(field_name,field_error_messages){get_field(field_name).after($("<div>").addClass("error").html(field_error_messages.join("<br>")));}
function get_field(field_name){return $("textarea[name="+field_name+"], select[name="+field_name+"], input[name="+field_name+"], #"+field_name);}
function focus_first_error(errors){$.each(errors,function(field_name,errors){get_field(field_name).focus();})}
function hide_all_errors(){$(".submit-message").removeClass("error").hide();$(".error").remove();}
function numberWithCommas(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");}
ko.bindingHandlers.modal={update:function(element,valueAccessor){if(ko.unwrap(valueAccessor())){$(element).modal('show');}else{$(element).modal('hide');}}};ko.bindingHandlers.dataTable={update:function(element,valueAccessor){var bind_opts=ko.unwrap(valueAccessor());var datatable_opts=$.extend({},bind_opts.options);var data_observable=bind_opts.data;var updated_data=data_observable();if(!$.fn.DataTable.fnIsDataTable(element)&&updated_data.length>0){datatable_opts.data=updated_data;$(element).DataTable(datatable_opts);}else if(updated_data.length>0){var table=$(element).DataTable();table.clear();table.rows.add(updated_data).draw();}}};ko.bindingHandlers.flashMessage={update:function(element,valueAccessor){$(element).html(ko.unwrap(valueAccessor())).delay(5000).hide('fade')}};ko.bindingHandlers.maskedInput={init:function(element,valueAccessor){$(element).mask(ko.unwrap(valueAccessor()));}};ko.bindingHandlers.slideDownIf={init:function(element,value_accessor){var val=ko.unwrap(value_accessor());$(element).toggle(val);},update:function(element,value_accessor){var val=ko.unwrap(value_accessor());if(val){$(element).slideDown(400);}else{$(element).slideUp(400);}}};ko.bindingHandlers.fadeInIf={init:function(element,value_accessor){var val=ko.unwrap(value_accessor());$(element).toggle(val);},update:function(element,value_accessor){var val=ko.unwrap(value_accessor());if(val){$(element).fadeIn(400);}else{$(element).fadeOut(400);}}};ko.bindingHandlers.multiSelect={init:function(element,valueAccessor,allBindings,viewModel){valueAccessor().observed.subscribe(function(newVal){console.log(newVal);$(element).multiselect('deselectAll');$(element).multiselect('select',newVal);});$(element).multiselect(valueAccessor().options);},update:function(element,valueAccessor,allBindings,viewModel){$(element).multiselect('refresh');}};ko.bindingHandlers.dualListbox={init:function(element,valueAccessor){valueAccessor().observed();$(element).bootstrapDualListbox(valueAccessor().options);},update:function(element,valueAccessor){$(element).bootstrapDualListbox("refresh");}};ko.bindingHandlers.uniqueNameValidation={init:function(element,valueAccessor,allBindings,viewModel,bindingContext){var value=valueAccessor();var remoteInvocation=value.remoteMethod;var tracked_observable=value.uniqueObservable;tracked_observable.has_been_checked=ko.observable(false);tracked_observable.is_checking=ko.observable(false);tracked_observable.is_unique=ko.observable(null);tracked_observable.unique_value=null;tracked_observable.subscribe(function(current_value){tracked_observable.is_unique(null);tracked_observable.is_checking(true);tracked_observable.has_been_checked(false);remoteInvocation(current_value,function(is_unique){tracked_observable.unique_value=current_value;tracked_observable.is_unique(is_unique);tracked_observable.is_checking(false);tracked_observable.has_been_checked(true);});});}};$(function(){$('body').on('focus','[contenteditable]',function(){var $this=$(this);$this.data('before',$this.html());return $this;}).on('blur keyup paste input','[contenteditable]',function(){var $this=$(this);if($this.data('before')!==$this.html()){$this.data('before',$this.html());$this.trigger('change');}
return $this;});});var FlashMessages=function(){var self=this;self.messages=ko.observableArray();self.clear=function(){_.invoke(self.messages(),"dismiss");};self.flash_error=function(message){self.messages.push(new FlashMessage({message:message,type:"error"}));};self.flash_success=function(message){self.messages.push(new FlashMessage({message:message,type:"success"}));};};var FlashMessage=function(message_obj){var self=this;self.message=message_obj.message;self.type=message_obj.type;self.is_visible=ko.observable(true);self.is_error=function(){return self.type==="error";};self.is_success=function(){return self.type==="success";};self.dismiss=function(){self.is_visible(false);}};ko.components.register('flash-messages',{viewModel:function(params){var self=this;self.flash_messages=params.messages;},template:'\
  <!--ko foreach: flash_messages.messages-->\
  <div class="alert alert-block" \
  data-bind="visible: is_visible, \
  css: {\'alert-success\': is_success(), \'alert-danger\': is_error()}">\
  <button type="button" class="close" data-bind="click: dismiss">\
  <i class="ace-icon fa fa-times"></i>\
  </button>\
  \
  <p>\
  <strong data-bind="visible: is_success()">\
  <i class="ace-icon fa fa-check"></i>\
  </strong>\
  \
  <strong data-bind="visible: is_error()">\
  <i class="ace-icon fa fa-exclamation-triangle"></i>\
  </strong>\
  <span data-bind="html: message"></span>\
  </p>\
  </div>\
  <!--/ko-->'});ko.components.register('loading-modal',{viewModel:function(params){var self=this;self.options=params.options;self.defaults={message:"Loading...",title:"Please Wait"};self._current_settings=ko.pureComputed(function(){return $.extend({},self.defaults,self.options()||{});});self.message=ko.pureComputed(function(){return self._current_settings().message;});self.title=ko.pureComputed(function(){return self._current_settings().title;});self.is_showing=ko.pureComputed(function(){return self.options()!==null;});},template:'\
  <div class="modal fade" data-bind="modal: is_showing">\
  <div class="modal-dialog">\
  <div class="modal-content">\
  <div class="modal-header">\
  <button type="button" class="close" data-dismiss="modal"><span\
  aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>\
  <h4 class="modal-title" data-bind="html: title">Please wait</h4>\
  </div>\
  <div class="modal-body">\
  <div class="form-panel modal-panel">\
  <div class="text-center">\
  <h4 data-bind="html: message"></h4>\
  <i class="ace-icon fa fa-spinner fa-spin grey bigger-200"></i>\
  </div>\
  </div>\
  </div>\
  <div class="modal-footer">\
  </div>\
  </div>\
  <!-- /.modal-content -->\
  </div>\
  <!-- /.modal-dialog -->\
  </div>\
  '});ko.components.register('height-select',{viewModel:function(params){var self=this;self.height=params.value;self.required=params.required||false;self.name_suffix=params.name_suffix||null;self.height_feet_part=ko.observable(""+get_feet_part(self.height()));self.height_inches_part=ko.observable(""+get_inches_part(self.height()));self.update_height=function(){var feet=parseInt(self.height_feet_part());var inches=parseInt(self.height_inches_part());if(feet===null||isNaN(feet)||inches===null||isNaN(inches)){self.height(null);}else{self.height((12*feet)+inches);}};self.height_feet_part.subscribe(self.update_height);self.height_inches_part.subscribe(self.update_height);},template:'\
  <label>\
  Height:\
  <select data-bind="value: height_feet_part, attr: {name: \'height_feet_\'+name_suffix}">\
  <option></option>\
  <option>4</option>\
  <option>5</option>\
  <option>6</option>\
  </select> Feet\
  </label>\
  <label>\
  <select data-bind="value: height_inches_part, attr: {name: \'height_inches_\'+name_suffix}">\
  <option></option>\
  <option>0</option>\
  <option>1</option>\
  <option>2</option>\
  <option>3</option>\
  <option>4</option>\
  <option>5</option>\
  <option>6</option>\
  <option>7</option>\
  <option>8</option>\
  <option>9</option>\
  <option>10</option>\
  <option>11</option>\
  </select> Inches\
  </label>'});function get_feet_part(val){if(val===null||val===undefined){return null;}else{return Math.floor(parseInt(val)/12);}}
function get_inches_part(val){if(val===null||val===undefined){return null;}else{return Math.floor(parseInt(val)%12);}}
ko.components.register('limited-state-select',{viewModel:function(params){this.limiter=params.limiter;this.is_disabled=ko.observable(params.disabled||false);},template:'<select name="enrollmentState" id="enrollmentState" data-bind="\
  value: limiter.selected_state,\
  options: limiter.available_states,\
  optionsCaption: \'(Select State)\',\
  optionsText: \'statecode\',\
  optionsAfterRender: limiter.disable_state_option_if_invalid,\
  disable: is_disabled\
  "></select>'});ko.components.register('limited-product-select',{viewModel:function(params){this.limiter=params.limiter;this.is_disabled=ko.observable(params.disabled||false);this.is_mulit_select=params.is_multi_select||false;},template:'<select multiple name="productID" id="productID" data-bind="\
  selectedOptions: limiter.selected_products, \
  options: limiter.available_products,\
  optionsText: \'name\', \
  optionsAfterRender: limiter.disable_product_option_if_invalid,\
  disable: is_disabled\
  "> \
  </select>'});var ProductStatesLimiterViewModel=function(product_statecode_mapping,selected_state,available_states,selected_products,available_products){var self=this;self.product_state_mapping=map_states_to_products_from_statecode_map(available_states,product_statecode_mapping);self.selected_state=selected_state;self.available_states=available_states;self.selected_products=selected_products;self.available_products=available_products;self.is_valid_product_for_state=function(product,state){if(!state){return true;}
return _.contains(self.product_state_mapping[product.id],state);};self.is_state_disabled=function(state){return!_.contains(self.enabled_states(),state);};self.is_product_disabled=function(product){return!_.contains(self.enabled_products(),product);};self.disable_product_option_if_invalid=function(option,product){if(product===undefined){return;}
ko.applyBindingsToNode(option,{disable:ko.computed(function(){return self.is_product_disabled(product);})},product);};self.disable_state_option_if_invalid=function(option,state){if(state===undefined){return;}
ko.applyBindingsToNode(option,{disable:ko.computed(function(){return self.is_state_disabled(state);})},state);};self.enabled_states=ko.computed(function(){return _.filter(self.available_states,function(state){return _.all(self.selected_products(),function(product){return self.is_valid_product_for_state(product,state);});});});self.enabled_products=ko.computed(function(){if(self.selected_state()!==null&&self.selected_state()){return _.filter(self.available_products(),function(product){return self.is_valid_product_for_state(product,self.selected_state());});}
return self.available_products();});};function map_states_to_products_from_statecode_map(available_states,product_state_mapping){var states_for_products={};_.each(product_state_mapping,function(statecodes,product_id){states_for_products[product_id]=[];_.each(statecodes,function(statecode){var matched_state=_.find(available_states,function(s){return s.statecode==statecode;});if(matched_state){states_for_products[product_id].push(matched_state);}});});return states_for_products;}
var StatesLimiterViewModel=function(product_statecode_mapping,selected_state,available_states,selected_products){var self=this;self.available_states=available_states;self.selected_state=selected_state;self.product_state_mapping=map_states_to_products_from_statecode_map(available_states,product_statecode_mapping);self.is_valid_product_for_state=function(product,state){return _.contains(self.product_state_mapping[product.id],state);};self.is_state_disabled=function(state){return!_.contains(self.enabled_states(),state);};self.disable_state_option_if_invalid=function(option,state){if(state===undefined){return;}
ko.applyBindingsToNode(option,{disable:ko.computed(function(){return self.is_state_disabled(state);})},state);};self.enabled_states=ko.computed(function(){return _.filter(self.available_states,function(state){return _.all(selected_products(),function(product){return self.is_valid_product_for_state(product,state);});});});selected_products.subscribe(function(products){if(!_.any(products,function(product){return self.is_valid_product_for_state(product,self.selected_state());})){self.selected_state(null);}});};if(typeof Object.create!='function'){(function(){var F=function(){};Object.create=function(o){if(arguments.length>1){throw Error('Second argument not supported');}
if(o===null){throw Error('Cannot set a null [[Prototype]]');}
if(typeof o!='object'){throw new TypeError('Argument must be an object');}
F.prototype=o;return new F();};})();}
ko.components.register('delete-confirm-modal',{viewModel:function(params){var self=this;self.title=params.title;self.message=params.message;self.callback=params.callback;self.modal_observable=params.modal_observable;self.delete_confirmation_text=ko.observable("");self.is_delete_text_valid=ko.pureComputed(function(){return self.delete_confirmation_text()=="DELETE";});},template:'<div data-bind="modal: modal_observable" class="modal fade">\
    <div class="modal-dialog modal-lg">\
      <div class="modal-content">\
        <div class="modal-header">\
          <button type="button" class="close" data-dismiss="modal"><span\
                                              aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>\
          <h4 class="modal-title" data-bind="text: title"></h4>\
        </div>\
        <div class="modal-body">\
          <div class="form-panel modal-panel">\
            <div class="row">\
              <div class="col-xs-12">\
                <p data-bind="text: message">\
                \
                </p>\
                <br>\
                <label>\
                  Type DELETE in the following box to confirm this is what you want:\
                  <input data-bind="textInput: delete_confirmation_text">\
                </label>\
              </div>\
            </div>\
          </div>\
        </div>\
\
        <div class="modal-footer">\
          <div class="form-buttons buttons-panel">\
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>\
            <button class="btn btn-danger"\
                    data-bind="enable: is_delete_enrollment_modal_showing.is_delete_text_valid, click: do_delete_enrollment_record">PERMANENT DELETE</button>\
          </div>\
        </div>\
      </div>\
    </div>\
  </div>'});