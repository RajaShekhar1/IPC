{% extends "base_ace_latest.html" %}
{% set active_page = 'nav_manage_cases' -%}
{% block title %} - Agent Enrollment Cases{% endblock %}

{% block head %}
  {{ super() }}

{% endblock %}

{% block content %}

  <ul class="breadcrumb col-xs-12">
    <li><a href="{{ url_for('index') }}"><i class="ace-icon fa fa-home"></i> Home</a></li>
    <li class="active" ><i class="ace-icon fa fa-briefcase"></i> Enrollment Cases</li>
  </ul>

  <div class="col-xs-12">
    <h3 class="header header-light blue">Enrollment Cases</h3>
  </div>


  <div class="col-xs-12">
    <div class="table-header clearfix">

      <div class="pull-right">
        <a class="btn btn-info" data-toggle="modal" data-target="#new-case-modal">
          <i class="icon icon-plus"></i>
          Add New Case
        </a>
      </div>
    </div>
    {% if not agent_cases %}
      <div class="row">
        <h4 class="text-center lighter">You have not created any cases yet.</h4>
      </div>
    {% else %}
      <div class="table-responsive">
        <table id="cases_table" class="table table-striped table-bordered table-hover DTTT_selectable">
          <thead>
          <tr>
            <th>Company</th>
            <th>Location</th>
            <th>Owner Agent</th>
            <th>Product</th>
            <th>Active</th>
            <th>Created</th>
          </tr>
          </thead>
          <tbody>
          {% for case in agent_cases %}
            <tr data-case-id="{{ case.id }}" data-case-active="{{ case.can_enroll() }}">
              <td>{{ case.company_name }}</td>
              <td>{{ case.format_location() }}</td>
              <td>{{ case.format_owner_name() }}</td>
              <td>{{ case.get_product_names() }}</td>
              <td>{{ case.format_is_active() }}</td>
              <td>{{ case.format_created_date() }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

  </div>

  <form class="new-case-form form-horizontal" data-bind="submit: create_case">
    <div id="new-case-modal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span
                    aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title">Add New Case</h4>
          </div>
          <div class="modal-body">

            <div class="form-group">
              <label class="col-md-3 control-label" for="company_name">Company Name</label>
              <div class="col-md-8">
                <input type="text" class="form-control" id="company_name" name="company_name" placeholder="Company Name"
                       minlength="1" required data-bind="textInput: company_name, uniqueNameValidation: {
                                remoteMethod: check_unique_name, uniqueObservable: company_name
                            }">
              </div>
              <div class="col-md-1">
                <div class="icon-spinner text-warning bigger-125" data-bind="visible: company_name.is_checking"></div>
                <div class="icon icon-check-sign green bigger-125" data-bind="visible: company_name.is_unique() && !company_name.is_checking()"></div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-8 col-md-offset-3">
                <div class="error" data-bind="visible: company_name.has_been_checked, text: get_form_error"></div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="button" data-bind="click: create_case" class="btn btn-primary">Add Case</button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>

  </form>


{% endblock %}

{% block page_js %}
  <script>
    $(function() {

      var new_case_form = $('.new-case-form');
      new_case_form.validate({
        messages: {company_name: "Company name is required"}
      });

      function ManageCasesPage() {
        var self = this;

        self.company_name = ko.observable(null).extend({ rateLimit: 500 });

        self.check_unique_name = function(current_value, callback) {

          $.get("{{ url_for("cases.get_cases") }}", {by_name: current_value}, function(result) {
            var is_unique = (result.data.length == 0);
            callback(is_unique);
          }, "json");

        };

        self.get_form_error = ko.computed(function() {
          if ($.trim(self.company_name()) == "") {
            return "Company name is required.";
          } else if (!self.company_name.is_unique()) {
            return "The name '"+self.company_name()+"' is already used."
          }
          return "";
        });

        self.create_case = function() {

          if (!new_case_form.valid()) {
          }
          errors = self.get_form_error();
          if (errors) {
            return false;
          }
          var data = {
            company_name: $("#company_name").val()
          };

          $.ajax("{{ url_for("cases.create_case") }}", {
            type: 'POST',
            processData: false,
            contentType:'application/json',
            data: JSON.stringify(data),
            dataType:'json',
            success: function(results) {
              //var created_case = new Case(results.data);
              //self.managed_cases.push(created_case);
              window.location.href = "{{ url_for("manage_case", case_id="") }}"+results.data.id;
            },
            error: function(xhr) {
              console.log(xhr.responseJSON.errors)
            }
          });
        };
      }

      $("#cases_table").dataTable();

      $("#cases_table tbody").on("click", "tr", function() {
        var case_id = $(this).attr("data-case-id");
        var is_active = $(this).attr("data-case-active");
        var tab = (is_active !== "False") ? "enrollment" : "setup";

        var url = {{ url_for("manage_case", case_id="") }} + case_id + "#" + tab;
        location.href = url;
      });

      var form = new ManageCasesPage();
      window.form = form;

      ko.applyBindings(form);
    });
  </script>
{% endblock %}