{% extends "base.html" %}
{% from "form_macros.html" import render_field_with_errors %}
{% set active_page = 'nav_agent_manage_case' -%}
{% block title %} - Agent Manage Case{% endblock %}

{% block content %}
    <h1 class="header lighter">Edit Census Record</h1>

    <form class="form-horizontal" id="edit-record-form" action="{{ url_for("cases.update_census_record", case_id=case.id, census_record_id=census_record.id) }}">
        <div class="row">

            <div class="col-sm-6 col-xs-12">
                <h3>Employee:</h3>
                {{ render_field_with_errors(form.employee_first) }}
                {{ render_field_with_errors(form.employee_last) }}
                {{ render_field_with_errors(form.employee_gender) }}

                {{ render_field_with_errors(form.employee_ssn, length=9) }}
                {{ render_field_with_errors(form.employee_birthdate) }}
                {{ render_field_with_errors(form.employee_email) }}
                {{ render_field_with_errors(form.employee_phone) }}

                {{ render_field_with_errors(form.employee_height_inches) }}
                {{ render_field_with_errors(form.employee_weight_lbs) }}
                {{ render_field_with_errors(form.employee_smoker) }}


                {{ render_field_with_errors(form.employee_street_address) }}
                {{ render_field_with_errors(form.employee_street_address2) }}
                {{ render_field_with_errors(form.employee_city) }}
                {{ render_field_with_errors(form.employee_state) }}
                {{ render_field_with_errors(form.employee_zip) }}
            </div>
            <div class="col-sm-6 col-xs-12">
                <h3>Spouse:</h3>
                {{ render_field_with_errors(form.spouse_first) }}
                {{ render_field_with_errors(form.spouse_last) }}
                {{ render_field_with_errors(form.spouse_gender) }}

                {{ render_field_with_errors(form.spouse_ssn, length=9) }}
                {{ render_field_with_errors(form.spouse_birthdate) }}
                {{ render_field_with_errors(form.spouse_email) }}
                {{ render_field_with_errors(form.spouse_phone) }}

                {{ render_field_with_errors(form.spouse_height_inches) }}
                {{ render_field_with_errors(form.spouse_weight_lbs) }}
                {{ render_field_with_errors(form.spouse_smoker) }}

                {{ render_field_with_errors(form.spouse_street_address) }}
                {{ render_field_with_errors(form.spouse_street_address2) }}
                {{ render_field_with_errors(form.spouse_city) }}
                {{ render_field_with_errors(form.spouse_state) }}
                {{ render_field_with_errors(form.spouse_zip) }}
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <h3>Children</h3>
                {% for fields in child_form_fields %}

                    <div class="row">
                    {% for field in fields %}
                        <div class="col-sm-4">
                        {{ render_field_with_errors(field) }}
                        </div>
                    {% endfor %}
                    </div>
                {% endfor %}

                {# <h3>Children:</h3>
                 #}
                <div class="pull-left clearfix">
                    <button type="button" class="btn btn-danger delete">Delete Record</button>
                </div>
                <div class="pull-right clearfix">
                    <button type="button" class="btn btn-sm" id="go-back">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </form>
{% endblock %}

{% block page_js %}

    <script>
    $(function() {
        $("#go-back").on("click", function() {
            window.location.href = ("{{ url_for("manage_case", case_id=case.id) }}")
        });

        {# Hide the delete button if we are not admin and this has enrollments #}
        {% if census_record.enrollment_applications and not is_admin %}
            $("button.delete").hide();
        {% endif %}

        $("button.delete").on("click", function() {
            {% if census_record.enrollment_applications  %}
                if (!confirm("WARNING: This census record has enrollments. Deleting the record will remove all enrollment data associated. Do you still want to delete this census record?")) {
                    return;
                }
            {% else %}
                if (!confirm("Please confirm you want to delete this census record")) {
                    return;
                }
            {% endif %}


            send_form_data("DELETE", "{{ url_for('cases.delete_census_record', case_id=case.id, census_record_id=census_record.id) }}",
                {}, function() {
                window.location = "{{ url_for('manage_case', case_id=case.id) }}";
            }, function() {
                alert("Sorry, there was a problem deleting this census record");
            });
        });

        $("#edit-record-form").on("submit", function() {

            try {
                var data = $(this).serialize();
                $.ajax({
                    url: $(this).attr('action'),
                    method: "PUT",
                    data: data,
                    dataType:'json',
                    success: function(results) {
                        //var created_case = new Case(results.data);
                        //self.managed_cases.push(created_case);
                        window.location.href = "{{ url_for("manage_case", case_id="") }}"+results.data.case_id;
                    },
                    error: function(xhr) {
                        console.log(xhr.responseJSON.errors)
                    }
                });
            } catch(e) {
                console.error(e);
            }

            return false;
        })
    });
    </script>
{% endblock %}
