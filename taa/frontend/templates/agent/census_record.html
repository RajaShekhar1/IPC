  {% extends "base_ace_latest.html" %}
  {% from "form_macros.html" import render_field_with_errors %}
  {% set active_page = 'nav_agent_manage_case' -%}
  {% block title %} - Agent Manage Case{% endblock %}

  {% block content %}
      <div class="row">
        <ul class="breadcrumb col-xs-12">
          <li><a href="{{ url_for('index') }}"><i class="ace-icon fa fa-home"></i> Home</a></li>
          <li><a href="{{ url_for('manage_cases') }}"><i class="ace-icon fa fa-briefcase"></i> Enrollment Cases</a></li>
          <li><a href="{{ url_for('manage_case', case_id=case.id) }}#enrollment">{{ census_record.case.company_name }}</a></li>
          <li class="active"><i class="ace-icon glyphicon glyphicon-user"></i> {{ census_record.employee_first }} {{ census_record.employee_last }}</li>
        </ul>
      </div>

      <div class="row">
        <div class="col-xs-12">
          <h1 class="header lighter">Edit Census Record</h1>
        </div>
      </div>

      <div class="row">
        <div class="col-xs-12">
          <h3>
            Enrollment history for {{census_record.employee_first}} {{census_record.employee_last}}
          </h3>
        </div>
      </div>
      {% if enrollment_data %}
        <div class="col-xs-12 table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Product</th>
                <th>Status</th>
                <th>Coverage For</th>
                <th>Face Amount</th>
                <th>Annual Premium</th>
            </thead>
            <tbody>
              {% for product in enrollment_data %}
                {% if product %}
                  <tr style="background:rgba(50,50,50,.1)">
                    <td><strong data-bind="text: moment('{{ product.time }}').format('MM/DD/YYYY hh:mma')"></strong></td>
                    <td><strong>{{product.product_name}}</strong></td>
                    <td><strong>{{product.status.capitalize()}}</strong></td>
                    {% if product.status=='declined'%}
                      <td><strong>N/A</strong></td>
                      <td><strong>N/A</strong></td>
                      <td><strong>N/A</strong<td>
                    {% else %}
                      <td></td>
                      <td></td>
                      <td><strong>{{product.total}}</strong></td>
                    {% endif %}
                  </tr>

                  {% if product.status != 'declined'%}
                    {% for coverage in product.coverage %}
                      <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>{{coverage.who}}</td>
                        <td data-bind="text: formatThousand('{{coverage.coverage or 'No Coverage'}}')"></td>
                        <td data-bind="text: formatThousand('{{coverage.annual_premium}}')"></td>
                      </tr>
                    {% endfor %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
          <div class="text-center col-xs-12">
            <p>No enrollments</p>
          </div>
      {% endif %}
      </div>
      <div class="row">
        <div class="col-xs-12">
        {% if case_is_enrolling %}
          {% if enrollment_status == None %}
            <button class="btn btn-primary btn-sm enroll-employee" data-id="{{census_record.id}}">Enroll</button>
          {% elif enrollment_status != None %}
            <button class="btn btn-primary btn-sm enroll-employee" data-id="{{census_record.id}}"><i class="fa fa-plus"></i> Add Coverage</button>
          {% endif %}
        {% endif %}
        </div>
      </div>
      <hr />
      <form class="col-xs-12 form-horizontal" id="edit-record-form" action="{{ url_for("cases.update_census_record", case_id=case.id, census_record_id=census_record.id) }}">
          <div class="row">

              <div class="col-sm-6 col-xs-12">
                  <h3>Employee:</h3>
                  {{ render_field_with_errors(form.employee_first) }}
                  {{ render_field_with_errors(form.employee_last) }}
                  {{ render_field_with_errors(form.employee_gender) }}

                  {{ render_field_with_errors(form.employee_ssn, length=9) }}
                  {{ render_field_with_errors(form.employee_birthdate) }}
                  {{ render_field_with_errors(form.employee_email) }}
                  {{ render_field_with_errors(form.employee_phone) }}

                  {{ render_field_with_errors(form.employee_height_inches) }}
                  {{ render_field_with_errors(form.employee_weight_lbs) }}
                  {{ render_field_with_errors(form.employee_smoker) }}


                  {{ render_field_with_errors(form.employee_street_address) }}
                  {{ render_field_with_errors(form.employee_street_address2) }}
                  {{ render_field_with_errors(form.employee_city) }}
                  {{ render_field_with_errors(form.employee_state) }}
                  {{ render_field_with_errors(form.employee_zip) }}
              </div>
              <div class="col-sm-6 col-xs-12">
                  <h3>Spouse:</h3>
                  {{ render_field_with_errors(form.spouse_first) }}
                  {{ render_field_with_errors(form.spouse_last) }}
                  {{ render_field_with_errors(form.spouse_gender) }}

                  {{ render_field_with_errors(form.spouse_ssn, length=9) }}
                  {{ render_field_with_errors(form.spouse_birthdate) }}
                  {{ render_field_with_errors(form.spouse_email) }}
                  {{ render_field_with_errors(form.spouse_phone) }}

                  {{ render_field_with_errors(form.spouse_height_inches) }}
                  {{ render_field_with_errors(form.spouse_weight_lbs) }}
                  {{ render_field_with_errors(form.spouse_smoker) }}

                  {{ render_field_with_errors(form.spouse_street_address) }}
                  {{ render_field_with_errors(form.spouse_street_address2) }}
                  {{ render_field_with_errors(form.spouse_city) }}
                  {{ render_field_with_errors(form.spouse_state) }}
                  {{ render_field_with_errors(form.spouse_zip) }}
              </div>
          </div>
          <div class="row">
              <div class="col-xs-12">
                  <h3>Children</h3>
                  {% for fields in child_form_fields %}

                      <div class="row">
                      {% for field in fields %}
                          <div class="col-sm-4">
                          {{ render_field_with_errors(field) }}
                          </div>
                      {% endfor %}
                      </div>
                  {% endfor %}

                  {% if can_edit_case %}
                      <div class="pull-left clearfix">
                          <button type="button" class="btn btn-danger delete">Delete Record</button>
                      </div>
                      <div class="pull-right clearfix">
                          <button type="button" class="btn btn-sm" id="go-back">Cancel</button>
                          <button type="submit" class="btn btn-primary">Save Changes</button>
                      </div>
                  {% else %}
                      <div class="pull-right clearfix">
                          <button type="button" class="btn btn-primary" id="go-back">Return to case</button>
                      </div>
                  {% endif %}

              </div>
          </div>
      </form>
  {% endblock %}

  {% block page_js %}

      <script>

      $(function() {
          function CensusRecordViewModel() {
            var self = this;
            self.formatThousand = function(amount) {
              return amount.substr(0, amount.length-3)+amount.substr(amount.length-3).replace("000", "K");
            }
          }

          ko.applyBindings(new CensusRecordViewModel());
          $("#go-back").on("click", function() {
              window.location.href = ("{{ url_for("manage_case", case_id=case.id) }}#enrollment")
          });

          {# Hide the delete button if we are not admin and this has enrollments #}
          {% if census_record.enrollment_applications and not is_admin %}
              $("button.delete").hide();
          {% endif %}

          $(document).on('click', "button.enroll-employee", function() {
            var record_id = $(this).attr('data-id');

            submit_to_url("{{ url_for('in_person_enrollment') }}", {
              record_id: record_id,
              enrollment_city: "{{case.situs_city}}",
              enrollment_state: "{{case.situs_state}}"
            });
          });

          $("button.delete").on("click", function() {
              {% if census_record.enrollment_applications  %}
                  if (!confirm("WARNING: This census record has enrollments. Deleting the record will remove all enrollment data associated. Do you still want to delete this census record?")) {
                      return;
                  }
              {% else %}
                  if (!confirm("Please confirm you want to delete this census record")) {
                      return;
                  }
              {% endif %}


              send_form_data("DELETE", "{{ url_for('cases.delete_census_record', case_id=case.id, census_record_id=census_record.id) }}",
                  {}, function() {
                  window.location.href = "{{ url_for('manage_case', case_id=case.id) }}#enrollment";
              }, function() {
                  alert("Sorry, there was a problem deleting this census record");
              });
          });

          $("#edit-record-form").on("submit", function() {

              try {
                  var data = $(this).serialize();
                  $.ajax({
                      url: $(this).attr('action'),
                      method: "PUT",
                      data: data,
                      dataType:'json',
                      success: function(results) {
                          //var created_case = new Case(results.data);
                          //self.managed_cases.push(created_case);
                          window.location.href = "{{ url_for('manage_case', case_id=case.id) }}#enrollment";
                      },
                      error: function(xhr) {
                          console.log(xhr.responseJSON.errors)
                      }
                  });
              } catch(e) {
                  console.error(e);
              }

              return false;
          });

          {% if not can_edit_case %}
              $("input, select").prop("disabled", true);
          {% endif %}
      });
      </script>
  {% endblock %}
