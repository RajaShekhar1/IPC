{% extends 'base_ace_latest.html' -%}
{% from 'form_macros.html' import render_checkbox, render_field_with_errors -%}
{% set active_page = "nav_manage_cases" -%}

{% set default_email_message = """
""".format(agent_name=agent.name()) -%}

{% set default_page_text = """
You have reached the enrollment page for <strong>{company_name}</strong>, which is offering you important insurance
benefits from 5Star Life.
<br><br>
This enrollment should take less than 5 minutes to complete. To view details of the offered products, see the link(s) below.
Please follow the instructions carefully on the next page, stepping through the simple interview using the next/previous
buttons at the lower right of the page. At the end you will be presented with a complete application form to electronically sign.
""".format(company_name=case.company_name) -%}

{% block title %} - Manage Self-enrollment{% endblock -%}

{% block content -%}
  <div id="save-success" class="alert alert-block alert-success" style="display: none;">
    <strong><i class="ace-icon fa fa-check"></i></strong>
    Successfully saved self-enrollment settings.
  </div>
  <div id="save-fail" class="alert alert-danger" style="display: none;">
    <strong><i class="ace-icon fa fa-exclamation-triangle"></i></strong>
    Failed to save self-enrollment settings.
  </div>
  <h1 class="header lighter">
    Edit Self-enrollment Setup for &quot;{{ case.company_name }}&quot;
    {% if case.group_number -%}
    ({{ case.group_number }})
    {% endif -%}
  </h1>
  <form class="form-horizontal" id="edit-self-enrollment-form" action="{{ url_for('cases.update_self_enrollment_setup', case_id=case.id) }}" method="PUT">
    <div class="row">
      <div class="col-xs-12">
        {% if not case.active -%}
        <div class="label label-danger">
          <em>NOTE</em>: Case is currently not active. Self-enrollment links will not work unless the case is active.
        </div>
        {% endif -%}
        <h3>Self-enrollment type</h3>
        <div class="form-group self-enroll self-enroll-type">
          {% if case.self_enrollment_setup.links|count == 0 -%}
          {{ render_field_with_errors(form.self_enrollment_type) }}
          {% else -%}
          {{ render_field_with_errors(form.self_enrollment_type, disabled=true) }}
          {% endif -%}
        </div>
        <h3>Email</h3>
        <div class="form-group self-enroll self-enroll-email">
          {{ render_field_with_errors(form.email_sender_name, style="width: 100%;", default=agent.name()) }}
          {{ render_field_with_errors(form.email_sender_email, default=agent.email) }}
          {{ render_field_with_errors(form.email_message, class_='wysiwyg-editor', default=default_email_message) }}
          <div class="col-xs-9 col-xs-offset-3">
            <a id="reset-email-message" class="btn btn-xs pull-right">Reset to default message</a>
          </div>
          <div class="col-sm-9 col-sm-offset-3">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#email-target-links-modal" >
                <i class="ace-icon fa fa-envelope"></i>
                    Select Emails for Sending
            </button>

          </div>
        </div>
        <div class="form-group self-enroll self-enroll-email-off">
          <div class="col-sm-9 col-sm-offset-3">
            <div class="alert alert-info">
              <p>
                {% if setup and setup.links and setup.links|count > 0 -%}
                  Self-enrollment link:
                  <strong><a target="_blank" href="{{ setup.links[0].url }}">{{ setup.links[0].url }}</a></strong>
                {% endif -%}
              </p>
              <p>
                You must send the email/enrollment link through your usual email program when using generic self-enrollment.
              </p>
            </div>
            {% if not setup -%}
              <div class="alert alert-warning">
                The self-enrollment link will be generated for you after you save this form.
              </div>
            {% else -%}
            {% endif -%}
          </div>
        </div>
        <h3>Landing Page</h3>
        <div class="form-group self-enroll self-enroll-landing-page">
          {{ render_field_with_errors(form.page_title, default="Welcome to your Benefit Enrollment") }}
          {{ render_field_with_errors(form.page_text, class_='wysiwyg-editor', default=default_page_text) }}
          <div class="row">
            <div class="col-sm-9 col-sm-offset-3">
                {% include "enrollment/self_enrollment_product_list.html" -%}
            </div>
            <a id="reset-page-text" class="btn btn-xs pull-right">Reset to default message</a>
          </div>
          <br><br>
          <div class="row">
            <div class="col-sm-3 control-label">Disclaimer</div>
            <div class="col-sm-9">
                {% include "enrollment/self_enrollment_disclaimer.html" -%}
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr>
    <div class="row">
      <div class="col-xs-12">
{#        <div class="pull-left clearfix">#}
{#          <button type="button" class="btn btn-danger delete">Delete self-enrollment</button>#}
{#        </div>#}
        <div class="pull-right clearfix">
          <button type="button" class="btn btn-sm" id="go-back">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>
    {{ render_field_with_errors(form.created_by, value=agent.id) }}
  </form>

  <div class="self-enroll-email-confirm">
  </div>
{% endblock %}

{% block modals %}
  {{ super() }}

    {# Send targeted email modal #}
    <form id="send-emails-form" method="POST" enctype="multipart/form-data">
    <div id="email-target-links-modal" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span
                        aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Email Census Self-Enroll</h4>
                </div>
                <div class="modal-body">
                    <div class="form-panel modal-panel">
                        <h3>Send to employees who ...</h3>
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label>
                                        <input type="radio" class="ace" name="send_type" value="not-sent" checked>
                                        <span class="lbl">  have not been sent a link</span>
                                    </label>
                                    {#
                                    <div class="row">
                                        <p class="col-xs-10 col-xs-offset-1">
                                            This option adds new records to any existing employee records without updating any existing data.
                                        </p>
                                    </div>
                                    #}
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="radio" class="ace" name="send_type" value="not-enrolled">
                                        <span class="lbl">  have not enrolled or declined</span>
                                    </label>
                                    {#
                                    <div class="row">
                                        <p class="col-xs-10 col-xs-offset-1">
                                            This option adds new records to any existing employee records and also updates existing records whose SSN match the uploaded data.
                                        </p>
                                    </div>
                                    #}
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="radio" class="ace" name="send_type" value="declined">
                                        <span class="lbl">  have declined</span>
                                    </label>
                                    {#
                                    <div class="row">
                                        <p class="col-xs-10 col-xs-offset-1">
                                            This option first removes all existing employee records in this case, then adds the new uploaded data.
                                        </p>
                                    </div>
                                    #}
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="loading-panel modal-panel" style="display: none;">
                        <div class="text-center">
                            <h4>Sending enrollment emails...</h4>
                            <i class="icon-spinner icon-spin grey bigger-200"></i>
                        </div>
                    </div>
                    <div class="success-panel modal-panel" style="display: none;">
                        <h3 class="header lighter green">Emails Sent Successfully</h3>
                        <div id="email-status-wrap"></div>
                    </div>
                    <div class="error-panel modal-panel" style="display: none;">
                        <h3 class="header lighter red">Emails Failed to Send</h3>
                        <div id="email-error"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="form-buttons buttons-panel">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Now</button>
                    </div>
                    <div class="processing-buttons buttons-panel" style="display: none;">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                    <div class="error-buttons buttons-panel" style="display: none;">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary back-btn">
                            <i class="glyphicon glyphicon-chevron-left"></i> Back</button>
                    </div>
                    <div class="success-buttons buttons-panel" style="display: none;">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Done</button>
                    </div>

                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    </form>
{% endblock %}

{% block page_js %}
  <script>
    $(function() {
      // Show or hide landing page as necessary
      $('#self_enrollment_type').change(function() {
        if($('#self_enrollment_type option:selected').val() == 'case-generic') {
          $('.self-enroll-email').hide();
          $('.self-enroll-email-off').show();
        } else {
          $('.self-enroll-email').show();
          $('.self-enroll-email-off').hide();
        }
      }).change();

      // Buttons to reset text
      $('#reset-email-message').click(function() {
        $('#email_message').html("{{ default_email_message|replace('\n', '\\n')|safe }}").focus();
      });
      $('#reset-page-text').click(function() {
        $('#page_text').html("{{ default_page_text|replace('\n', '\\n')|safe }}").focus();
      });

      // Set default values if applicable
      $.each(['#email_sender_name', '#email_sender_email', '#email_message',
        '#page_title', '#page_text'], function(index, value) {
        if($(value).prop('tagName') == 'DIV') {
          if($(value).html() == '') {
            $(value).html($(value).attr('default'));
          }
        } else {
          if($(value).val() == '') {
            $(value).val($(value).attr('default'));
          }
        }
      });

      $('#go-back').on('click', function() {
        window.history.back();
      });

      $('#email_message').ace_wysiwyg({
        toolbar: [
          'bold',
          'italic',
          'underline',
          null,
          'createLink',
          'unlink',
          null,
          'insertImage',
          null,
          'undo',
          'redo'
        ]
      });
      $('#page_text').ace_wysiwyg();

      // Show success message if required
      if(window.location.hash == '#success') {
        window.location.href = window.location.href.replace(/#.*$/, '#');
        $('#save-success').show();
      }

{#      $('#edit-self-enrollment-form').submit(function() {#}
{#        $('#email_message').val($('#editor-email-message').val());#}
{#        $('#page_text').val($('#editor-page-text').val());#}
{#      });#}

      {# Hide the delete button if we are not admin and this has enrollments #}
{#      {% if census_record.enrollment_applications and not is_admin %}#}
{#        $('button.delete').hide();#}
{#      {% endif %}#}
{##}
{#      $('button.delete').on('click', function() {#}
{#        {% if census_record.enrollment_applications  %}#}
{#          if (!confirm("WARNING: This census record has enrollments. Deleting the record will remove all enrollment data associated. Do you still want to delete this census record?")) {#}
{#            return;#}
{#          }#}
{#        {% else %}#}
{#          if (!confirm("Please confirm you want to delete this census record")) {#}
{#            return;#}
{#          }#}
{#        {% endif %}#}
{##}
{#        send_form_data('DELETE', "{{ url_for('cases.delete_census_record', case_id=case.id, census_record_id=census_record.id) }}",#}
{#                {}, function() {#}
{#                  window.location = "{{ url_for('manage_case', case_id=case.id) }}";#}
{#                }, function() {#}
{#                  alert("Sorry, there was a problem deleting this census record");#}
{#                });#}
{#      });#}

      $('#edit-self-enrollment-form').on('submit', function() {
        $('#save-success').hide();
        $('#save-fail').hide();
        try {
          // Trigger 'submit' on hidden fields
          $('input[type="hidden"]').click();
          var data = $(this).serialize();
          console.log(data);
          $.ajax({
            url: $(this).attr('action'),
            method: 'PUT',
            data: data,
            dataType: 'json',
            success: function(results) {
              window.location.hash = 'success';
              window.location.reload();
            },
            error: function(xhr) {
              $('#save-fail').show();
            }
          });
        } catch(e) {
          console.error(e);
        }
        return false;
      });

      $('#send-emails-form').on('submit', function() {
        $('.form-panel').hide();
           $('.form-buttons').hide();
        $('.loading-panel').show();
          $('.processing-buttons').show();
        var send_type = $("input[name=send_type]:checked").val();
        try {
          $.ajax({
            url: '{{ url_for('cases.email_self_enrollment_link', case_id=case.id, which="") }}' + send_type,
            method: 'POST',
            dataType: 'json',
            success: function(results) {
              $('.loading-panel').hide();
              $('.success-panel').show();
               $('.processing-buttons').hide();
              $('.success-buttons').show();
              var sent_status_list = results.data;
              $('#email-status-wrap').html("Sent "+sent_status_list.length+" messages:<br><br>"+sent_status_list.join('<br>'));
            },
            error: function(xhr) {
              $('.loading-panel').hide();
                $('.processing-buttons').hide();
              $('.error-panel').show();
                $('.error-buttons').show();

            }
          });
        } catch(e) {
          console.error(e);
        }
        return false;
      })


    });
  </script>
{% endblock -%}
