{% extends "base_ace_latest.html" %}
{% from "form_macros.html" import render_field_with_errors %}
{% from "form_macros.html" import render_switch %}
{% set active_page = "nav_manage_cases" -%}
{% block title %} - Agent Manage Case{% endblock %}

{% block content %}
<flash-messages params="messages: flash_messages"></flash-messages>

<div class="row main-container"
     {# Prevent flash of unstyled content #}
     style="display: none;" data-bind="visible: true">

  <ul class="breadcrumb col-xs-12">
    <li><a href="{{ url_for('index') }}"><i class="ace-icon fa fa-home"></i> Home</a></li>
    <li><a href="{{ url_for('manage_cases') }}"><i class="ace-icon fa fa-briefcase"></i> Enrollment Cases</a></li>
    <li class="active" data-bind="text: company_name"></li>
  </ul>

  <div class="col-xs-12 ">
    <h3 class="header header-light blue" data-bind="text: company_name"></h3>
  </div>

  <div class="col-xs-12">
    <div class="tabbable">
      <ul class="nav nav-tabs" id="case-nav-tabs">
        <li class="active">
          <a href="#setup">
            <i class="green ace-icon fa fa-cog bigger-120"></i>
            Case Setup
          </a>
        </li>

        <li>
          <a href="#enrollment">
            <i class="orange ace-icon fa fa-user bigger-120"></i>
            Enrollment
          </a>
        </li>

        <li>
          <a href="#reports">
            <i class="blue ace-icon fa fa-bar-chart-o bigger-120"></i>
            Enrollment Reports
          </a>
        </li>
      </ul>

      <div class="tab-content">
        <div id="setup" class="tab-pane fade in active">
          <div class="row">

            <div class="col-md-12 case-setup-section">
              <form class="form-horizontal case_setup" data-bind="submit: save_settings">

                <div class="widget-box">
                  <div class="widget-header">
                    <div class="row">
                      <h3 class="col-xs-6">Main Settings</h3>

                      <h3 class="col-md-3 col-md-offset-3 active-switch text-right">
                        <label style="margin-right: 15px;">
                          {{ case_setup_form.active(class_="ace ace-switch ace-switch-6", **{'data-bind': 'checked: is_active'})|safe }}
                          <span class="lbl padding-16" data-bind="text: switch_label">Case is Active</span>
                        </label>
                      </h3>
                    </div>
                  </div>
                  <div class="widget-body">
                    <div class="widget-main">
                      <div class="row">
                        <div class="col-md-5 col-xs-12">
                          <h3 class="header lighter blue">Settings</h3>

                          <div class="form-group">
                            <label class="col-md-3 control-label" for="company_name">Company Name</label>

                            <div class="col-md-8">
                              {{ case_setup_form.company_name(**{
                            'data-bind': "textInput: company_name, uniqueNameValidation: {remoteMethod: check_unique_name, uniqueObservable: company_name}",
                            'minlength':'1',
                          }) }}

                              <div class="row">
                                <div class="col-md-12">
                                  <div class="error"
                                       data-bind="visible: company_name.has_been_checked, text: get_form_error"></div>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-1">
                              <div class="ace-icon fa fa-spinner text-warning bigger-125"
                                   data-bind="visible: company_name.is_checking"></div>
                              <div class="ace-icon fa fa-check green bigger-125"
                                   data-bind="visible: company_name.is_unique() && !company_name.is_checking()"></div>
                            </div>
                          </div>

                          <div class="form-group">
                            <label class="col-md-3 control-label" for="groupNumber">Group Number: </label>

                            <div class="col-md-9">
                              <input id="groupNumber" type="text" data-bind="value: group_number">
                            </div>
                          </div>

                          {# Restore multi-product selection when multi-product enrollment is working
                            {{ render_field_with_errors(case_setup_form.products, **{'data-bind': 'options: product_choices, optionsValue: "id", optionsText: "name", selectedOptions: products, multiSelect: {
                            observed: products,
                            options: {nonSelectedText: "No Products Selected", numberDisplayed: 3}
                          }'}) }}
                          #}
                          <div class="form-group">
                            <label class="col-md-3 control-label" for="productID">Product</label>

                            <div class="col-md-9">
                              <limited-product-select
                                      params="limiter: state_product_limiter, disabled: !can_edit_case"></limited-product-select>
                            </div>
                          </div>

                          {{ render_field_with_errors(case_setup_form.situs_city, **{'data-bind':'value: situs_city'}) }}

                          <div class="form-group">
                            <label class="col-md-3 control-label" for="enrollmentState">State</label>

                            <div class="col-md-9">
                              <limited-state-select
                                      params="limiter: state_product_limiter, disabled: !can_edit_case"></limited-state-select>
                            </div>
                          </div>

                          <div class="form-group">
                            <label class="col-md-3 control-label" for="paymentMode">Payment</label>

                            <div class="col-md-9">
                              <select id="paymentMode" name="paymentMode"
                                      data-bind="value: payment_mode, options: payment_mode_choices, optionsText: 'name', optionsCaption: '(Select Payment Type)'"></select>
                            </div>
                          </div>

                        </div>
                        <div class="enrollment-section col-md-5 col-md-offset-1 col-xs-12">
                          <h3 class="header lighter blue">Enrollment Periods</h3>

                          <div>
                            <div class="panel form-group">
                              <div class="panel-heading">
                                <label>
                                  <input data-bind="checked: enrollment_period_type" type="radio" class="ace"
                                         name="enrollment_period_type" value="open">
                                  <span class="lbl padding-8">Enrollment Period with End Date</span>
                                </label>
                              </div>
                              <div class="panel-body"
                                   data-bind="slideDownIf: is_open_enrollment">
                                <div class="row">
                                  <div class="col-md-6">
                                    <label>
                                      Start Date:
                                      <input data-bind="value: get_open_enrollment_period().start_date" type="text"
                                             placeholder="MM/DD/YYYY" class="input-mask-date"
                                             name="open_enrollment_start_date">
                                    </label>
                                  </div>
                                  <div class="col-md-6">
                                    <label>
                                      End Date:
                                      <input data-bind="value: get_open_enrollment_period().end_date" type="text"
                                             placeholder="MM/DD/YYYY" class="input-mask-date"
                                             name="open_enrollment_end_date">
                                    </label>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="panel form-group">
                              <div class="panel-heading">
                                <label>
                                  <input data-bind="checked: enrollment_period_type" type="radio" class="ace"
                                         name="enrollment_period_type" value="annual">
                                  <span class="lbl padding-8">Annual Periods</span>
                                </label>
                              </div>
                              <div class="panel-body"
                                   data-bind="slideDownIf: is_annual_enrollment()">
                                <!--ko foreach: annual_enrollment_periods-->
                                <div class="row">
                                  <div class="col-md-6">
                                    <label class="">
                                      Start Date:
                                      <input type="text" data-bind="value: start_date" class="input-mask-month-day"
                                             placeholder="MM/DD">
                                    </label>
                                  </div>
                                  <div class="col-md-6">
                                    <label class="">
                                      End Date:
                                      <input type="text" data-bind="value: end_date" class="input-mask-month-day"
                                             placeholder="MM/DD">
                                    </label>
                                  </div>
                                </div>
                                <div class="error" data-bind="text: error, visible: error() != ''"></div>
                                <!--/ko-->
                              </div>
                            </div>
                          </div>
                        </div>

                      </div>
                      <div class="row">
                        {% if is_admin %}
                          <div class="col-md-6">
                            <div class="row">
                              <div class="form-group">
                                <label class="col-md-3 control-label" for="owner_agent">Owner Agent</label>

                                <div class="col-md-9">
                                  <select id="owner_agent" name="agent_id" data-bind="value: owner_agent_id">
                                    <option value="">(No Owner)</option>
                                    {% for agent in active_agents %}
                                      <option value="{{ agent.id }}"
                                              {%-if agent.id == case.agent_id -%}
                                              selected="selected"
                                              {%- endif -%}
                                              >{{ agent.name() }}</option>
                                    {% endfor %}
                                  </select>
                                </div>
                              </div>
                            </div>
                          </div>

                        {% endif %}

                        {% if not case_has_enrollments %}
                          <div class="col-sm-offset-1 col-sm-3">
                            <button type="button" class="btn btn-danger btn-xs pull-left"
                                    data-bind="click: delete_case">
                              Delete Case
                            </button>
                          </div>
                        {% endif %}
                        {% if case_has_enrollments and not is_admin %}
                          <div class="col-sm-offset-1 col-sm-3">
                            <div class="tooltip-wrapper tooltip-error"
                                 data-rel="tooltip" style="display: inline-block;"
                                 title="Cannot delete a case with posted enrollments. Instead mark the case as ‘inactive’">
                              <button type="button" disabled="disabled"
                                      class="btn btn-danger btn-xs pull-left tooltip-error">
                                Delete Case
                              </button>
                            </div>

                          </div>
                        {% endif %}
                        {% if case_has_enrollments and is_admin %}
                          <div class="col-sm-offset-1 col-sm-3">
                            <button type="button" class="btn btn-danger btn-xs pull-left" data-bind="
                                    click: delete_case_with_enrollments
                                    ">Delete Case
                            </button>
                          </div>
                        {% endif %}

                      </div>
                      <div class="row">
                        <div class="col-sm-12">
                          <h4 class="header lighter blue">Partner Agents</h4>

                          <div class="row">
                            <div class="col-sm-10 col-md-offset-1">
                              {% if is_admin %}
                                <select data-bind="selectedOptions: partner_agents"
                                        multiple="multiple" class="form-control"
                                        id="partner-agents"
                                        size="10" style="min-height: 8em;">
                                  {% for agent in active_agents %}
                                    <option value="{{ agent.id }}"
                                            {%-if agent in case.partner_agents -%}
                                            selected="selected"
                                            {%- endif -%}
                                            >{{ agent.name() }}</option>
                                  {% endfor %}
                                </select>
                              {% else %}
                                <div class="text partner_agents">
                                  {% if case.partner_agents|count > 1 %}
                                    <ul class="partner-agents">
                                      {% if case.owner_agent is not none %}
                                        <li class="owner-agent">
                                          {{ case.owner_agent.name() }}
                                          <span class="text-muted">(<em>owner</em>)</span>
                                        </li>
                                      {% endif -%}
                                      {% for agent in case.partner_agents %}
                                        {% if agent != case.owner_agent %}
                                          <li class="partner-agent">
                                            {{ agent.name() }}
                                          </li>
                                        {% endif %}
                                      {% endfor %}
                                    </ul>
                                  {% else %}
                                    <em>None</em>
                                  {% endif %}
                                </div>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="widget-toolbox clearfix padding-8">

                      <button class="btn btn-primary btn-md pull-right" data-bind="
                                disable: !can_edit_case,
                                click: save_settings,
                                css: {'btn-primary': has_unsaved_data, 'btn-default': !has_unsaved_data()}
                                ">Save
                      </button>
                    </div>
                  </div>
                </div>

              </form>
              <br>
              <br>

            </div>
          </div>

          <div class="row">
            <div class="col-md-12 self-enrollment-section">
              <form class="form-horizontal" id="edit-self-enrollment-form">
                <div class="widget-box">
                  <div class="widget-header">
                    <div class="row">
                      <h3 class="col-xs-6">Self-enrollment Settings</h3>

                      <h3 class="col-md-3 col-md-offset-3 active-switch text-right">
                        <label>
                          {{ case_setup_form.is_self_enrollment(class_="ace ace-switch btn-empty", **{'data-bind': 'checked: is_self_enrollment'})|safe }}
                          <span class="lbl"></span>
                        </label>
                      </h3>
                    </div>
                  </div>
                  <div class="widget-body">
                    <div class="widget-main">
                      <div class="row">
                        <div class="col-xs-12">

                          <div class="panel form-group">
                            <div class="panel-body" data-bind="slideDownIf: !is_self_enrollment()">
                              <p>Self-enrollment is not currently active.</p>
                            </div>
                            <div class="panel-body" data-bind="slideDownIf: is_self_enrollment()">

                              <div class="self-enrollment-setup">

                                <div id="save-success" class="alert alert-block alert-success" style="display: none;">
                                  <strong><i class="ace-icon fa fa-check"></i></strong>
                                  Successfully saved self-enrollment settings.
                                </div>

                                <div id="save-fail" class="alert alert-danger" style="display: none;">
                                  <strong><i class="ace-icon fa fa-exclamation-triangle"></i></strong>
                                  Failed to save self-enrollment settings.
                                </div>

                                <div class="row">
                                  <div class="col-xs-12">

                                    <div class="label label-danger" data-bind="visible: !is_active()">
                                      <em>NOTE</em>: Case is currently not active. Self-enrollment links will not work
                                      unless the case is active.
                                    </div>

                                    <h3 class="header lighter blue">Self-enrollment type</h3>

                                    <div class="form-group self-enroll self-enroll-type">
                                      {{ render_field_with_errors(form.self_enrollment_type, **{'data-bind': 'value: self_enrollment_type'}) }}
                                    </div>
                                    <h3 class="header lighter blue">Enrollment Email</h3>

                                    <div class="form-group self-enroll">
                                      <div class="col-sm-3 control-label">Generic enrollment link</div>
                                      <div class="col-sm-9">
                                        <div class="">
                                          <p class="well well-sm">
                                            <strong><a target="_blank"
                                                       href="{{ generic_link }}">{{ generic_link }}</a></strong>
                                          </p>

                                          <p class="alert alert-info">
                                            You must send the generic enrollment link through your usual email
                                            program.
                                          </p>
                                        </div>

                                      </div>
                                    </div>

                                    {% include "agent/self_enroll_email_settings.html" %}


                                    <h3 class="header lighter blue">Landing Page</h3>

                                    <div class="form-group self-enroll self-enroll-landing-page">
                                      {{ render_field_with_errors(form.page_title, default="Welcome to your Benefit Enrollment", **{"data-bind": "value:landing.page_title"}) }}
                                      {{ render_field_with_errors(form.page_text, class_='wysiwyg-editor', default=default_page_text, **{"data-bind": "wysiwyg: {type:'full', value: landing.page_text}"}) }}
                                      <div class="row">
                                        <div class="col-sm-9 col-sm-offset-3">
                                          <a id="reset-page-text" class="btn btn-xs pull-right">Reset to default
                                            message</a>
                                        </div>
                                        <div class="col-sm-9 col-sm-offset-3">
                                          {% include "enrollment/self_enrollment_product_list.html" -%}
                                        </div>
                                      </div>
                                      <br><br>

                                      <div class="row">
                                        <div class="col-sm-3 control-label">Disclaimer</div>
                                        <div class="col-sm-9">
                                          {% include "enrollment/self_enrollment_disclaimer.html" -%}
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <hr>
                                <div class="self-enroll-email-confirm"></div>
                              </div>
                              </ul>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                    <div class="widget-toolbox clearfix padding-8">
                      <div class="pull-right clearfix">
                        <button type="submit" class="btn btn-primary" data-bind="visible: is_self_enrollment,
                              disable: !can_edit_case,
                              click: save_settings,
                              css: {'btn-primary': has_unsaved_data, 'btn-default': !has_unsaved_data()}">Save
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div id="enrollment" class="tab-pane fade">
          <div class="row"
               {#- Prevent flash of unstyled content #}
               style="display: none;" data-bind="visible: true">
            <div class="col-xs-12">
              <div class="widget-box">
                <div class="widget-header">
                  <div class="row">
                    <div class="col-md-4"><h4 class="bigger-150">Case Census</h4></div>
                    <div class="col-md-8">
                      <button type="button" id="upload-btn" class="btn btn-success pull-right" data-toggle="modal"
                              data-target="#census-upload-modal"
                              data-bind="visible: can_edit_case">
                        <i class="ace-icon fa fa-upload"></i>
                        Upload Census
                      </button>
                      <a data-bind="visible: has_census_data() && can_edit_case"
                         href="{{ url_for('cases.census_records', case_id=case.id) }}?format=csv" target="_blank"
                         id="export-btn" class="btn btn-default pull-right">
                        <i class="ace-icon glyphicon glyphicon-download-alt"></i>
                        Download Census
                      </a>
                      <a id="add-to-census-btn" class="btn btn-primary pull-right" data-bind="visible: is_active">
                        <i class="ace-icon glyphicon glyphicon-plus"></i>
                        New Enrollment
                      </a>
                      <button data-bind="visible: is_self_enrollment() && is_active() && has_census_data() && self_enrollment_type() == 'case-targeted'"
                              type="button" class="btn btn-warning pull-right" data-toggle="modal"
                              data-target="#email-target-links-modal">
                        <i class="ace-icon fa fa-envelope"></i>
                        Email Enroll
                      </button>
                    </div>
                  </div>
                </div>
                <div class="widget-body">
                  <div class="widget-main">

                    <div class="row" data-bind='visible: has_census_data'>
                      <div class="col-xs-12">
                        <label>Enrollment City: <input type='text'
                                                       data-bind="value: enrollment_city_override"></label>
                        <label>Enrollment State:
                          <limited-state-select
                                  params="limiter: state_product_override_limiter"></limited-state-select>
                        </label>
                      </div>
                    </div>

                    <h4 class="no-census-header text-center lighter" data-bind="visible: census_data().length == 0">No
                      Census Data Uploaded</h4>

                    <div class="table-responsive">
                      <table id="census-records-table" class="table table-bordered table-hover no-wrap dt-responsive"
                             data-bind="visble: census_data().length > 0">
                        <thead>
                        <tr>
                          <th></th>
                          <th>Status</th>
                          <th>First</th>
                          <th>Last</th>
                          <th>DOB</th>
                          <th>Email</th>
                        </tr>
                        </thead>
                        <tbody>
                        {#
                          Don't load this on the page anymore,
                          we load from the server using ajax at run time (helps with performance,
                          needs to be able to reload anyway)
                        #}
                        </tbody>
                      </table>
                    </div>
                    <div id="census-table-loading" class="text-center bigger-125"></div>
                  </div>
                </div>

              </div>

            </div>

          </div>
        </div>

        <div id="reports" class="tab-pane fade">
          <div class="row">
            <div class="col-xs-12">

              {# Report #}
              <div class="widget-box">
                <div class="widget-header">
                  <div class="row">
                    <h3 class="col-xs-10">Report
                    </h3>

                    <h3 class="col-xs-2 text-center">
                      <small data-bind="visible: report_viewmodel() && report_viewmodel().any_enrollments()">
                        <a href="#print"><i class="ace-icon glyphicon glyphicon-print"></i> Print</a>
                      </small>
                    </h3>
                  </div>
                </div>
                <div class="widget-body">
                  <div class="widget-main">
                    <div class="row">
                      <div class="col-xs-12">
                        <case-report params="settings_viewmodel: $root"></case-report>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {# Enrollments #}
              <div class="row"
                   {# Prevent flash of unstyled content #}
                   style="display: none;" data-bind="visible: true">
                <div class="col-xs-12">
                  <div class="widget-box"
                       data-bind="visible: report_viewmodel() && report_viewmodel().any_enrollments()">
                    <div class="widget-header">
                      <div class="row">
                        <div class="col-xs-6"><h4 class="bigger-150">Enrollment Records</h4></div>
                        <div class="col-xs-6">

                          <a href="{{ url_for('cases.enrollment_records', case_id=case.id) }}?format=csv"
                             target="_blank" id="export-btn" class="btn btn-default pull-right">
                            <i class="ace-icon glyphicon glyphicon-download-alt"></i>
                            Download Enrollments
                          </a>
                        </div>
                      </div>
                    </div>
                    <div class="widget-body">
                      <div class="widget-main">
                        <div style="width: 100%; padding-left: -10px;">
                          <div class="table-responsive">
                            <table id="enrollment-records-table"
                                   class="table table-bordered table-hover no-wrap dt-responsive">
                              <thead>
                              <tr>
                                <th class="min-breakII">Date</th>
                                <th>First</th>
                                <th>Last</th>
                                <th class="min-breakII">DOB</th>
                                <th class="min-breakI">Email</th>
                                <th class="min-breakV">Status</th>
                                <th>Total Premium</th>
                              </tr>
                              </thead>
                              <tbody>
                              {#
                                Don't load this on the page at startup,
                                we load from the server after page load so it doesn't get hung up here.
                              #}
                              </tbody>
                            </table>
                          </div>
                        </div>
                        <div id="enrollment-table-loading" class="text-center bigger-125"></div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>


<div data-bind="modal: is_permanent_delete_modal_showing" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span
                aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Delete Case and All Enrollment Data</h4>
      </div>
      <div class="modal-body">
        <div class="form-panel modal-panel">
          <div class="row">
            <div class="col-xs-12">
              <p>
                This case has enrollments that have been processed.
                Deleting the case will permanently remove all associated enrollment and census records;
                they will not be retrievable. Are you sure you want to permanently remove all enrollment
                and census records?
              </p>
              <br>
              <label>
                Type DELETE in the following box for confirmation:
                <input data-bind="textInput: delete_confirmation_text">
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="form-buttons buttons-panel">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button class="btn btn-danger"
                  data-bind="enable: is_delete_text_valid, click: remote_delete">PERMANENT DELETE
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/html" id="case-report-template">
  <div data-bind="visible: is_loading">
    <div class="loading">Loading Report...</div>
  </div>
  <div class="report-wrap" data-bind="visible: !is_loading()">

    <!--ko if: !any_enrollments()-->
    <h2>No Enrollments Recorded</h2>
    <!--/ko-->

    <!--ko if: any_enrollments-->
    <h1 data-bind="text: company_name"></h1>

    <!--ko if: is_census_report-->
    <h3 class="light">Summary</h3>

    <div class="">
      <table class="table table-bordered center no-wrap">
        <thead>
        <tr>
          <th class="text-center w_25">Total Processed</th>
          <th class="text-center w_25">Total Taken</th>
          <th class="text-center w_25">Total Declined</th>
          <th class="text-center w_25">Total Annual Premium</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td>
            <span data-bind="text: format_total_percent_processed"></span>
            (<span data-bind="text: format_total_num_processed"></span> of
            <span data-bind="text: format_total_num_census"></span>)
          </td>
          <td>
            <span data-bind="text: format_total_percent_taken"></span>
            (<span data-bind="text: format_total_num_taken"></span>)
          </td>
          <td>
            <span data-bind="text: format_total_percent_declined"></span>
            (<span data-bind="text: format_total_num_declined"></span>)
          </td>
          <td>
            <span data-bind="text: format_total_annualized_premium"></span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <!--/ko-->

    <h4>Period:
      <small data-bind="text: format_enrollment_dates"></small>
    </h4>
    <h4 data-bind="visible: only_one_product">Product:
      <small data-bind="text: product_name"></small>
    </h4>
    <h4>Method(s):
      <small data-bind="text: format_enrollment_methods"></small>
    </h4>


    <!--ko if: !is_census_report()-->
    <h3 class="light">Total Annual Premium:
      <small data-bind="text: format_total_annualized_premium"></small>
    </h3>
    <!--/ko-->

    <!--ko if: !only_one_product() -->
    <h3 class="light">By Product</h3>

    <div class="table-responsive">
      <table class="table table-bordered table-striped no-wrap">
        <thead>
        <tr>
          <th class="text-left w_40">Product</th>
          <th class="text-center w_30">Taken</th>
          <th class="text-right w_30">Total Annual Premium</th>
        </tr>
        </thead>
        <tbody>
        <!--ko foreach: product_data-->
        <tr>
          <td data-bind="text: name"></td>
          <td class="text-center"><span data-bind="text: num_taken"></span> (<span
                  data-bind="text: percent_taken"></span>%)
          </td>
          <td class="text-right">$<span data-bind="text: annualized_premium"></span></td>
        </tr>
        <!--/ko-->
        </tbody>
      </table>
    </div>
    <!--/ko-->

    <!--ko if: case_agents-->
    <h4>
      Case Agents:
      <small data-bind="text: format_case_agents"></small>
    </h4>
    <!--/ko-->
    <!--/ko-->
  </div>
</script>

<loading-modal params="options: loading_modal"></loading-modal>
{% endblock %}

{% block modals %}
{{ super() }}
<div class="modals">
  {# Send targeted email modal #}
  <form id="send-emails-form" method="POST" enctype="multipart/form-data">
    <div id="email-target-links-modal" class="modal fade">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span
                    aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title">Email Census Self-Enroll</h4>
          </div>
          <div class="modal-body">
            <div class="form-panel modal-panel form-horizontal">
              <div class="form-group">
                <div class="control-label col-md-3">
                  <label>Send To: </label>
                </div>
                <div class="col-md-9">
                  <select class="form-control" data-bind="value: send_type" name="send_type">
                    <option data-bind="text: numbers.not_sent()+' employees who have not been sent a link'" value="not-sent"></option>
                    <option data-bind="text: numbers.not_applied()+' employees who have not applied or declined'" value='not-applied'></option>
                    <option data-bind="text: numbers.declined()+' employees who have declined'" value='declined'></option>
                  </select>
                </div>
              </div>
              {% include "agent/self_enroll_email_settings.html" %}
              <br />
              <br />
              <ul class="list-unstyled row" data-bind="foreach: errors">
                <li class="alert alert-danger" data-bind="text: $data"></li>
              </ul>
            </div>
            <div class="loading-panel modal-panel" style="display: none;">
              <div class="text-center">
                <h4>Sending enrollment emails...</h4>
                <i class="icon-spinner icon-spin grey bigger-200"></i>
              </div>
            </div>
            <div class="success-panel modal-panel" style="display: none;">
              <h3 class="header lighter green">Emails Scheduled for Delivery</h3>
              <div id="email-status-wrap"></div>
            </div>
            <div class="error-panel modal-panel" style="display: none;">
              <h3 class="header lighter red">Emails Failed to Send</h3>
              <div id="email-error"></div>
            </div>
            <div class="clearfix"></div>
          </div>

          <div class="modal-footer">
            <div class="form-buttons buttons-panel">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              <button type="submit" data-bind="click: send_emails" class="btn btn-primary">Send Now</button>
            </div>
            <div class="processing-buttons buttons-panel" style="display: none;">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
            <div class="error-buttons buttons-panel" style="display: none;">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary back-btn">
                <i class="glyphicon glyphicon-chevron-left"></i> Back</button>
            </div>
            <div class="success-buttons buttons-panel" style="display: none;">
              <button type="button" class="btn btn-default" data-dismiss="modal">Done</button>
            </div>

          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
  </form>


  {# Confirm that an employee is not in the census using SSN. #}
  <div id="add-to-census-modal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span
                  aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <h4 class="modal-title">New Enrollment</h4>
        </div>
        <div class="modal-body">
          <div class="form-panel modal-panel" data-bind="if: add_form_showing">
            <form data-bind="submit: find_matches">
              <div class="row">
                <div class="col-xs-12 ">
                  <div class="form-group">
                    <label for="add-census-ssn-input">
                      Employee SSN:
                    </label>
                    <input type="text" id="add-census-ssn-input" name="ssn" data-bind="value: ssn, maskedInput: '999-99-9999', valueUpdate: 'afterkeydown'">
                    <div data-bind="text: ssn.error" class="error"></div>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <div class="loading-panel modal-panel" data-bind="if: is_loading">
            <div class="text-center">
              <h4 data-bind="text: loading_message"></h4>
              <i class="icon-spinner icon-spin grey bigger-200"></i>
            </div>
          </div>

          <div class="no-matches-panel modal-panel" data-bind="if: no_matches_found">
            <h3 class="header lighter green">No employee with that SSN was found.</h3>
            <p>Click 'Begin Enrollment' to create new employee</p>
          </div>
          <div class="one-match-panel modal-panel" data-bind="if: one_match_found">
            <h3 class="header lighter green">We found a matching employee record:</h3>
            <strong>
              <span data-bind="text: matched_employee().first"></span>
              <span data-bind="text: matched_employee().last"></span>,
              Birthdate: <span data-bind="text: matched_employee().formatted_birthdate()"></span>
            </strong>
          </div>
          <div class="error-panel modal-panel" data-bind="if: multiple_matches_found">
            <h3 class="header lighter">
              Matched Employees:
            </h3>

            <div class="row">
              <div class="col-md-12" style="width: 100%; overflow: auto;">
                <div class="table-responsive">
                  <table class="table table-bordered upload-error-table">
                    <thead>
                    <tr>
                      <th></th>
                      <th>First</th>
                      <th>Last</th>
                      <th>Birthdate</th>
                    </tr>
                    </thead>
                    <tbody data-bind="foreach: {data: matched_employees, as: 'employee'}">
                    <tr>
                      <td><input type="radio" name="selected_match" data-bind="checked: $parent.selected_employee, checkedValue: employee.id"></td>
                      <td data-bind="text: employee.first"></td>
                      <td data-bind="text: employee.last"></td>
                      <td data-bind="text: employee.formatted_birthdate()"></td>
                    </tr>
                    </tbody>
                  </table>
                </div>
                <div class="error" data-bind="matched_employees.error"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <div class="success-buttons buttons-panel" data-bind="">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary"
                    data-bind="click: find_matches, visible: current_panel() == PANEL_FORM">Next</button>
            <button type="button" class="btn btn-success"
                    data-bind="click: add_to_census, visible: no_matches_found">Begin Enrollment</button>

            <button type="button" class="btn btn-success"
                    data-bind="click: enroll_from_match, visible: one_match_found">Enroll this employee</button>
            <button type="button" class="btn btn-warning"
                    data-bind="click: add_to_census, visible: one_match_found">Enroll new employee</button>

            <button type="button" class="btn btn-success"
                    data-bind="click: enroll_from_match, visible: multiple_matches_found">Enroll selected employee</button>
            <button type="button" class="btn btn-warning"
                    data-bind="click: add_to_census, visible: multiple_matches_found">Enroll new employee</button>
          </div>

        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>

  {# Upload census data modal. This is in the footer so I can bind two KO controllers more easily for now. #}
  <form id="census-record-form" method="POST" enctype="multipart/form-data">
    <div id="census-upload-modal" class="modal fade">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span
                    aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title">Upload Census Data</h4>
          </div>
          <div class="modal-body">
            <div class="form-panel modal-panel">
              <div class="row">
                <div class="col-xs-12 ">
                  <h4>
                    Select Census CSV File:
                  </h4>
                  <p class="offset-by-twelve">Download an <a href="{{ url_for("sample_upload_csv") }}">example census data file</a> for formatting reference.</p>
                  <input type="file" id="csv-file-input" name="csv-file" accept="text/csv,.csv">
                </div>
              </div>

              <br>

              <div class="row">
                <div class="col-xs-12">
                  <div class="form-group">
                    <label>
                      <input type="radio" class="ace" name="upload_type" value="merge-skip" checked="1">
                      <span class="lbl"> Add New Records</span>
                    </label>
                    <div class="row">
                      <p class="col-xs-10 col-xs-offset-1">
                        This option adds new records to any existing employee records without updating any existing data.
                      </p>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>
                      <input type="radio" class="ace" name="upload_type" value="merge-replace">
                      <span class="lbl"> Add With Update</span>
                    </label>
                    <div class="row">
                      <p class="col-xs-10 col-xs-offset-1">
                        This option adds new records to any existing employee records and also updates existing records whose SSN match the uploaded data.
                      </p>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>
                      <input type="radio" class="ace" name="upload_type" value="replace">
                      <span class="lbl"> Replace Existing Census</span>
                    </label>
                    <div class="row">
                      <p class="col-xs-10 col-xs-offset-1">
                        This option first removes all existing employee records in this case, then adds the new uploaded data.
                      </p>
                    </div>
                  </div>

                </div>
              </div>
            </div>
            <div class="loading-panel modal-panel" style="display: none;">
              <div class="text-center">
                <h4>Uploading and processing...</h4>
                <i class="icon-spinner icon-spin grey bigger-200"></i>
              </div>
            </div>
            <div class="success-panel modal-panel" style="display: none;">
              <h3 class="header lighter green">File Processed Successfully</h3>
              <!--ko if: num_data_records() > 0 -->
              <h4><span data-bind="text: num_data_records"></span>
                record<span data-bind="visible: num_data_records() > 1">s</span>
                added or updated.</h4>
              <!--/ko-->
              <!--ko if: num_data_records() == 0 -->
              <h4>No new data was added to the census.</h4>
              <!--/ko-->
            </div>
            <div class="error-panel modal-panel" style="display: none;">
              <h3 class="header lighter red">
                Bad or Missing Data
                          <span data-bind="visible: error_records().length >= 20"
                                class="smaller-75 pull-right">First 20 Errors Displayed</span>
              </h3>

              <div class="row">
                <div class="col-md-12" style="width: 100%; overflow: auto;">
                  <!--ko foreach: {data: error_records, as: 'error_record'}-->
                  <div data-bind="if: error_record.message && error_record.records.length == 0">
                    <div class="error" data-bind="text: error_record.message"></div>
                  </div>
                  <div class="table-responsive">
                    <table data-bind="if: error_record.records.length > 0"
                           class="table table-bordered upload-error-table">
                      <thead>
                      <tr>
                        <th>Record #</th>
                        <!--ko foreach: error_record.headers-->
                        <th data-bind="text: $data"></th>
                        <!--/ko-->
                      </tr>
                      </thead>
                      <tbody data-bind="foreach: {data: error_record.records, as: 'data_record'}">
                      <tr>
                        <td data-bind="text: error_record.line_number"></td>
                        <!--ko foreach: {data: error_record.headers, as: 'header'} -->
                        <td data-bind="css: {error: error_record.field_name == header}, attr: {title: error_record.message}"
                            data-toggle="tooltip">
                          <div data-bind="text: data_record[header]"></div>
                        </td>
                        <!--/ko-->
                      </tr>
                      </tbody>
                    </table>
                  </div>
                  <!--/ko-->
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <div class="form-buttons buttons-panel">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Submit</button>
            </div>
            <div class="processing-buttons buttons-panel" style="display: none;">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
            <div class="error-buttons buttons-panel" style="display: none;">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary back-btn">
                <i class="glyphicon glyphicon-chevron-left"></i> Back</button>
            </div>
            <div class="success-buttons buttons-panel" style="display: none;">
              <button type="button" class="btn btn-default" data-dismiss="modal">Done</button>
            </div>

          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
  </form>
</div>
{% endblock %}

{% block page_js %}
<script>
  function add_case_error(errors, field_name, message) {
    if (field_name in errors) {
      errors[field_name].push(message);
    } else {
      errors[field_name] = [message];
    }
  }

  $(function() {

    $('#csv-file-input').ace_file_input({
      no_file:'No File ...',
      btn_choose:'Choose File',
      btn_change:'Change File',
      droppable:false,
      onchange:null,
      thumbnail:false,
      whitelist:'csv'
    });

    $("#census-record-form").on("submit", function() {

      var form = this;
      var file_select = $(this).find("input[type=file]").get(0);
      var files = file_select.files;
      var form_data = new FormData();
      if (files.length !== 1) {
        alert("Please select a file");
        return false;
      }

      // Add the file upload to the request.
      form_data.append('csv-file', files[0], files[0].name);
      form_data.append('upload_type', $("input[name=upload_type]:checked").val());

      function handle_upload_success(resp) {
        census_errors_panel.error_records(resp.data.errors);
        census_errors_panel.num_data_records(resp.data.records.length);
        show_success_panel();

        window.case_settings.census_data(resp.data.records);

        // Update the datatable
        case_management.refresh_census_table({{ case.id }},"{{ url_for("cases.census_records", case_id=case.id) }}",
                "#census-records-table", "#census-table-loading");
      }

      function handle_upload_error(xhr) {
        if (xhr.status >= 400 && xhr.status < 500) {
          show_error_panel();
          var data = $.parseJSON(xhr.responseText).data;
          census_errors_panel.error_records(data.errors);

          // Show error tooltips
          $('.upload-error-table td.error').tooltip({placement: "auto left"});
        } else {
          alert("Sorry, there was a problem communicating with the server.");
          reset_upload_modal();
        }
      }

      send_file_data("POST", "{{ url_for("cases.post_census_records", case_id=case.id) }}",
              form_data, handle_upload_success, handle_upload_error, false);

      show_loading_panel();

      return false;
    });
    function show_loading_panel() {
      $(".form-panel").hide("slide");
      $(".loading-panel").show("slide");
      $(".processing-buttons").show("fade");
      $(".form-buttons").hide("fade");
    }
    function show_error_panel() {
      $(".loading-panel").hide("slide");
      $(".error-panel").show("slide");
      $(".error-buttons").show("fade");
      $(".processing-buttons").hide("fade");
    }
    function show_success_panel() {
      $(".loading-panel").hide("slide");
      $(".success-panel").show("slide");
      $(".success-buttons").show("fade");
      $(".processing-buttons").hide("fade");
    }
    function show_form_panel() {
      $(".modal-panel").hide("slide");
      $(".buttons-panel").hide("slide");
      $(".form-panel").show("slide");
      $(".form-buttons").show("slide");
    }

    function reset_upload_modal() {
      $(".modal-panel").hide();
      $(".buttons-panel").hide();
      $(".form-panel").show();
      $(".form-buttons").show();
    }
    $("#upload-btn").on("click", reset_upload_modal);
    $(".back-btn").on("click", show_form_panel);

    var CensusErrorsPanel = function() {
      var self = this;

      self.error_records = ko.observableArray([]);
      self.num_data_records = ko.observable(0);
    };
    window.census_errors_panel = new CensusErrorsPanel();
    ko.applyBindings(census_errors_panel, $("#census-upload-modal")[0]);

    /* CaseReportsViewModel */
    var CaseReportsViewModel = function(params) {
      var self = this;

      self.is_loading = ko.observable(true);

      self.company_name = ko.observable({});
      self.group_number = ko.observable({});

      self.any_enrollments = ko.observable(false);

      self.summary_data = ko.observable({});
      self.product_data = ko.observable([]);
      self.enrollment_dates = ko.observable({});
      self.enrollment_methods = ko.observableArray([]);
      self.case_agents = ko.observableArray([]);

      self.load_reports = function() {
        self.is_loading(true);
        var url = "{{ url_for("cases.enrollment_report", case_id=case.id) }}";
        $.get(url).success(function(resp) {
          // Pull out the report data
          self.company_name(resp.data.company_name);
          self.group_number(resp.data.group_number);
          self.enrollment_dates(resp.data.enrollment_period);
          self.enrollment_methods(resp.data.enrollment_methods);
          self.summary_data(resp.data.summary);
          self.any_enrollments(self.summary_data().processed_enrollments > 0);

          // Reformat the product data to fit the display better
          var pdata = [];
          $.each(resp.data.product_report, function() {
            var data = this;
            pdata.push({
              name: data.product_name,
              num_taken: data.enrolled_count,
              percent_taken: (data.enrolled_count / resp.data.summary.total_census * 100).toFixed(2),
              annualized_premium: data.total_annualized_premium
            });
          });
          self.product_data(pdata);
          // Case agents
          var case_agents = [];
          if (resp.data.case_owner) {
            case_agents.push(resp.data.case_owner.first + " "+resp.data.case_owner.last);
          }
          _.each(resp.data.case_agents, function(agent) {
            case_agents.push(agent.first + " "+agent.last);
          });
          self.case_agents(case_agents);
          self.is_loading(false);
        }).error(function(e) {
          console.error(e);
          self.is_loading(false);
        });
      };

      self.enter_print_preview = function () {
        $(".header ul").hide();
        $(".container.page").hide();
        $("#print-wrap").html($("#reports .report-wrap").clone()
        ).prepend("<div><a class='btn btn-default hidden-print' href='#reports'>"+
                "<span class='glyphicon glyphicon-chevron-left'></span> Back to report</a></div>").show();
      };

      self.exit_print_preview = function() {
        $(".header ul").show();
        $(".container.page").show();
        $("#print-wrap").hide();
      };

      self.load_enrollments = function() {
        case_management.refresh_enrollments_table({{ case.id }}, "{{ url_for("cases.enrollment_records", case_id=case.id) }}",
                "#enrollment-records-table", "#enrollment-table-loading", {},
                function(table) {}
        );
      };

      self.format_enrollment_methods = ko.computed(function() {
        var display_map = {
          in_person: 'In Person',
          self_enroll_email: 'Self-Enroll by Email'
        };

        return _.map(self.enrollment_methods(), function(m) {return display_map[m]}).join(",");
      });

      self.format_enrollment_dates = ko.computed(function() {
        var start = self.enrollment_dates().start;
        var end = self.enrollment_dates().end;
        if (is_valid_date(end)) {
          return normalize_date(start) + " - " + normalize_date(end);
        } else {
          return "Open enrollment starting " + normalize_date(start);
        }
      });

      self.is_census_report = ko.computed(function() {
        return self.summary_data().is_census_report;
      });

      self.only_one_product = ko.computed(function() {
        return self.summary_data().only_one_product;
      });

      self.product_name = ko.computed(function() {
        return (self.only_one_product())? self.summary_data().product_names[0] : "";
      });

      self.format_total_percent_processed = ko.computed(function() {
        var percent = self.summary_data().processed_enrollments / self.summary_data().total_census * 100;
        return percent.toFixed(2) + "%";
      });

      self.format_total_num_census = ko.pureComputed(function() {
        return self.summary_data().total_census;
      });

      self.format_total_num_processed = ko.computed(function() {
        return self.summary_data().processed_enrollments;
      });

      self.format_total_percent_taken = ko.computed(function() {
        var percent = self.summary_data().taken_enrollments / self.summary_data().total_census * 100;
        return percent.toFixed(2) + "%";
      });

      self.format_total_num_taken = ko.computed(function() {
        return self.summary_data().taken_enrollments;
      });

      self.format_total_num_declined = ko.computed(function() {
        return self.summary_data().declined_enrollments;
      });

      self.format_total_percent_declined = ko.computed(function() {
        var percent = self.summary_data().declined_enrollments / self.summary_data().total_census * 100;
        return percent.toFixed(2) + "%";
      });

      self.format_total_annualized_premium = ko.computed(function() {
        return '$'+self.summary_data().total_annualized_premium;
      });

      self.format_case_agents = ko.computed(function() {
        return self.case_agents().join(", ");
      });

      params.settings_viewmodel.report_viewmodel(self);
    };

    /* END: CaseReportsViewModel */

    ko.components.register('case-report', {
      viewModel: {
        createViewModel: function(params, componentInfo) {
          return new CaseReportsViewModel(params);
        }
      },
      template: { element: 'case-report-template' }
    });

    /* CaseEnrollmentsViewModel */
    var CaseEnrollmentsViewModel = function(case_data) {
      var self = this;

      self.add_to_census_modal = new AddToCensusViewModel(case_data.id);
      ko.applyBindings(self.add_to_census_modal, $("#add-to-census-modal")[0]);
      $("#add-to-census-btn").on('click', function() {

        $("#add-to-census-modal").modal("show");
        self.add_to_census_modal.show_modal();
      });

      $("#enrollment").on('click', "button.enroll-employee", function() {
        var record_id = $(this).attr('data-id');

        submit_to_url("{{ url_for('in_person_enrollment') }}", {
          record_id: record_id,
          enrollment_city: window.case_settings.get_enrollment_city_override(),
          enrollment_state: window.case_settings.get_enrollment_state_override()
        });
      });
    };
    /* END: CaseEnrollmentsViewModel */

    /* EmployeeMatchViewModel */
    var EmployeeMatchViewModel = function(data) {
      var self = this;
      self.id = data.id;
      self.first = data.employee_first || "(No First Name)";
      self.last = data.employee_last || "(No Last Name)";
      self.ssn = data.employee_ssn;
      self.birthdate = data.employee_birthdate;

      self.formatted_birthdate = function() {
        return moment(self.birthdate, "YYYY-MM-DD").format("MM/DD/YYYY");
      };

      self.is_selected = ko.observable(false);
    };
    /* END: EmployeeMatchViewModel */


    /* AddToCensusViewModel */
    var AddToCensusViewModel = function(case_id) {
      var self = this;

      self.case_id = ko.observable(case_id);

      self.matched_employees = ko.observableArray([]);
      self.matched_employees.error = ko.observable("");
      self.selected_employee = ko.observable(null);

      self.matched_employee = ko.computed(function() {
        if (self.matched_employees().length == 0) {
          return null;
        }
        return self.matched_employees()[0];
      });

      self.loading_message = ko.observable("Loading...");

      self.ssn = ko.observable(null);
      self.ssn.error = ko.observable("");

      // Panel state
      self.PANEL_FORM = "find_employee";
      self.PANEL_LOADING = "loading";
      self.PANEL_NOMATCH = "no_matches";
      self.PANEL_ONEMATCH = "one_match";
      self.PANEL_MANYMATCHES = "matches";
      self.current_panel = ko.observable(self.PANEL_FORM);

      self.show_modal = function() {
        // Initialize the modal
        self.current_panel(self.PANEL_FORM);
        self.ssn("");
        self.ssn.error("");

        self.selected_employee(null);
      };

      self.is_match_form_showing = ko.computed(function() {
        return (self.current_panel() == self.PANEL_NOMATCH ||
        self.current_panel() == self.PANEL_MANYMATCHES ||
        self.current_panel() == self.PANEL_ONEMATCH);
      });
      self.add_form_showing = ko.computed(function() {
        return self.current_panel() == self.PANEL_FORM;
      });
      self.is_loading = ko.computed(function() {
        return self.current_panel() == self.PANEL_LOADING;
      });
      self.no_matches_found = ko.computed(function() {
        return self.current_panel() == self.PANEL_NOMATCH;
      });
      self.multiple_matches_found = ko.computed(function() {
        return self.current_panel() == self.PANEL_MANYMATCHES;
      });
      self.one_match_found = ko.computed(function() {
        return self.current_panel() == self.PANEL_ONEMATCH;
      });
      self.one_or_more_matches_found = ko.computed(function() {
        return self.multiple_matches_found() || self.one_match_found();
      });

      self.find_matches = function() {
        // Clear errors
        self.ssn.error("");

        if (!self.is_valid_ssn()) {
          self.ssn.error("A valid SSN is required");
          return;
        }

        // Submit search
        self.loading_message("Checking census for matches...");
        self.current_panel(self.PANEL_LOADING);
        $.get("/cases/" + self.case_id() + "/census_records",
                {filter_ssn: self.ssn()})
                .success(function(resp) {
                  if (resp.data.length > 0) {
                    // Load matches
                    self.matched_employees(_.map(resp.data, function(e) {return new EmployeeMatchViewModel(e)}));

                    // Display match panel
                    if (resp.data.length == 1) {
                      self.current_panel(self.PANEL_ONEMATCH);
                    } else {
                      self.current_panel(self.PANEL_MANYMATCHES);
                    }
                  } else {
                    // No matches
                    self.matched_employees([]);
                    self.current_panel(self.PANEL_NOMATCH);
                  }
                })
                .error(function(resp) {
                  console.error(resp);
                });
      };

      self.is_valid_ssn = ko.computed(function() {
        var ssn_regex = /^\d\d\d-\d\d-\d\d\d\d$/;
        return ssn_regex.test(self.ssn());
      });

      self.add_to_census = function() {
        self.loading_message("Adding employee to census...");
        self.current_panel(self.PANEL_LOADING);
        ajax_post("/cases/"+self.case_id()+"/census_records",
                {ssn: self.ssn()},
                function(resp) {
                  // Go to enrollment
                  self.enroll_from_record(resp.data.id);
                }, function(resp) {
                  bootbox.alert("There was a problem adding a record to the census");
                });
      };

      self.enroll_from_match = function() {
        if (self.matched_employees().length == 1) {
          self.enroll_from_record(self.matched_employees()[0].id);
        } else {
          // Use the selected record
          var id = self.selected_employee();
          if (id === null) {
            self.matched_employees.error("Please select the census record to enroll.");
            return;
          }
          self.enroll_from_record(id);
        }
      };

      self.enroll_from_record = function(id) {
        self.loading_message("Loading Enrollment Application...");
        self.current_panel(self.PANEL_LOADING);

        submit_to_url("{{ url_for('in_person_enrollment') }}", {
          record_id: id,
          enrollment_city: window.case_settings.get_enrollment_city_override(),
          enrollment_state: window.case_settings.get_enrollment_state_override()
        });
      }
    };
    /* END: AddToCensusViewModel */

    // Initialize settings viewmodel
    var settings = {
      default_email_message: "{{ default_email_message|replace('\n', '\\n')|safe }}",
      default_email_subject: "{{ default_email_subject|replace('\n', '\\n')|safe }}",
      all_states: {{ all_states | tojson | safe }},
      product_state_mapping: {{ product_state_mapping |tojson|safe }},
      payment_modes: {{ payment_modes | tojson | safe }}
    };
    window.case_settings = new CaseSettingsPanel(
            {{ case |tojson|safe }},
            {{ product_choices |tojson|safe }},
            {{ 'true' if can_edit_case else 'false'}},
            settings
    );
    ko.applyBindings(window.case_settings, $(".content")[0]);

    // Done setting up, set dirty to false again since applying the bindings sometimes triggers a change
    case_settings.is_data_dirty(false);

    function SendEmailsModalViewModel(case_settings_vm) {
      var self = this;
      self.case_settings_vm = case_settings_vm;

      self.numbers = {
        not_sent: ko.pureComputed(function() {
          return self.case_settings_vm.census_data().reduce(function addNotSent(acc, app) {
            return !app.sent_email ? acc+1 : acc;
          },0);
        }),
        not_applied: ko.pureComputed(function() {
          return self.case_settings_vm.census_data().reduce(function addNotApplied(acc, app) {
            return app.enrollment_status===null ? acc+1 : acc;
          },0);
        }),
        declined: ko.pureComputed(function() {
          return self.case_settings_vm.census_data().reduce(function addDeclined(acc, app) {
            return app.enrollment_status==='declined' ? acc+1 : acc;
          },0);
        })
      };

      self.send_type = ko.observable("");
      self.emailSettings = window.case_settings.emailSettings;

      self.num_emails_to_send = ko.pureComputed(function() {
        if (!self.send_type()) return 0;

        return self.numbers[self.send_type().replace("-", "_")]();
      });

      self.resetEmail = function() {
        self.emailSettings.message("{{ default_email_message|replace('\n', '\\n')|safe }}");
        self.emailSettings.subject("{{ default_email_subject|replace('\n', '\\n')|safe }}");
      };

      self.errors = ko.observableArray();

      self.send_emails = function() {

        self.errors([]);
        if(self.num_emails_to_send() == 0) {
          self.errors.push("There are no census records that match the selected criteria.");
          return false;
        }

        if(!confirm("You are about to send "+self.num_emails_to_send()+" emails. Are you sure?")) {
          return false;
        }

        if (window.case_settings.can_edit_case) {
          // Save the case (along with any changes the email) and then send emails.
          self.show_loading_panel();
          window.case_settings.save_settings(save_callback);
        } else {
          // Todo: send email settings overrides
          // Just send the emails.
          send_emails({});
        }

        function save_callback(promise) {
          promise.then(send_emails, handle_failed_save);
        }

        function handle_failed_save() {
          bootbox.alert("Sorry, there was a problem saving the case data before sending the emails. No emails were sent.");
        }

        function send_emails(data) {
          $.ajax({
            url: '{{ url_for('cases.email_self_enrollment_link', case_id=case.id, which="") }}' + self.send_type(),
            method: 'POST',
            dataType: 'json',
            success: function(results) {
              self.show_finished_panel();
              var sent_status_list = results.data;
              $('#email-target-links-modal #email-status-wrap').html(sent_status_list.join('<br>'));
            },
            error: function(xhr) {
              self.show_error_panel();
            }
          });
        }

      };

      self.show_form_panel = function() {
        $('#email-target-links-modal .success-buttons').hide();
        $('#email-target-links-modal .form-buttons').show();
        $('#email-target-links-modal .modal-panel').hide();
        $('#email-target-links-modal .form-panel').show();
      };
      self.show_loading_panel = function () {
        $('#email-target-links-modal .form-panel').hide();
        $('#email-target-links-modal .form-buttons').hide();
        $('#email-target-links-modal .loading-panel').show();
        $('#email-target-links-modal .processing-buttons').show();
      };
      self.show_finished_panel = function() {
        $('#email-target-links-modal .loading-panel').hide();
        $('#email-target-links-modal .success-panel').show();
        $('#email-target-links-modal .processing-buttons').hide();
        $('#email-target-links-modal .success-buttons').show();
        // Show the first panel when we click again
        $("#email-target-links-modal .success-buttons button").click(function() {
          self.show_form_panel();
        });
      };
      self.show_error_panel = function() {
        $('#email-target-links-modal .loading-panel').hide();
        $('#email-target-links-modal .form-buttons').hide();
        $('#email-target-links-modal .error-panel').show();
        $('#email-target-links-modal .error-buttons').show();
        $("#email-target-links-modal .error-buttons button:not(.back-btn)").click(function() {
          $('#email-target-links-modal .error-buttons').hide();
          $('#email-target-links-modal .processing-buttons').show();
          $('#email-target-links-modal .modal-panel').hide();
          $('#email-target-links-modal .form-panel').show();
        });
      };
    }

    window.modal_bindings = new SendEmailsModalViewModel(window.case_settings);
    ko.applyBindings(window.modal_bindings, $(".modals #email-target-links-modal")[0]);

    window.case_enrollment = new CaseEnrollmentsViewModel({{ case |tojson|safe }});

    $(".input-mask-date").mask("99/99/9999");
    $(".input-mask-month-day").mask("99/99");
    $('[data-rel=tooltip]').tooltip();


    $('#partner-agents').bootstrapDualListbox({
      infoTextFiltered: '<span class="label label-purple label-lg">Filtered</span>',
      showFilterInputs: true,
      moveOnSelect: false,
      nonSelectedListLabel: 'Available Agents:',
      selectedListLabel: 'Case Visible to Agents:'
    });

    // If we don't have a loctation hash, go to #setup
    if (window.location.hash == "") {
      window.location.hash = "setup";
    }


  });

  // Self-enrollment settings
  $(function() {
    // Show or hide landing page as necessary
    $('#self_enrollment_type').change(function() {
      if($('#self_enrollment_type option:selected').val() == 'case-generic') {
        $('.self-enroll-email').hide();
        $('.self-enroll-email-off').show();
      } else {
        $('.self-enroll-email').show();
        $('.self-enroll-email-off').hide();
      }
    }).change();

    // Buttons to reset tex
    $('#reset-page-text').click(function() {
      $('#page_text').html("{{ default_page_text|replace('\n', '\\n')|safe }}").focus();
    });

    // Set default values if applicable
    $.each(['#email_sender_name', '#email_sender_email', '#email_message',
      '#page_title', '#page_text'], function(index, value) {
      if($(value).prop('tagName') == 'DIV') {
        if($(value).html() == '') {
          $(value).html($(value).attr('default'));
        }
      } else {
        if($(value).val() == '') {
          $(value).val($(value).attr('default'));
        }
      }
    });

    // Show success message if required
    if(window.location.hash == '#success') {
      window.location.href = window.location.href.replace(/#.*$/, '#');
      $('#save-success').show();
    }

    $('#edit-self-enrollment-form').on('submit', function() {
      window.case_settings.save_settings();

      return false;
    });


    // Done setting up, set dirty to false again since applying the bindings sometimes triggers a change
    case_settings.is_data_dirty(false);
  });

</script>
{% endblock %}
