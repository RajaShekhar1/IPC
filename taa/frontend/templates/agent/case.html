{% extends "base_ace_1.3.1.html" %}
{% from "form_macros.html" import render_field_with_errors %}
{% from "form_macros.html" import render_switch %}
{% set active_page = 'nav_agent_manage_case' -%}
{% block title %} - Agent Manage Case{% endblock %}

{% block content %}
    
    <div class="row">
        <div class="col-md-12 case-setup-section">
            <form class="form-horizontal case_setup" data-bind="submit: save_settings">
                    
            <div class="widget-box">
                <div class="widget-header">
                    <div class="row">
                        <h3 class="col-xs-6" data-bind="text: company_name">{{ case.company_name }}</h3>
                        
                        <h3 class="col-md-3 col-md-offset-3 active-switch text-right">
                            <label style="margin-right: 15px;">
                                {{ case_setup_form.active(class_="ace ace-switch ace-switch-6", **{'data-bind': 'checked: is_active'})|safe }}
                                <span class="lbl padding-16"  data-bind="text: switch_label">Case is Active</span>    
                            </label>
                        </h3>
                    </div>
                  
                </div>
                <div class="widget-body">
                    <div class="widget-main">  
                        <div class="row">
                            <div class="col-md-5 col-xs-12">
                                <h3 class="header lighter blue">Settings</h3>
                                
                                    <div class="form-group">
                                        <label class="col-md-3 control-label" for="company_name">Company Name</label>
                                        <div class="col-md-8">
                                            {{ case_setup_form.company_name(**{
                                            'data-bind': "textInput: company_name, uniqueNameValidation: {remoteMethod: check_unique_name, uniqueObservable: company_name}",
                                            'minlength':'1',
                                            }) 
                                                }}
                                            
                                            <div class="row"> 
                                                <div class="col-md-12">
                                                    <div class="error" data-bind="visible: company_name.has_been_checked, text: get_form_error"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-1">
                                            <div class="icon-spinner text-warning bigger-125" data-bind="visible: company_name.is_checking"></div>
                                            <div class="icon icon-check-sign green bigger-125" data-bind="visible: company_name.is_unique() && !company_name.is_checking()"></div>
                                        </div>
                                    </div>
                                    
                                
                                {{ render_field_with_errors(case_setup_form.products, **{'data-bind': 'options: product_choices, optionsValue: "id", optionsText: "name", selectedOptions: products, multiSelect: {
                                    observed: products, 
                                    options: {nonSelectedText: "No Products Selected", numberDisplayed: 1}
                                }'}) }}
                                
                            
                                {# Situs state 
                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="case_state">State</label>
                                    <div class="col-md-9">
                                        <select id="case_state" name="situs_state" class="form-control">
                                            <option></option>
                                            {% for state in all_states %}
                                                <option value="{{state.shortname}}" 
                                                    {%- if case_state == state.shortname -%}
                                                    selected="1"
                                                    {%- endif -%}
                                                    >{{state["name"]}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                #}
                                {{ render_field_with_errors(case_setup_form.situs_city, **{'data-bind':'value: situs_city'}) }}
                                {{ render_field_with_errors(case_setup_form.situs_state, id="case_state", **{'data-bind':'value: situs_state'}) }}
                                
                            </div>
                            <div class="enrollment-section col-md-5 col-md-offset-1 col-xs-12">
                                <h3 class="header lighter blue">Enrollment Periods</h3>
                                <div id="accordian">
                                {% for value, label, selected in enrollment_period_form.enrollment_period_type.iter_choices() %}
                                    <div class="panel">
                                    <div class="form-group panel-heading">
                                        <label data-toggle="collapse" data-parent="#accordian" data-target="#collapse-{{ value }}">
                                            <input type="radio" class="ace" name="enrollment_period_type" value="{{ value }}" {% if selected %}checked="1"{% endif %}> 
                                            <span class="lbl">{{ label }}</span>
                                        </label>
                                    </div>
                                    <div id="collapse-{{ value }}" class="form-group collapse collapse-panel {% if selected %}in{% endif %}" >
                                    
                                        {% if value == "open" %}
                                            {{ enrollment_period_form.open_period_start_date.label }}
                                            {{ enrollment_period_form.open_period_start_date(class_="input-mask-date", placeholder="MM/DD/YYYY") }}
                                        {% else %}
                                            
                                            {% for date_form in enrollment_period_form.annual_period_dates %}
                                                <div class="form-group row">
                                                    {% for field in date_form %}
                                                        {% if field.type != "CSRFTokenField" %}
                                                            <div class="col-md-6">
                                                            {{ field.label }}
                                                            {{ field(class_="input-mask-month-day", placeholder="MM/DD") }}
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                
                                            {% endfor %}
                                        {% endif %}
                                        
                                    </div>
                                    </div>
                                {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="widget-toolbox clearfix padding-8">
                        <div class="flash-message submit-message" data-bind="flashMessage: flash_message"></div>
                        <button type="submit" class="btn-primary btn-sm pull-right" data-bind="
                        {# enable: has_unsaved_data,  #}
                        css: {'btn-primary': has_unsaved_data, 'btn-default': !has_unsaved_data()}
                        ">Save</button>
                    </div>
                </div>
            </div>
                
            </form> 
            
            
        </div>
    </div>
    
    <br>
    <div class="hr"></div>
    <br>
    
    <div class="row">
        <div class="col-xs-12">
            <div class="widget-box">
                <div class="widget-header">
                    <div class="row">
                        <div class="col-md-6"><h4 class="bigger-150">Case Census</h4></div>
                        <div class="col-md-6">
                            <a href="{{ url_for('cases.census_records', case_id=case.id) }}?format=csv" target="_blank" id="export-btn" class="btn btn-default pull-right">
                                <i class="icon icon-download-alt"></i>
                                    Download Census
                            </a>
                            <button type="button" id="upload-btn" class="btn btn-success pull-right" data-toggle="modal" data-target="#census-upload-modal" >
                                <i class="icon icon-upload"></i>
                                    Upload Census
                            </button>
                        </div>
                    </div>
                    
                    
                    
                </div>
                <div class="widget-body">
                    <div class="widget-main">  
                        {% if not census_records %}
                            <h4 class="no-census-header text-center lighter">No Census Data Uploaded</h4>
                            <table id="census-records-table" class="table table-bordered table-hover" style="display: none;">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>SSN</th>
                                        <th>First</th>
                                        <th>Last</th>
                                        <th>Email</th>
                                        <th>Spouse First</th>
                                        <th>Spouse Last</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        {% else %}
                            <table id="census-records-table" class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>SSN</th>
                                        <th>First</th>
                                        <th>Last</th>
                                        <th>Email</th>
                                        <th>Spouse First</th>
                                        <th>Spouse Last</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# 
                                    Don't load this on the page anymore, 
                                    we load from the server at run time for page speed
                                    #}
                                </tbody>
                            </table>
                        {% endif %}
                        <div id="census-table-loading" class="text-center bigger-125"></div>
                    </div>
                </div>
            </div>
        </div>
                
    </div>
    
    {# Upload census data modal #}
    <form id="census-record-form" method="POST" enctype="multipart/form-data">
    <div id="census-upload-modal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span
                        aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Upload Census Data</h4>
                </div>
                <div class="modal-body">
                    <div class="form-panel modal-panel">
                        <div class="row">
                            <div class="col-xs-12 ">
                                <h4>
                                    Select Census CSV File: 
                                </h4>
                                <p class="offset-by-twelve">Download an <a href="{{ url_for("sample_upload_csv") }}">example census data file</a> for formatting reference.</p>
                                <input type="file" id="csv-file-input" name="csv-file" accept="text/csv,.csv">
                            </div>
                        </div>
                        
                        <br>
                        
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label>
                                        <input type="radio" class="ace" name="upload_type" value="merge-skip" checked="1">
                                        <span class="lbl"> Add New Records</span>
                                    </label>
                                    <div class="row">
                                        <p class="col-xs-10 col-xs-offset-1">
                                            This option adds new records to any existing employee records without updating any existing data.
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="radio" class="ace" name="upload_type" value="merge-replace">
                                        <span class="lbl"> Add With Update</span>
                                    </label>
                                    <div class="row">
                                        <p class="col-xs-10 col-xs-offset-1">
                                            This option adds new records to any existing employee records and also updates existing records whose SSN match the uploaded data.
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="radio" class="ace" name="upload_type" value="replace">
                                        <span class="lbl"> Replace Existing Census</span>
                                    </label>
                                    <div class="row">
                                        <p class="col-xs-10 col-xs-offset-1">
                                            This option first removes all existing employee records in this case, then adds the new uploaded data.
                                        </p>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    <div class="loading-panel modal-panel" style="display: none;">
                        <div class="text-center">
                            <h4>Uploading and processing...</h4>
                            <i class="icon-spinner icon-spin grey bigger-200"></i>  
                        </div>
                    </div>
                    <div class="success-panel modal-panel" style="display: none;">
                        <h3 class="header lighter green">File Processed Successfully</h3>
                        <!--ko if: num_data_records() > 0 -->
                            <h4><span data-bind="text: num_data_records"></span> 
                                record<span data-bind="visible: num_data_records() > 1">s</span> 
                                added or updated.</h4>
                        <!--/ko-->
                        <!--ko if: num_data_records() == 0 -->
                            <h4>No new data was added to the census.</h4>
                        <!--/ko-->
                    </div>
                    <div class="error-panel modal-panel" style="display: none;">
                        <h3 class="header lighter red">Bad or Missing Data</h3>
                        
                        <div class="row">
                            <div class="col-md-12" style="width: 100%; overflow: auto;">
                                <!--ko foreach: {data: error_records, as: 'error_record'}-->
                                    <div data-bind="if: error_record.message && error_record.records.length == 0">
                                        <div class="error" data-bind="text: error_record.message"></div>
                                    </div>
                                    
                                    <table data-bind="if: error_record.records.length > 0" class="table table-bordered table-responsive upload-error-table">
                                        <thead>
                                            <tr>
                                                <th>Record #</th>
                                                <!--ko foreach: error_record.headers-->
                                                    <th data-bind="text: $data"></th>
                                                <!--/ko-->
                                            </tr>
                                        </thead>
                                        <tbody data-bind="foreach: {data: error_record.records, as: 'data_record'}">
                                            <tr>
                                                <td data-bind="text: error_record.line_number"></td>
                                            <!--ko foreach: {data: error_record.headers, as: 'header'} -->
                                                <td data-bind="css: {error: error_record.field_name == header}, attr: {title: error_record.message}" 
                                                    data-toggle="tooltip">
                                                    <div data-bind="text: data_record[header]"></div>
                                                </td>
                                            <!--/ko-->
                                            </tr>
                                        </tbody>
                                    </table>
                                <!--/ko-->
                            </div>
                        </div>
                    </div>
                </div>
                    
                <div class="modal-footer">
                    <div class="form-buttons buttons-panel">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                    <div class="processing-buttons buttons-panel" style="display: none;">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                    <div class="error-buttons buttons-panel" style="display: none;">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary back-btn">
                            <i class="glyphicon glyphicon-chevron-left"></i> Back</button>
                    </div>
                    <div class="success-buttons buttons-panel" style="display: none;">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Done</button>
                    </div>
                    
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    </form>
{% endblock %}

{% block page_js %}
    <script src="{{ url_for("static", filename="js/5Star/product_state_select.js") }}"></script>
    <script>
    
    function add_case_error(errors, field_name, message) {
        if (field_name in errors) {
            errors[field_name].push(message);
        } else {
            errors[field_name] = [message];
        }
    }
    
    function get_form_data(form) {
        // Returns the form data as a javascript object. 
        var data = $(form).serializeArray();
        var data_object = {};
        $.each(data, function() {
            var key = this.name;
            var val = this.value;
            if (key in data_object && data_object.length === undefined) {
                // Convert multi-selects to a list (key present more than once)
                data_object[key] = [data_object[key]];
                data_object[key].push(val);
            } else if (key in data_object) { 
                data_object[key].push(val);
            } else {
                data_object[key] = val;
            }
        });
        return data_object;
    }
    
    $(function() {
        // Load data now
        case_management.refresh_census_table({{ case.id }}, "{{ url_for("cases.census_records", case_id=case.id) }}", 
            "#census-records-table", "#census-table-loading");
        
        // Change enabled states when the product is changed
        product_state_select.init("#case_state","#case_product", {{ product_states | tojson | safe }});
        
        $('#csv-file-input').ace_file_input({
            no_file:'No File ...',
            btn_choose:'Choose File',
            btn_change:'Change File',
            droppable:false,
            onchange:null,
            thumbnail:false,
            whitelist:'csv'
        });
        
        $("#census-record-form").on("submit", function() {
            
            var form = this;
            var file_select = $(this).find("input[type=file]").get(0);
            var files = file_select.files;
            var form_data = new FormData();
            if (files.length !== 1) {
                alert("Please select a file");
                return false;
            } 
            
            // Add the file upload to the request.
            form_data.append('csv-file', files[0], files[0].name);
            form_data.append('upload_type', $("input[name=upload_type]:checked").val());    
            
            send_file_data("POST", "{{ url_for("cases.post_census_records", case_id=case.id) }}", 
                form_data, function(resp) {
                    census_errors_panel.error_records(resp.data.errors);
                    census_errors_panel.num_data_records(resp.data.records.length);
                    show_success_panel();
                    // Update the datatable
                    case_management.refresh_census_table({{ case.id }},"{{ url_for("cases.census_records", case_id=case.id) }}", 
                                                         "#census-records-table", "#census-table-loading");
                }, function(xhr) {
                    if (xhr.status >= 400 && xhr.status < 500) {
                        show_error_panel();
                        var data = $.parseJSON(xhr.responseText).data;
                        census_errors_panel.error_records(data.errors);
                        
                        // Show error tooltips
                        $('.upload-error-table td.error').tooltip({placement: "auto left"});
                    } else {
                        alert("Sorry, there was a problem communicating with the server.");
                        reset_upload_modal();
                    }
                }, false);
            
            show_loading_panel();
            
            return false;
        });
        function show_loading_panel() {
            $(".form-panel").hide("slide");
            $(".loading-panel").show("slide");
            $(".processing-buttons").show("fade");
            $(".form-buttons").hide("fade");
        }
        function show_error_panel() {
            $(".loading-panel").hide("slide");
            $(".error-panel").show("slide");
            $(".error-buttons").show("fade");
            $(".processing-buttons").hide("fade");
        }
        function show_success_panel() {
            $(".loading-panel").hide("slide");
            $(".success-panel").show("slide");
            $(".success-buttons").show("fade");
            $(".processing-buttons").hide("fade");
        }
        function show_form_panel() {
            $(".modal-panel").hide("slide");
            $(".buttons-panel").hide("slide");
            $(".form-panel").show("slide");
            $(".form-buttons").show("slide");
        }
        
        function reset_upload_modal() {
            $(".modal-panel").hide();
            $(".buttons-panel").hide();
            $(".form-panel").show();
            $(".form-buttons").show();
        }
        $("#upload-btn").on("click", reset_upload_modal);
        $(".back-btn").on("click", show_form_panel);
        
        var CensusErrorsPanel = function() {
            var self = this;
            
            self.error_records = ko.observableArray([]);
            self.num_data_records = ko.observable(0);
        };
        window.census_errors_panel = new CensusErrorsPanel();
        ko.applyBindings(census_errors_panel, $("#census-upload-modal")[0]);
        
        var CaseSettingsPanel = function(case_data, product_choices) {
            var self = this;
            
            self.company_name = ko.observable(case_data.company_name || "").extend({ rateLimit: 1000 });
            self.product_choices = product_choices;
            self.products = ko.observableArray($.map(case_data.products, function(p) {return p.id}));
            self.enrollment_period_type = ko.observable(case_data.enrollment_period_type);
            self.enrollment_periods = ko.observable(case_data.enrollment_periods);
            self.situs_city = ko.observable(case_data.situs_city);
            self.situs_state = ko.observable(case_data.situs_state);
            self.is_active = ko.observable(case_data.active);
            
            // enrollment data
            //self.open_period_start_date = ko.observable();
            
            self.is_data_dirty = ko.observable();
            self.flash_message = ko.observable("");
            
            // subscribe to all changes to detect data changes
            $.each([self.company_name, self.products, self.enrollment_period_type, 
                    self.enrollment_periods, self.situs_city, self.situs_state, 
                    self.is_active], function() {
                this.subscribe(function() {
                    self.is_data_dirty(true); 
                });
            });
            
            self.can_activate_case = ko.computed(function() {
                 return (
                     self.enrollment_period_type != null && 
                     self.enrollment_periods().length > 0 &&
                     self.products().length > 0 && $.trim(self.company_name) != "" && 
                     $.trim(self.situs_city) != "" && 
                     $.trim(self.situs_state) != ""
                 )
            });
            
            self.is_active.subscribe(function(value) {
                
                if (value && !self.can_activate_case()) {
                    alert("You can't activate this case until xyz are done");
                    console.log("You can't activate this case until xyz are done");
                    self.is_active(false);
                }
            });
            
            
            self.switch_label = ko.computed(function() {
                if (self.is_active()) {
                    return "Case is Active";
                } else {
                    return "Case is Not Active";
                }
            });
            
            self.get_form_error = ko.computed(function() {
                if ($.trim(self.company_name()) == "") {
                    return "Company name is required.";
                } else if (self.company_name.is_unique !== undefined && 
                           !self.company_name.is_unique()) {
                    return "The name '"+self.company_name()+"' is already used."
                }
                return "";
            });
            
            self.check_unique_name = function(current_value, callback) {
                $.get("{{ url_for("cases.get_cases") }}", {by_name: current_value}, function(result) {
                    var is_unique = (result.data.length == 0 || current_value == case_data.company_name);
                    callback(is_unique);
                }, "json");
            
            };
            
            self.validate = function() {
                
                hide_all_errors();
                
                // unique name error
                var form_error = self.get_form_error();
                if (form_error) {
                    return false;
                }
                
                // all other errors
                var errors = {}; 
                if ($.trim(self.company_name()) == "") {
                    add_case_error(errors, "company_name", "Required");
                }
                
                if (Object.keys(errors).length > 0) {
                    show_all_errors(errors);
                    return false;
                }
                
            };
            
            self.serialize_case = function() {
                var products = [];
                $.each(self.product_choices, function() {
                     if (self.products.indexOf(this.id) >= 0) {
                         products.push(this);
                     }
                });
                return {
                    company_name: self.company_name(),
                    active: self.is_active(),
                    products:  products,
                    enrollment_period_type: self.enrollment_period_type(),
                    situs_city: self.situs_city(),
                    situs_state: self.situs_state()
                }  
            };
            
            self.save_settings = function() {
                var form_data = get_form_data($(".case-setup-section form")[0]);
                //form_data.active = self.is_active();
                
                self.validate();
                
                var case_request = send_json_data(
                    "PUT", 
                    "{{ url_for("cases.update_case", case_id=case.id) }}",
                    self.serialize_case()
                );
                
                //var period_form_data = $("form.period_setup").serialize();
                var periods_request = send_form_data(
                    "PUT", 
                    "{{ url_for("cases.update_case_enrollment_periods", case_id=case.id) }}",
                    form_data
                );
                var on_success = function(case_xhr, periods_xhr) {
                    self.is_data_dirty(false);
                    self.flash_message("Data Saved");
                };
                var on_failure = function(failed_xhr) {
                    var errors = failed_xhr.responseJSON.errors || [];
                    show_all_errors(errors);
                };
                $.when(case_request, periods_request).then(on_success, on_failure);
                
                return false; 
            };
            
            $(window).bind("beforeunload", function() { 
                return self.has_unsaved_data() ? "You have made changes without saving. Do you you wish to leave this page and lose all changes?" : undefined; 
            });
            
            self.has_unsaved_data = ko.computed(function() {
                return self.is_data_dirty();  
            });
        };
        window.case_settings = new CaseSettingsPanel({{ case |tojson|safe }}, {{ product_choices |tojson|safe }});
        
        ko.applyBindings(window.case_settings, $(".case-setup-section")[0]);
        
        $(".input-mask-month-day").mask("99/99");
       
        $('.panel-heading label').on('click', function(e) {
            if($(this).parents('.panel').children('.collapse-panel').hasClass('in')){
                e.preventDefault();
                e.stopPropagation();
            }
        });
        
        
        
    });
    </script>
{% endblock %}