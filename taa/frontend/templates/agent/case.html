{% extends "base.html" %}
{% from "form_macros.html" import render_field_with_errors %}
{% from "form_macros.html" import render_checkbox %}
{% set active_page = 'nav_agent_manage_case' -%}
{% block title %} - Agent Manage Case{% endblock %}

{% block content %}
    
    
    <h1 class="header lighter">Case Settings</h1>
    
    <div class="row">
        <div class="col-xs-12 col-md-6">
            <form class="form-horizontal case_setup">
                    
            <div class="widget-box">
                <div class="widget-header">
                    <h3>Basic Setup</h3>
                </div>
                <div class="widget-body">
                    <div class="widget-main">  
                        
                        {{ render_field_with_errors(case_setup_form.company_name) }}
                        
                        {# {{ render_field_with_errors(case_setup_form.products) }}  #}
                        {# Use the single-select product form for now #}
                        <div class="form-group">
                            <label class="col-md-3 control-label" for="case_product">Product</label>
                            <div class="col-md-9">
                                <select id="case_product" name="case_product" class="form-control">
                                    <option></option>
                                    {% for product in product_choices %}
                                        <option value="{{product['short_name']}}" 
                                        {%- if product["disabled"] -%}
                                        disabled="1"
                                        {%- endif -%}
                                        {%- if case_product and case_product.code == product.short_name -%}
                                        selected="1"
                                        {%- endif -%}
                                        >{{product["name"]}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    
                        {# Situs state 
                        <div class="form-group">
                            <label class="col-md-3 control-label" for="case_state">State</label>
                            <div class="col-md-9">
                                <select id="case_state" name="situs_state" class="form-control">
                                    <option></option>
                                    {% for state in all_states %}
                                        <option value="{{state.shortname}}" 
                                            {%- if case_state == state.shortname -%}
                                            selected="1"
                                            {%- endif -%}
                                            >{{state["name"]}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        #}
                        {{ render_field_with_errors(case_setup_form.situs_state, id="case_state") }}
                        
                        {{ render_checkbox(case_setup_form.active) }}
                                
                    </div>
                    <div class="widget-toolbox clearfix padding-8">
                        <button type="submit" class="btn-primary btn-sm pull-right">Save</button>
                    </div>
                </div>
            </div>
                
            </form> 
        </div>
    
        <div class="col-xs-12 col-md-6">
            <form class="form-horizontal period_setup">
            <div class="widget-box enrollment-periods">
                <div class="widget-header">
                    <h3>Enrollment Periods</h3>
                </div>
                <div class="widget-body">
                    <div class="widget-main"> 
                        <div id="accordian">
                        {% for value, label, selected in enrollment_period_form.enrollment_period_type.iter_choices() %}
                            <div class="panel">
                            <div class="form-group panel-heading">
                                <label data-toggle="collapse" data-parent="#accordian" data-target="#collapse-{{ value }}">
                                    <input type="radio" class="ace" name="enrollment_period_type" value="{{ value }}" {% if selected %}checked="1"{% endif %}> 
                                    <span class="lbl">{{ label }}</span>
                                </label>
                            </div>
                            <div id="collapse-{{ value }}" class="form-group collapse collapse-panel {% if selected %}in{% endif %}" >
                            
                                {% if value == "open" %}
                                    {{ enrollment_period_form.open_period_start_date.label }}
                                    {{ enrollment_period_form.open_period_start_date(class_="input-mask-date", placeholder="MM/DD/YYYY") }}
                                {% else %}
                                    
                                    {% for date_form in enrollment_period_form.annual_period_dates %}
                                        <div class="form-group row">
                                            {% for field in date_form %}
                                                {% if field.type != "CSRFTokenField" %}
                                                    <div class="col-md-6">
                                                    {{ field.label }}
                                                    {{ field(class_="input-mask-month-day", placeholder="MM/DD") }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        
                                    {% endfor %}
                                {% endif %}
                                
                            </div>
                            </div>
                        {% endfor %}
                        </div>
                        
                    </div>
                    <div class="widget-toolbox clearfix padding-8">
                        <button type="submit" class="btn-primary btn-sm pull-right">Save</button>
                    </div>
                    
                </div>
            </div>
            </form> 
                
        </div>
    
        
    
    
    </div>
    
    <br>
    <div class="hr"></div>
    <br>
    
    <div class="row">
        <div class="col-xs-12">
            <div class="widget-box">
                <div class="widget-header">
                    <h3>Case Census</h3>
                    <button type="button" id="upload-btn" class="btn btn-success pull-right" data-toggle="modal" data-target="#census-upload-modal">Upload Census</button>
                </div>
                <div class="widget-body">
                    <div class="widget-main">  
                        {% if not census_records %}
                            <h4 class="text-center lighter">No Census Data Uploaded</h4>
                        {% else %}
                            <table id="census-records-table" class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>First</th>
                                        <th>Last</th>
                                        <th>Email</th>
                                        <th>Spouse First</th>
                                        <th>Spouse Last</th>
                                        <th>Completed Enrollment</th>
                                        <th>Elected Coverage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in census_records %}
                                    <tr>
                                        <td class="text-center"><a href="{{ url_for("edit_census_record", case_id=case.id, census_record_id=record.id) }}"><span class="glyphicon glyphicon-edit"></span></a></td>
                                        <td>{{ record.first }}</td>
                                        <td>{{ record.last }}</td>
                                        <td>{{ record.email }}</td>
                                        <td>{{ record.sp_first }}</td>
                                        <td>{{ record.sp_last }}</td>
                                        
                                        <td>{{ record.completed_enrollment }}</td>
                                        <td>{{ record.elected_coverage }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
                
    </div>
    
    {# Upload census data modal #}
    <form id="census-record-form" method="POST" enctype="multipart/form-data" action="{{ url_for("upload_census_record", case_id=case.id) }}">
    <div id="census-upload-modal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span
                        aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Upload Census Data</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-12 ">
                            <h4>
                                Select Census CSV File: 
                            </h4>
                            <p class="offset-by-twelve">Download an <a href="#">example census data file</a> for formatting reference.</p>
                            <input type="file" id="csv-file-input" name="csv-file">
                        </div>
                    </div>
                    
                    <br>
                    
                    <div class="row">
                        <div class="col-xs-12">
                            
                            <div class="form-group">
                                <label>
                                    <input type="radio" class="ace" name="upload_type" value="merge" checked>
                                    <span class="lbl"> Merge with Existing Census</span>
                                </label>
                                <div class="row">
                                    <p class="col-xs-10 col-xs-offset-1">
                                        This option adds new records to any existing employee records, and updates the information for records whose SSN match.
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="radio" class="ace" name="upload_type" value="replace">
                                    <span class="lbl"> Replace Existing Census</span>
                                </label>
                                <div class="row">
                                    <p class="col-xs-10 col-xs-offset-1">
                                        This option first removes any existing employee records, then replaces them with the new data.
                                    </p>
                                </div>
                            </div>
                            
                            
                        </div>
                    </div>
                    
                </div>
                    
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    </form>
{% endblock %}

{% block page_js %}
    <script src="{{ url_for("static", filename="js/5Star/product_state_select.js") }}"></script>
    <script>
    $(function() {
        $("#census-records-table").dataTable({
            "aoColumnDefs":[
                {"bSortable": false, "aTargets":[0]},
            ],
            "aaSorting": [[ 2, "asc" ]],
            "iDisplayLength": 25
        });
        
        // Change enabled states when the product is changed
        product_state_select.init("#case_state","#case_product", {{ product_states | tojson | safe }});
        
        $("form.case_setup").on('submit', function() {
            var form_data = $(this).serialize();
            send_form_data("PUT", "{{ url_for("cases.update_case", case_id=case.id) }}",
                form_data, function() {
                    alert("Saved");
                }, function() {
                    alert("There was a problem saving the data.");
                }
            );
            
            return false; 
        });
        
        $("form.period_setup").on('submit', function() {
            var form_data = $(this).serialize();
            
            send_form_data("PUT", "{{ url_for("cases.update_case_enrollment_periods", case_id=case.id) }}",
                form_data, function() {
                    alert("Saved");
                }, function() {
                    alert("There was a problem saving the data.");
                }
            );
            
            return false; 
        });
        
        $('#csv-file-input').ace_file_input({
            no_file:'No File ...',
            btn_choose:'Choose File',
            btn_change:'Change File',
            droppable:false,
            onchange:null,
            thumbnail:false,
            whitelist:'csv'
        });
        
        $("#census-record-form").on("submit", function() {
            console.log("here");
            return true;
        });
        
        $(".input-mask-month-day").mask("99/99");
       
        $('.panel-heading label').on('click', function(e) {
            if($(this).parents('.panel').children('.collapse-panel').hasClass('in')){
                e.preventDefault();
                e.stopPropagation();
            }
        });
        
    });
    </script>
{% endblock %}